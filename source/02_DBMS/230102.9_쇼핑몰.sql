DROP TABLE ORDERSDETAIL;
DROP TABLE ORDERS;
DROP TABLE CART;
DROP TABLE PRODUCT;
DROP TABLE MEMBER;

--멤버 테이블 생성, 멤버입력
CREATE TABLE MEMBER(
    MID VARCHAR2(20) PRIMARY KEY, --PK아이디
    MPW VARCHAR2(20) NOT NULL,
    MNAME VARCHAR2(20) NOT NULL,
    MADD VARCHAR2(100),
    MTEL VARCHAR2(20),
    MEMAIL VARCHAR2(50) NOT NULL
);
SELECT * FROM MEMBER;
INSERT INTO MEMBER(MID,MPW,MNAME,MADD,MTEL,MEMAIL) VALUES
    ('abc','abc','홍길동','서울시 서대문구 대현동','010-9999-9999','홍길동이메일');
INSERT INTO MEMBER(MID,MPW,MNAME,MADD,MTEL,MEMAIL) VALUES
    ('def','def','김김동','경기도 수원시','010-8888-88888','김김동이메일');

-- 상품 테이블 생성, 상품 입력
CREATE TABLE PRODUCT(
    PCODE VARCHAR2(10) PRIMARY KEY, --PK상품코드
    PNAME VARCHAR2(50) UNIQUE NOT NULL,
    PRICE NUMBER(9,2) CHECK(PRICE>0) NOT NULL,
    STOCK NUMBER(7) CHECK(STOCK>=0) NOT NULL
);
SELECT * FROM PRODUCT;
INSERT INTO PRODUCT(PCODE,PNAME,PRICE,STOCK) VALUES
    ('A1','맥주',3000,30);
INSERT INTO PRODUCT(PCODE,PNAME,PRICE,STOCK) VALUES
    ('B1','땅콩',3000,30);
INSERT INTO PRODUCT(PCODE,PNAME,PRICE,STOCK) VALUES
    ('A2','마스크',200,20);
INSERT INTO PRODUCT(PCODE,PNAME,PRICE,STOCK) VALUES
    ('B2','오징어',5000,50);
INSERT INTO PRODUCT(PCODE,PNAME,PRICE,STOCK) VALUES
    ('C1','소독약',7000,10);

-- 시퀀스 생성, 카트,주문,주문상세 테이블 생성 
DROP SEQUENCE CARTSEQ;
CREATE SEQUENCE CARTSEQ
    MAXVALUE 9999
    NOCACHE;   
DROP SEQUENCE OSEQ;
CREATE SEQUENCE OSEQ
    MAXVALUE 9999
    NOCACHE;   
DROP SEQUENCE ODSEQ;
CREATE SEQUENCE ODSEQ
    MAXVALUE 9999
    NOCACHE;   

CREATE TABLE CART(
    CARTNO NUMBER(4) PRIMARY KEY, --시퀀스
    MID VARCHAR2(20) NOT NULL,
    PCODE VARCHAR2(10) NOT NULL,
    QTY NUMBER(3) CHECK(QTY>0) NOT NULL,
    COST NUMBER(10) NOT NULL,
    FOREIGN KEY(MID) REFERENCES MEMBER(MID),
    FOREIGN KEY(PCODE) REFERENCES PRODUCT(PCODE)
);
CREATE TABLE ORDERS(
    ONO VARCHAR2(20) PRIMARY KEY, --주문날짜+시퀀스
    ODATE DATE DEFAULT SYSDATE,
    MID VARCHAR2(20) NOT NULL,
    ONAME VARCHAR2(20) NOT NULL,
    OADD VARCHAR2(100) NOT NULL,
    OTEL VARCHAR2(20) NOT NULL,
    FOREIGN KEY(MID) REFERENCES MEMBER(MID)
);
CREATE TABLE ORDERSDETAIL(
    ODNO NUMBER(4) PRIMARY KEY, --시퀀스
    ONO VARCHAR2(20) NOT NULL,
    PCODE VARCHAR2(10) NOT NULL,
    QTY NUMBER(3) CHECK(QTY>0) NOT NULL,
    COST NUMBER(10) NOT NULL,
    FOREIGN KEY(ONO) REFERENCES ORDERS(ONO),
    FOREIGN KEY(PCODE) REFERENCES PRODUCT(PCODE)
);

--카트에 담기
INSERT INTO CART(CARTNO,MID,PCODE,QTY,COST) VALUES 
    (CARTSEQ.NEXTVAL,'abc','A1',3,3*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A1'));
INSERT INTO CART(CARTNO,MID,PCODE,QTY,COST) VALUES 
    (CARTSEQ.NEXTVAL,'abc','B1',1,1*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'B1'));
SELECT * FROM CART;

-- 주문하기
    -- 1. 주문테이블 입력, 주문 상세 테이블 입력
INSERT INTO ORDERS(ONO,MID,ONAME,OADD,OTEL) VALUES(
    CONCAT(TO_CHAR(SYSDATE,'RRMMDD'),LPAD(OSEQ.NEXTVAL,3,'0')),   -- LPAD 사용
    'abc','홍길동','서울시 서대문구 대현동','010-9999-9999'
    );
    
INSERT INTO ORDERS(ONO,MID,ONAME,OADD,OTEL) VALUES(
    TO_CHAR(SYSDATE,'RRMMDD') || TRIM(TO_CHAR(OSEQ.NEXTVAL,'000')), -- TO_CHAR 사용시 빈칸생겨서 TRIM 사용
    'abc','홍길동','서울시 서대문구 대현동','010-9999-9999'
    );

SELECT * FROM ORDERS;

INSERT INTO ORDERSDETAIL(ODNO,ONO,PCODE,QTY,COST) VALUES
    (ODSEQ.NEXTVAL,
        CONCAT(TO_CHAR(SYSDATE,'RRMMDD'),LPAD(OSEQ.CURRVAL,3,'0')),
        'A1',3,3*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A1'));
        
INSERT INTO ORDERSDETAIL(ODNO,ONO,PCODE,QTY,COST) VALUES
    (ODSEQ.NEXTVAL,
        TO_CHAR(SYSDATE,'RRMMDD') || TRIM(TO_CHAR(OSEQ.CURRVAL,'000')),
        'B1',1,1*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'B1'));
    
SELECT * FROM ORDERSDETAIL;

    -- 2. 상품테이블 재고수량 업데이트
UPDATE PRODUCT SET STOCK = STOCK - 3 WHERE PCODE = 'A1';
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE PCODE = 'B1';
SELECT * FROM PRODUCT;

    -- 3. 카트테이블 비우기(주문한 상품만)
DELETE FROM CART WHERE PCODE = 'A1' AND MID = 'abc';
DELETE FROM CART WHERE PCODE = 'B1' AND MID = 'abc';
SELECT * FROM CART;

-- 한명 더 해보기
--카트에 담기
INSERT INTO CART(CARTNO,MID,PCODE,QTY,COST) VALUES 
    (CARTSEQ.NEXTVAL,'def','A2',20,20*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A2'));
INSERT INTO CART(CARTNO,MID,PCODE,QTY,COST) VALUES 
    (CARTSEQ.NEXTVAL,'def','B2',2,2*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'B2'));
INSERT INTO CART(CARTNO,MID,PCODE,QTY,COST) VALUES 
    (CARTSEQ.NEXTVAL,'def','C1',1,1*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'C1'));  
SELECT * FROM CART;

-- 주문하기
    -- 1. 주문테이블 입력, 주문 상세 테이블 입력
INSERT INTO ORDERS(ONO,MID,ONAME,OADD,OTEL) VALUES(
    CONCAT(TO_CHAR(SYSDATE,'RRMMDD'),LPAD(OSEQ.NEXTVAL,3,'0')),
    'def','김김동','경기도 수원시','010-8888-8888'
    );
    
SELECT * FROM ORDERS;

INSERT INTO ORDERSDETAIL(ODNO,ONO,PCODE,QTY,COST) VALUES(
    ODSEQ.NEXTVAL,
    CONCAT(TO_CHAR(SYSDATE,'RRMMDD'),LPAD(OSEQ.CURRVAL,3,'0')),
    'A2',20,20*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A2')
    );
    
INSERT INTO ORDERSDETAIL(ODNO,ONO,PCODE,QTY,COST) VALUES(
    ODSEQ.NEXTVAL,
    CONCAT(TO_CHAR(SYSDATE,'RRMMDD'),LPAD(OSEQ.CURRVAL,3,'0')),
    'B2',2,2*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'B2')
    );
    
INSERT INTO ORDERSDETAIL(ODNO,ONO,PCODE,QTY,COST) VALUES(
    ODSEQ.NEXTVAL,
    CONCAT(TO_CHAR(SYSDATE,'RRMMDD'),LPAD(OSEQ.CURRVAL,3,'0')),
    'C1',1,1*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'C1')
    );
    
SELECT * FROM ORDERSDETAIL;

    -- 2. 상품테이블 재고수량 업데이트
UPDATE PRODUCT SET STOCK = STOCK - 20 WHERE PCODE = 'A2';
UPDATE PRODUCT SET STOCK = STOCK - 2 WHERE PCODE = 'B2';
UPDATE PRODUCT SET STOCK = STOCK - 1 WHERE PCODE = 'C1';
SELECT * FROM PRODUCT;

    -- 3. 카트테이블 비우기(주문한 상품만)
DELETE FROM CART WHERE PCODE = 'A2';
DELETE FROM CART WHERE PCODE = 'B2';
DELETE FROM CART WHERE PCODE = 'C1';
SELECT * FROM CART;


--3개 테이블 EQUI JOIN
SELECT * FROM ORDERS, ORDERSDETAIL, PRODUCT 
    WHERE ORDERS.ONO = ORDERSDETAIL.ONO
    AND ORDERSDETAIL.PCODE = PRODUCT.PCODE;