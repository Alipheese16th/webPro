package com.ch.movie.dao;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.sql.DataSource;

import com.ch.movie.dto.MovieDto;

public class MovieDao {
	public static final int FAIL = 0;
	public static final int SUCCESS = 1;
	private DataSource ds;

	public MovieDao() {
		try {
			Context ctx = new InitialContext();
			ds = (DataSource) ctx.lookup("java:comp/env/jdbc/Oracle11g");
		} catch (NamingException e) {
			System.out.println(e.getMessage());
		}
	}
	
	// 영화등록
	public int registerMovie(MovieDto dto) {
		int result = FAIL;
		Connection conn = null;
		PreparedStatement pstmt = null;
		String sql = "INSERT INTO MOVIE(MOVIEID, MOVIENAME, MOVIESUMMARY, MOVIERUNNING, MOVIEIMAGE, " + 
				"            MOVIEDATE, MOVIEGRADE, MOVIEAUDIENCE, STATE) " + 
				"  VALUES('m'||LPAD(MOVIE_SEQ.NEXTVAL,3,'0'),?,'아이언맨은 히어로 이야기이다. 머시기 저시기', " + 
				"  126,'ironman.png','08/04/30','12세 관람가',4300365,3)";
		try {
			conn = ds.getConnection();
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, dto.getMovieName());
			pstmt.setString(2,dto.getMovieSummary());
			pstmt.setInt(3,dto.getMovieRunning());
			pstmt.setString(4,dto.getMovieImage());
			pstmt.setDate(5,dto.getMovieDate());
			pstmt.setString(6,dto.getMovieGrade());
			pstmt.setInt(7,dto.getMovieAudience());
			pstmt.setInt(8, dto.getState());
			result = pstmt.executeUpdate();
		} catch (SQLException e) {
			System.out.println(e.getMessage());
			System.out.println("영화등록에러:"+dto);
		}finally {
			try {
				if(pstmt!=null)pstmt.close();
				if(conn!=null)conn.close();
			} catch (SQLException e) {
				System.out.println(e.getMessage());
			}
		}
		return result;
	}
	// 영화 수정
	public int updateMovie(MovieDto dto) {
		int result = FAIL;
		Connection conn = null;
		PreparedStatement pstmt = null;
		String sql = "UPDATE MOVIE " + 
				"  SET MOVIENAME = ?, " + 
				"      MOVIESUMMARY = ?, " + 
				"      MOVIERUNNING = ?, " + 
				"      MOVIEIMAGE = ?, " + 
				"      MOVIEDATE = ?, " + 
				"      MOVIEGRADE = ?, " + 
				"      MOVIEAUDIENCE = ?, " + 
				"      STATE = ? " + 
				"  WHERE MOVIEID = ?";
		try {
			conn = ds.getConnection();
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, dto.getMovieName());
			pstmt.setString(2,dto.getMovieSummary());
			pstmt.setInt(3,dto.getMovieRunning());
			pstmt.setString(4,dto.getMovieImage());
			pstmt.setDate(5,dto.getMovieDate());
			pstmt.setString(6,dto.getMovieGrade());
			pstmt.setInt(7,dto.getMovieAudience());
			pstmt.setInt(8, dto.getState());
			pstmt.setNString(9, dto.getMovieId());
			result = pstmt.executeUpdate();
		} catch (SQLException e) {
			System.out.println(e.getMessage());
			System.out.println("영화수정에러:"+dto);
		}finally {
			try {
				if(pstmt!=null)pstmt.close();
				if(conn!=null)conn.close();
			} catch (SQLException e) {
				System.out.println(e.getMessage());
			}
		}
		return result;
	}
	// 현재 상영중 영화리스트
	public ArrayList<MovieDto> nowPlayingMovie() {
		ArrayList<MovieDto> dtos = new ArrayList<MovieDto>();
		Connection conn = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		String sql = "SELECT * FROM MOVIE WHERE STATE = 2 ORDER BY MOVIEDATE DESC";
		try {
			conn = ds.getConnection();
			pstmt = conn.prepareStatement(sql);
			rs = pstmt.executeQuery();
			while(rs.next()) {
				String movieId = rs.getString("movieId");
				String movieName = rs.getString("movieName");
				String movieSummary = rs.getString("movieSummary");
				int movieRunning = rs.getInt("movieRunning");
				String movieImage = rs.getString("movieImage");
				Date movieDate = rs.getDate("movieDate");
				String movieGrade = rs.getString("movieGrade");
				int movieAudience = rs.getInt("movieAudience");
				int state = rs.getInt("state");
				dtos.add(new MovieDto(movieId, movieName, movieSummary, movieRunning, movieImage, movieDate, movieGrade, movieAudience, state));
			}
		} catch (SQLException e) {
			System.out.println(e.getMessage());
			System.out.println("현재상영작가져오는중에러:"+dtos);
		}finally {
			try {
				if(rs!=null)rs.close();
				if(pstmt!=null)pstmt.close();
				if(conn!=null)conn.close();
			} catch (SQLException e) {
				System.out.println(e.getMessage());
			}
		}
		return dtos;
	}
	
	
	
	
	
}
