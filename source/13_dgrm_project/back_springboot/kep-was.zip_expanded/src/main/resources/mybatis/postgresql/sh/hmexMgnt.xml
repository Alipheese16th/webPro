<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.hmex.mapper.HmexMgntMapper">

	<select id="selectMstrList" parameterType="sqlMap" resultType="sqlMap">
		/* selectMstrList */
		select 
			t1.wkpl_id 
			,to_char(now(), 'YYYY') as hmex_year
			,t1.spc_hmex_cd as hmex_cl_cd
			,t1.deal_mtra_cd 
			,t1.spc_hmex_trgp_org_cd as hmex_trgp_org_cd
			,(select case when #{SESS_LANG} = 'KO' then tcd.dept_ko_nm
						else tcd.dept_en_nm
					end as dept_nm
				from tb_co_dept tcd
				where tcd.dept_cd = tcu.dept_cd 
			 ) as org_nm
			,t1.spc_hmex_tgt_usr_id as hmex_tgt_usr_id
			,case when #{SESS_LANG} = 'KO' then tcu.usr_ko_nm
				  when #{SESS_LANG} = 'EN' then tcu.usr_en_nm
				  else tcu.usr_zh_nm
			 end as hmex_trgp_nm
			,substring(tcu.joinc_da, 0, 5) || '-' || substring(tcu.joinc_da, 5, 2) || '-' || substring(tcu.joinc_da, 7, 2) as jncm_dt
			,tcu.usr_clsf_cd as cwkr_yn
		from tb_sh_spc_hmex_trgp t1
		join tb_co_user tcu on t1.spc_hmex_tgt_usr_id = tcu.usr_id 
		where not exists (select 1 from tb_sh_hmex_trgp 
						   where hmex_tgt_usr_id = t1.spc_hmex_tgt_usr_id
							 and hmex_cl_cd = t1.spc_hmex_cd 
							 and deal_mtra_cd = t1.deal_mtra_cd 
							 and hmex_year = to_char(now(), 'YYYY') 
						 )
		  and tcu.cmpy_cd = #{cmpy_cd}
		order by t1.wkpl_id, t1.spc_hmex_tgt_usr_id, t1.deal_mtra_cd 
	</select>
	
	<select id="selectTrgpList" parameterType="sqlMap" resultType="sqlMap">
		/* selectTrgpList */
		select 
			hmex_year
			,hmex_tgt_usr_id
			,hmex_sn 
			,wkpl_id
			,fn_get_cmpy(wkpl_id, 'NM', #{SESS_LANG}) as cmpy_nm
			,fn_get_cd('ST00000002', wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
			,hmex_cl_cd
			,fn_get_cd('SH00000037', hmex_cl_cd, 'nm', #{SESS_LANG}) as hmex_cl_nm
			,deal_mtra_cd
			,fn_get_cd('SH00000035', deal_mtra_cd, 'nm', #{SESS_LANG}) as deal_mtra_nm
			,hmex_trgp_org_cd
			,org_nm
			,hmex_trgp_nm as full_hmex_trgp_nm
            ,substring(hmex_trgp_nm, 1, 1) || '*' || substring(hmex_trgp_nm, 3) as hmex_trgp_nm
			,substring(jncm_dt, 0, 5) || '-' || substring(jncm_dt, 5, 2) || '-' || substring(jncm_dt, 7, 2) as jncm_dt
			,substring(rsgn_dt, 0, 5) || '-' || substring(rsgn_dt, 5, 2) || '-' || substring(rsgn_dt, 7, 2) as rsgn_dt
			,cwkr_yn
            ,fn_get_cd('SH00000052', t1.cwkr_yn, 'nm', #{SESS_LANG}) as cwkr_yn_nm
		from tb_sh_hmex_trgp t1
		where not exists (
					select 1 from tb_sh_hmex_rslt 
					where hmex_year = t1.hmex_year
					and hmex_sn = t1.hmex_sn 
					and hmex_tgt_usr_id = t1.hmex_tgt_usr_id 
					and hmex_cl_cd = t1.hmex_cl_cd 
				<if test='deal_mtra_cd != null and deal_mtra_cd != ""'>
					and deal_mtra_cd = t1.deal_mtra_cd
				</if>
				)
		<if test='hmex_year != null and hmex_year != ""'>
			and hmex_year = #{hmex_year}
		</if>
		<if test='wkpl_id != null and wkpl_id != ""'>
			and wkpl_id = #{wkpl_id}
		</if>
		<if test='org_nm != null and org_nm != ""'>
			and org_nm like '%' || #{org_nm} || '%'
		</if>
		<if test='hmex_trgp_nm != null and hmex_trgp_nm != ""'>
			and hmex_trgp_nm = #{hmex_trgp_nm}
		</if>
		<if test='cmpy_cd != null and cmpy_cd != ""'>
		   and exists (select 1
		      			 from tb_sh_wkpl w
		      			where w.wkpl_id = t1.wkpl_id 
		      			  and w.cmpy_cd = #{cmpy_cd}
		   			  )
		 </if>
		<choose>
			<when test='spc == "Y"'>
				and hmex_cl_cd != 'CG01'
			</when>
			<otherwise>
				and hmex_cl_cd = 'CG01'
			</otherwise>
		</choose>
		order by wkpl_id, hmex_trgp_nm, deal_mtra_cd
	</select>
	
	<select id="selectCurrTrgpList" parameterType="sqlMap" resultType="sqlMap">
		/* selectCurrTrgpList */
		select 
			tcu.usr_id as hmex_tgt_usr_id
			,tcu.dept_cd as hmex_trgp_org_cd
			,(select case when #{SESS_LANG} = 'KO' then tcd.dept_ko_nm
					      else tcd.dept_en_nm
				     end as dept_nm
			    from tb_co_dept tcd
			   where tcd.dept_cd = tcu.dept_cd 
			 ) as org_nm
			,case when #{SESS_LANG} = 'KO' then tcu.usr_ko_nm
			      when #{SESS_LANG} = 'EN' then tcu.usr_en_nm
				  else tcu.usr_zh_nm
			end as hmex_trgp_nm
			,substring(tcu.joinc_da, 0, 5) || '-' || substring(tcu.joinc_da, 5, 2) || '-' || substring(tcu.joinc_da, 7, 2) as jncm_dt
			,tcu.usr_clsf_cd as cwkr_yn
            ,fn_get_cd('SH00000052', tcu.usr_clsf_cd, 'nm', #{SESS_LANG}) as cwkr_yn_nm
		from tb_co_user tcu 
		where tcu.usg_yn = 'Y'
			and tcu.del_yn  = 'N'
			and tcu.cmpy_cd = #{cmpy_cd}
		<if test='org_nm != null and org_nm != ""'>
			and (select case when #{SESS_LANG} = 'KO' then tcd.dept_ko_nm
					      else tcd.dept_en_nm
				     end as dept_nm
			    from tb_co_dept tcd
			   where tcd.dept_cd = tcu.dept_cd) like '%' || #{org_nm} || '%'
		</if>
		<if test='hmex_trgp_nm != null and hmex_trgp_nm != ""'>
			and (tcu.usr_ko_nm like '%' || #{hmex_trgp_nm} || '%' or tcu.usr_en_nm like '%' || #{hmex_trgp_nm} || '%' or tcu.usr_zh_nm like '%' || #{hmex_trgp_nm} || '%')
		</if>
		<choose>
			<when test='kind == "C"'>
				and substring(tcu.joinc_da, 0, 5) = to_char(now(), 'YYYY')
			</when>
			<when test='kind == "H"'>
				and tcu.usr_clsf_cd = 'H'
			</when>
			<otherwise>
				and (substring(tcu.joinc_da, 0, 5) = to_char(now(), 'YYYY') or tcu.usr_clsf_cd = 'H')
			</otherwise>
		</choose>
		order by org_nm, tcu.usr_id
	</select>
	
	<!-- 특수검진 대상자 등록  -->
	<insert id="insertHmexMgnt" parameterType="sqlMap">
		<selectKey keyProperty="hmex_sn" resultType="int" order="BEFORE">
			select coalesce(max(hmex_sn), 0) + 1 as hmex_sn from tb_sh_hmex_trgp t1
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
    	</selectKey>
      	/* insertHmexMgnt - 특수검진 대상자 등록 */
		insert into tb_sh_hmex_trgp (
		    hmex_year
		    ,hmex_tgt_usr_id
			,hmex_sn
		    ,wkpl_id
		    ,hmex_cl_cd
		    ,deal_mtra_cd
		    ,hmex_trgp_org_cd
		    ,org_nm
		    ,hmex_trgp_nm
		    ,jncm_dt
		    ,rsgn_dt
		    ,cwkr_yn
			,crt_usr_id
			,upt_usr_id
		) select
			#{hmex_year}
		    ,#{hmex_tgt_usr_id}
		    ,#{hmex_sn}::INTEGER
			,#{wkpl_id}
		    ,#{hmex_cl_cd}
		    ,#{deal_mtra_cd}
		    ,#{hmex_trgp_org_cd}
		    ,#{org_nm}
		    ,#{hmex_trgp_nm}
			,replace(#{jncm_dt}, '-', '')
			,replace(#{rsgn_dt}, '-', '')
		    ,#{cwkr_yn}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		where not exists (
			select 1 from tb_sh_hmex_trgp
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
			and deal_mtra_cd = #{deal_mtra_cd} and hmex_cl_cd = #{hmex_cl_cd}
		) 
    </insert>
    
    <!-- 일반검진 대상자 등록  -->
    <insert id="insertHmexMgnt2" parameterType="sqlMap">
		<selectKey keyProperty="hmex_sn" resultType="int" order="BEFORE">
			select coalesce(max(hmex_sn), 0) + 1 as hmex_sn from tb_sh_hmex_trgp t1
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
    	</selectKey>
      	/* insertHmexMgnt2 - 일반검진 대상자 등록 */
		insert into tb_sh_hmex_trgp (
		    hmex_year
		    ,hmex_tgt_usr_id
			,hmex_sn
		    ,wkpl_id
		    ,hmex_cl_cd
		    ,deal_mtra_cd
		    ,hmex_trgp_org_cd
		    ,org_nm
		    ,hmex_trgp_nm
		    ,jncm_dt
		    ,rsgn_dt
		    ,cwkr_yn
			,crt_usr_id
			,upt_usr_id
		) select
			#{hmex_year}
		    ,#{hmex_tgt_usr_id}
		    ,#{hmex_sn}::INTEGER
			,#{wkpl_id}
		    ,#{hmex_cl_cd}
		    ,#{deal_mtra_cd}
		    ,#{hmex_trgp_org_cd}
		    ,#{org_nm}
		    ,#{hmex_trgp_nm}
			,replace(#{jncm_dt}, '-', '')
			,replace(#{rsgn_dt}, '-', '')
		    ,#{cwkr_yn}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		where not exists (
			select 1 from tb_sh_hmex_trgp
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
		) 
    </insert>
    
    <delete id="deleteHmexMgnt" parameterType="sqlMap">
        /* deleteHmexMgnt */
        delete from tb_sh_hmex_trgp
        where hmex_year || '-' || hmex_tgt_usr_id || '-' || hmex_sn = #{hmex_trgp_id}
    </delete>
</mapper>