<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.riskeval.mapper.RiskEvalAftActMapper">
	
	<select id="selectRiskEvalAftActList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRiskEvalAftActList */
		select
			a.dgsn_apal_id
			,b.dgsn_apal_dtl_id
			,b.dgsn_apal_id || '-' || b.sort_sn as apal_id
		    ,(select z.cmpy_cd from tb_sh_wkpl z
			     where z.wkpl_id = a.wkpl_id) as cmpy_cd
			,(select fn_get_cd('CO00000009', z.cmpy_cd, 'NM', #{SESS_LANG}) from tb_sh_wkpl z
			     where z.wkpl_id = a.wkpl_id) as cmpy_nm
		    ,a.wkpl_id
		    ,fn_get_cd('ST00000002', a.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
		    ,a.dgsn_apal_type_cd
		    ,fn_get_cd('SH00000078', a.dgsn_apal_type_cd, 'nm', #{SESS_LANG}) as dgsn_apal_type_nm
		    ,a.dgsn_spot_apal_type_cd
		    ,fn_get_cd('SH00000079', a.dgsn_spot_apal_type_cd, 'nm', #{SESS_LANG}) as dgsn_spot_apal_type_nm
		    ,a.dgsn_apal_supe_usr_id
		    ,fn_get_user(a.dgsn_apal_supe_usr_id, 'nm', #{SESS_LANG}) as dgsn_apal_supe_usr_nm
		    ,c.dept_cd as dgsn_org_cd
		    ,fn_get_dept(c.dept_cd, 'nm', #{SESS_LANG}) as dgsn_org_nm
		    ,substring(a.dgsn_apal_bgn_dt, 0, 5) || '-' || substring(a.dgsn_apal_bgn_dt, 5, 2) || '-' || substring(a.dgsn_apal_bgn_dt, 7, 2) as dgsn_apal_bgn_dt
		    ,a.lrcl_dngp_id
		    ,(select dngp_nm from tb_sh_risk_dngp where dngp_id = a.lrcl_dngp_id) as lrcl_dngp_nm
      		,a.mdcl_dngp_id
      		,(select dngp_nm from tb_sh_risk_dngp where dngp_id = a.mdcl_dngp_id) as mdcl_dngp_nm
      		,b.smcl_dngp_id
      		,(select dngp_nm from tb_sh_risk_dngp where dngp_id = b.smcl_dngp_id) as smcl_dngp_nm
			,b.dgsn_apal_dtl_oprn_txt
			,b.dgsn_apal_tgt_eqp_nm
			,b.dgsn_apal_tgt_mtra_nm
			,b.risk_cat_cd
			,fn_get_cd('SH00000080', b.risk_cat_cd, 'nm', #{SESS_LANG}) as risk_cat_nm
			,b.hmfl_risk_fact_cd
			,fn_get_cd('SH00000081', b.hmfl_risk_fact_cd, 'nm', #{SESS_LANG}) as hmfl_risk_fact_nm
			,b.risk_occr_rslt_txt
			,b.cur_sfhe_actn_txt
			,coalesce(b.risk_occr_psbl_scr, 0) as risk_occr_psbl_scr
			,coalesce(b.risk_occr_main_scr, 0) as risk_occr_main_scr
			,coalesce(b.dgsn_apal_scr, 0) as dgsn_apal_scr
			,b.dgsn_dec_meas_txt
			,coalesce(b.btt_af_risk_occr_psbl_scr, 0) as btt_af_risk_occr_psbl_scr
			,coalesce(b.btt_af_risk_occr_main_scr, 0) as btt_af_risk_occr_main_scr
			,coalesce(b.btt_af_dgsn_apal_scr, 0) as btt_af_dgsn_apal_scr
			,b.dgsn_btt_rspn_usr_id
			,fn_get_dept((select dept_cd from tb_co_user where usr_id = b.dgsn_btt_rspn_usr_id), 'nm', #{SESS_LANG})
		     || ' ' || fn_get_user(b.dgsn_btt_rspn_usr_id, 'nm', #{SESS_LANG}) as dgsn_btt_rspn_usr_nm
			,substring(b.dgsn_btt_cmpy_schd_dt, 0, 5) || '-' || substring(b.dgsn_btt_cmpy_schd_dt, 5, 2) || '-' || substring(b.dgsn_btt_cmpy_schd_dt, 7, 2) as dgsn_btt_cmpy_schd_dt
			,b.dgsn_btt_txt
			,b.dgsn_btt_bf_img_atfl_no
			,b.dgsn_btt_af_img_atfl_no
			,b.dgsn_btt_prst_cd
			,case when b.dgsn_btt_prst_cd = 'EA01' and current_date > b.dgsn_btt_cmpy_schd_dt::date then fn_get_cd('SH00000085', 'EA10', 'nm', #{SESS_LANG})
			 else fn_get_cd('SH00000085', b.dgsn_btt_prst_cd, 'nm', #{SESS_LANG}) end as dgsn_btt_prst_nm
			,b.dgsn_btt_aprv_no
			,b.sort_sn
			,#{profiles} as profiles
			,#{serverUrl} as server_url
			,case when (select dept_cd from tb_co_user where usr_id = b.dgsn_btt_rspn_usr_id) = #{SESS_DEPT} then 'U'
		     else 'R' end as mode
		from tb_sh_risk_dgsn_apal a, tb_sh_risk_dgsn_apal_dtl b, tb_co_user c
		where a.dgsn_apal_id = b.dgsn_apal_id 
			and a.dgsn_apal_supe_usr_id = c.usr_id 
			and a.del_yn = 'N'
			and b.del_yn = 'N'
			and a.dgsn_apal_prst_cd = 'E03'
		 <if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
			and a.dgsn_apal_bgn_dt between replace(#{sDate},'-','') and replace(#{eDate},'-','')
		 </if>
		 <if test='wkpl_id != null and wkpl_id != ""'>
			and a.wkpl_id = #{wkpl_id}
		 </if>
		 <if test='cmpy_cd != null and cmpy_cd != ""'>
		    and exists (select 1
		      			  from tb_sh_wkpl w
		      			 where w.wkpl_id = a.wkpl_id 
		      			   and w.cmpy_cd = #{cmpy_cd}
		   			   )
		 </if>
		 <if test='dgsn_org_cd != null and dgsn_org_cd != ""'>
			and c.dept_cd = #{dgsn_org_cd}
		 </if>
		 <if test='dgsn_apal_supe_usr_id != null and dgsn_apal_supe_usr_id != ""'>
			and a.dgsn_apal_supe_usr_id = #{dgsn_apal_supe_usr_id}
		 </if>
		 <if test='dgsn_apal_type_cd != null and dgsn_apal_type_cd != ""'>
			and a.dgsn_apal_type_cd = #{dgsn_apal_type_cd}
		 </if>
		 <if test='dgsn_spot_apal_type_cd != null and dgsn_spot_apal_type_cd != ""'>
			and a.dgsn_spot_apal_type_cd = #{dgsn_spot_apal_type_cd}
		 </if>
		 <if test='lrcl_dngp_id != null and lrcl_dngp_id != ""'>
			and a.lrcl_dngp_id = #{lrcl_dngp_id}
		 </if>
		 <if test='mdcl_dngp_id != null and mdcl_dngp_id != ""'>
			and a.mdcl_dngp_id = #{mdcl_dngp_id}
		 </if>
		 <if test='dgsn_btt_prst_cd != null and dgsn_btt_prst_cd != "" and dgsn_btt_prst_cd != "EA01" and dgsn_btt_prst_cd != "EA10"'>
			and b.dgsn_btt_prst_cd = #{dgsn_btt_prst_cd}
		 </if>
		 <if test='dgsn_btt_prst_cd != null and dgsn_btt_prst_cd != "" and dgsn_btt_prst_cd == "EA01"'>
			and b.dgsn_btt_prst_cd = 'EA01' and current_date <![CDATA[<=]]> b.dgsn_btt_cmpy_schd_dt::date
		 </if>
		 <if test='dgsn_btt_prst_cd != null and dgsn_btt_prst_cd != "" and dgsn_btt_prst_cd == "EA10"'>
			and b.dgsn_btt_prst_cd = 'EA01' and current_date <![CDATA[>]]> b.dgsn_btt_cmpy_schd_dt::date
		 </if>
		 <if test='risk_cat_cd != null and risk_cat_cd != ""'>
			and b.risk_cat_cd = #{risk_cat_cd}
		 </if>
		 <if test='hmfl_risk_fact_cd != null and hmfl_risk_fact_cd != ""'>
			and b.hmfl_risk_fact_cd = #{hmfl_risk_fact_cd}
		 </if>
		 <if test='dgsn_apal_id != null and dgsn_apal_id != ""'>
			and a.dgsn_apal_id = #{dgsn_apal_id}
		 </if>
		 <if test='apal_id != null and apal_id != ""'>
			and b.dgsn_apal_id || '-' || b.sort_sn = #{apal_id}
		 </if>
		 <if test='dgsn_apal_level != null and dgsn_apal_level != ""'>
			and b.dgsn_apal_scr between coalesce(fn_get_cd('SH00000084', #{dgsn_apal_level}, 'B1', #{SESS_LANG})::INTEGER, 0) and coalesce(fn_get_cd('SH00000084', #{dgsn_apal_level}, 'B2', #{SESS_LANG})::INTEGER, 0)
		 </if>
		 <if test='btt_af_dgsn_apal_level != null and btt_af_dgsn_apal_level != ""'>
			and b.btt_af_dgsn_apal_scr between coalesce(fn_get_cd('SH00000084', #{btt_af_dgsn_apal_level}, 'B1', #{SESS_LANG})::INTEGER, 0) and coalesce(fn_get_cd('SH00000084', #{btt_af_dgsn_apal_level}, 'B2', #{SESS_LANG})::INTEGER, 0)
		 </if>
		order by a.dgsn_apal_id desc, apal_id 
	</select>
    
    <update id="updateRiskEvalAftAct" parameterType="sqlMap">
        /* updateRiskEvalAftAct */
        update tb_sh_risk_dgsn_apal_dtl set
        	dgsn_btt_txt = #{dgsn_btt_txt}
			,dgsn_btt_bf_img_atfl_no = #{dgsn_btt_bf_img_atfl_no}::INTEGER
			,dgsn_btt_af_img_atfl_no = #{dgsn_btt_af_img_atfl_no}::INTEGER
			,dgsn_btt_prst_cd = #{dgsn_btt_prst_cd}
			,upt_usr_id = #{SESS_USR_ID}
			,upt_dt = statement_timestamp()
		where dgsn_apal_dtl_id = #{dgsn_apal_dtl_id}
    </update>
    
    <update id="updateRiskEvalAftActPrst" parameterType="sqlMap">
        /* updateRiskEvalAftActPrst */
        update tb_sh_risk_dgsn_apal_dtl set
        	dgsn_btt_prst_cd = #{dgsn_btt_prst_cd}
			,upt_usr_id = #{SESS_USR_ID} 
			,upt_dt = statement_timestamp()
		where dgsn_apal_dtl_id = #{dgsn_apal_dtl_id}
    </update>
    
    <update id="updateRiskEvalAftActAppr" parameterType="sqlMap">
        /* updateRiskEvalAftActAppr */
        update tb_sh_risk_dgsn_apal_dtl set
			dgsn_btt_aprv_no = #{dgsn_btt_aprv_no}
			,upt_usr_id = #{SESS_USR_ID}
			,upt_dt = statement_timestamp()
		where dgsn_apal_dtl_id = #{dgsn_apal_dtl_id}
    </update>
    
    <select id="selectRiskEvalAftActAppr" parameterType="sqlMap" resultType="sqlMap">
		/* selectRiskEvalAftActAppr */
		select dgsn_btt_aprv_no
		      ,dgsn_btt_prst_cd
		  from tb_sh_risk_dgsn_apal_dtl 
		 where dgsn_btt_aprv_no = #{dgsn_btt_aprv_no}
	</select>
	
	<update id="updateRiskEvalAftActAprvAf" parameterType="sqlMap">
        /* updateRiskEvalAftActAprvAf */
        update tb_sh_risk_dgsn_apal_dtl set 
        	dgsn_btt_prst_cd = #{dgsn_btt_prst_cd}
		    ,upt_dt = statement_timestamp()
		 where dgsn_btt_aprv_no = #{dgsn_btt_aprv_no}
    </update>
    
</mapper>