<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.rgltvltn.mapper.RgltVltnMapper">

	<select id="selectRgltVltnList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltVltnList */
		select
		    t1.rglt_vltn_id
		    ,fn_get_cmpy(t1.wkpl_id, 'NM', #{SESS_LANG}) as cmpy_nm
		    ,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
		    ,fn_get_cd('SH00000012', t1.rglt_chk_cl_cd, 'nm', #{SESS_LANG}) as rglt_chk_cl_nm
		    ,fn_get_cd('SH00000013', t1.rel_rglt_cd, 'nm', #{SESS_LANG}) as rel_rglt_nm
		    ,fn_get_cd('SH00000014', t1.rglt_vltn_bsns_cd, 'nm', #{SESS_LANG}) as rglt_vltn_bsns_nm
		    ,t1.rglt_vltn_ttl
		    ,substring(t1.rglt_vltn_chk_dt, 0, 5) || '-' || substring(t1.rglt_vltn_chk_dt, 5, 2) || '-' || substring(t1.rglt_vltn_chk_dt, 7, 2) as rglt_vltn_chk_dt
		    ,t1.rglt_chk_orga_nm
		    ,fn_get_cd('SH00000015', t1.rglt_dspt_cl_cd, 'nm', #{SESS_LANG}) as rglt_dspt_cl_nm
		    ,to_char(t1.fine_amt , '999,999,999,999,999') as fine_amt
		    ,t1.kor_rglt_vltn_org_nm 
		    ,fn_get_user(t1.rglt_vltn_usr_id, 'nm', #{SESS_LANG}) as rglt_vltn_usr_nm
		    ,t1.rglt_vltn_atfl_no
		    ,t1.rglt_vltn_yn
			,t1.rglt_vltn_actn_rslt_txt
			,t1.rglt_vltn_prst_cd
			,fn_get_cd('SH00000066', t1.rglt_vltn_prst_cd, 'nm', #{SESS_LANG}) as rglt_vltn_prst_nm
		    ,case when (select dept_cd from tb_co_user where usr_id = t1.crt_usr_id) = #{SESS_DEPT} then 'U'
		     else 'R' end as mode
		    ,t1.crt_usr_id
		from tb_sh_rglt_vltn t1
		left outer join tb_sh_wkpl t2 on t1.wkpl_id = t2.wkpl_id 
		where (t1.del_yn = 'N' or t1.del_yn is null or t1.del_yn = '')
		<if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
		and t1.rglt_vltn_chk_dt between replace(#{sDate},'-','') and replace(#{eDate},'-','')
		</if>
		<if test='wkpl_id != null and wkpl_id != ""'>
			and t1.wkpl_id = #{wkpl_id}
		</if>
		<if test='rglt_chk_cl_cd != null and rglt_chk_cl_cd != ""'>
		and t1.rglt_chk_cl_cd = #{rglt_chk_cl_cd}
		</if>
		<if test='rel_rglt_cd != null and rel_rglt_cd != ""'>
			and t1.rel_rglt_cd  = #{rel_rglt_cd}
		</if>
		<if test='rglt_dspt_cl_cd != null and rglt_dspt_cl_cd != ""'>
			and t1.rglt_dspt_cl_cd  = #{rglt_dspt_cl_cd}
		</if>
		<if test='rglt_vltn_bsns_cd != null and rglt_vltn_bsns_cd != ""'>
			and t1.rglt_vltn_bsns_cd  = #{rglt_vltn_bsns_cd}
		</if>
		<if test='cmpy_cd != null and cmpy_cd != ""'>
		   and exists (select 1
		      			 from tb_sh_wkpl w
		      			where w.wkpl_id = t1.wkpl_id 
		      			  and w.cmpy_cd = #{cmpy_cd}
		   			  )
		 </if>
		order by rglt_vltn_id desc
	</select>
	
	<select id="selectRgltVltn" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltVltn */
		select 
			t1.rglt_vltn_id
			,t1.wkpl_id
			,t1.rglt_chk_cl_cd
			,t1.rel_rglt_cd
			,t1.rglt_vltn_bsns_cd
			,t1.rglt_dspt_cl_cd
			,substring(t1.rglt_vltn_chk_dt, 0, 5) || '-' || substring(t1.rglt_vltn_chk_dt, 5, 2) || '-' || substring(t1.rglt_vltn_chk_dt, 7, 2) as rglt_vltn_chk_dt
			,t1.rglt_vltn_wkpl_loc_id
			,t2.upp_incl_wkpl_loc_nm as rglt_vltn_wkpl_loc_nm
			,t1.rglt_vltn_org_cd
			,t1.kor_rglt_vltn_org_nm
			,t1.engl_rglt_vltn_org_nm
			,t1.rglt_vltn_usr_id
			,fn_get_user(t1.rglt_vltn_usr_id, 'nm', #{SESS_LANG}) as rglt_vltn_usr_nm
			,to_char(t1.fine_amt, 'FM999G999G999G999') as fine_amt
			,t1.rglt_vltn_cnt
			,t1.admn_dspt_txt
			,t1.rglt_vltn_ttl
			,t1.rglt_chk_orga_nm
			,t1.rglt_vltn_txt
			,t1.rglt_vltn_atfl_no
			,t1.rglt_vltn_yn
			,t1.rglt_vltn_actn_rslt_txt
			,t1.rglt_vltn_prst_cd
			,t1.crt_usr_id
		from tb_sh_rglt_vltn t1
		left outer join tb_sh_wkpl_loc t2 on t1.rglt_vltn_wkpl_loc_id = t2.wkpl_loc_id 
		where t1.rglt_vltn_id = #{rglt_vltn_id}
	</select>
	
	<select id="selectRgltVltnComplete" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltVltnComplete */
		select 
			t1.rglt_vltn_id
			,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
		    ,fn_get_cd('SH00000012', t1.rglt_chk_cl_cd, 'nm', #{SESS_LANG}) as rglt_chk_cl_nm
		    ,fn_get_cd('SH00000013', t1.rel_rglt_cd, 'nm', #{SESS_LANG}) as rel_rglt_nm
		    ,fn_get_cd('SH00000014', t1.rglt_vltn_bsns_cd, 'nm', #{SESS_LANG}) as rglt_vltn_bsns_nm
		    ,fn_get_cd('SH00000015', t1.rglt_dspt_cl_cd, 'nm', #{SESS_LANG}) as rglt_dspt_cl_nm
			,substring(t1.rglt_vltn_chk_dt, 0, 5) || '-' || substring(t1.rglt_vltn_chk_dt, 5, 2) || '-' || substring(t1.rglt_vltn_chk_dt, 7, 2) as rglt_vltn_chk_dt
			,t1.rglt_vltn_wkpl_loc_id
			,t2.upp_incl_wkpl_loc_nm as rglt_vltn_wkpl_loc_nm
			,t1.rglt_vltn_org_cd
			,t1.kor_rglt_vltn_org_nm
			,t1.engl_rglt_vltn_org_nm
			,t1.rglt_vltn_usr_id
			,fn_get_user(t1.rglt_vltn_usr_id, 'nm', #{SESS_LANG}) as rglt_vltn_usr_nm
			,to_char(t1.fine_amt, 'FM999G999G999G999') as fine_amt
			,t1.rglt_vltn_cnt
			,t1.admn_dspt_txt
			,t1.rglt_vltn_ttl
			,t1.rglt_chk_orga_nm
			,t1.rglt_vltn_txt
			,t1.rglt_vltn_atfl_no
			,t1.rglt_vltn_yn
			,t1.rglt_vltn_actn_rslt_txt
			,t1.rglt_vltn_prst_cd
		from tb_sh_rglt_vltn t1
		left outer join tb_sh_wkpl_loc t2 on t1.rglt_vltn_wkpl_loc_id = t2.wkpl_loc_id 
		where t1.rglt_vltn_id = #{rglt_vltn_id}
	</select>
	
	<insert id="insertRgltVltn" parameterType="sqlMap">
		<selectKey keyProperty="rglt_vltn_id" resultType="String" order="BEFORE">
        	select to_char(now(), 'RVYYMMDD') || to_char(substring(coalesce(MAX(rglt_vltn_id), to_char(now(), 'RVYYMMDD0000')), 9, 4)::INTEGER + 1, 'FM0000') rglt_vltn_id
			from tb_sh_rglt_vltn
			where rglt_vltn_id like to_char(now(), 'RVYYMMDD') || '%'
    	</selectKey>
    	
      	/* insertRgltVltn */
		insert into tb_sh_rglt_vltn (
			rglt_vltn_id
			,wkpl_id
			,rglt_chk_cl_cd
			,rel_rglt_cd
			,rglt_vltn_bsns_cd
			,rglt_dspt_cl_cd
			,rglt_vltn_chk_dt
			,rglt_vltn_wkpl_loc_id
			,rglt_vltn_org_cd
			,kor_rglt_vltn_org_nm
			,engl_rglt_vltn_org_nm
			,rglt_vltn_usr_id
			,fine_amt
			,rglt_vltn_cnt
			,admn_dspt_txt
			,rglt_vltn_ttl
			,rglt_chk_orga_nm
			,rglt_vltn_txt
			,rglt_vltn_atfl_no
			,rglt_vltn_yn
			,rglt_vltn_actn_rslt_txt
			,rglt_vltn_prst_cd
			,rglt_vltn_aprv_no
			,del_yn
		    ,crt_usr_id
			,upt_usr_id
		) values (
			#{rglt_vltn_id}
			,#{wkpl_id}
			,#{rglt_chk_cl_cd}
			,#{rel_rglt_cd}
			,#{rglt_vltn_bsns_cd}
			,#{rglt_dspt_cl_cd}
			,#{rglt_vltn_chk_dt}
			,#{rglt_vltn_wkpl_loc_id}
			,#{rglt_vltn_org_cd}
			,#{kor_rglt_vltn_org_nm}
			,#{engl_rglt_vltn_org_nm}
			,#{rglt_vltn_usr_id}
			,case when #{fine_amt}::text  = '' then null 
							   			    	else replace(#{fine_amt}, ',', '')::NUMERIC
					    	 		    end
			,case when #{rglt_vltn_cnt}::text  = '' then null 
							   			    	else replace(#{rglt_vltn_cnt}, ',', '')::NUMERIC
					    	 		    end
			,#{admn_dspt_txt}
			,#{rglt_vltn_ttl}
			,#{rglt_chk_orga_nm}
			,#{rglt_vltn_txt}
		    ,#{rglt_vltn_atfl_no}::INTEGER 
		    ,#{rglt_vltn_yn}
			,#{rglt_vltn_actn_rslt_txt}
			,#{rglt_vltn_prst_cd}
			,#{rglt_vltn_aprv_no}
			,'N'
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		)
    </insert>
    
    <update id="updateRgltVltn" parameterType="sqlMap">
        /* updateRgltVltn */
        update tb_sh_rglt_vltn set
			wkpl_id					= #{wkpl_id}
			,rglt_chk_cl_cd			= #{rglt_chk_cl_cd}
			,rel_rglt_cd			= #{rel_rglt_cd}
			,rglt_vltn_bsns_cd		= #{rglt_vltn_bsns_cd}
			,rglt_dspt_cl_cd		= #{rglt_dspt_cl_cd}
			,rglt_vltn_chk_dt			= #{rglt_vltn_chk_dt}
			,rglt_vltn_wkpl_loc_id	= #{rglt_vltn_wkpl_loc_id}
			,rglt_vltn_org_cd			= #{rglt_vltn_org_cd}
			,kor_rglt_vltn_org_nm		= #{kor_rglt_vltn_org_nm}
			,engl_rglt_vltn_org_nm		= #{engl_rglt_vltn_org_nm}
			,rglt_vltn_usr_id			= #{rglt_vltn_usr_id}
			,fine_amt					= case when #{fine_amt}::text  = '' then null 
							   			    	else replace(#{fine_amt}, ',', '')::NUMERIC
					    	 		    end
			,rglt_vltn_cnt				= case when #{rglt_vltn_cnt}::text  = '' then null 
							   			    	else replace(#{rglt_vltn_cnt}, ',', '')::NUMERIC
					    	 		    end
			,admn_dspt_txt				= #{admn_dspt_txt}
			,rglt_vltn_ttl				= #{rglt_vltn_ttl}
			,rglt_chk_orga_nm			= #{rglt_chk_orga_nm}
			,rglt_vltn_txt				= #{rglt_vltn_txt}
			,rglt_vltn_atfl_no		= #{rglt_vltn_atfl_no}::INTEGER 
			,rglt_vltn_yn				= #{rglt_vltn_yn}
			,rglt_vltn_actn_rslt_txt	= #{rglt_vltn_actn_rslt_txt}
			,rglt_vltn_prst_cd		= #{rglt_vltn_prst_cd}
			,rglt_vltn_aprv_no		= #{rglt_vltn_aprv_no}
			,upt_usr_id					= #{SESS_USR_ID}
			,upt_dt 					= statement_timestamp()
		where rglt_vltn_id = #{rglt_vltn_id}	
    </update>
    
    <update id="updateRgltVltnComplete" parameterType="sqlMap">
        /* updateRgltVltnComplete */
        update tb_sh_rglt_vltn set
			rglt_vltn_aprv_no		= #{rglt_vltn_aprv_no}
			,upt_usr_id					= #{SESS_USR_ID}
			,upt_dt 					= statement_timestamp()
		where rglt_vltn_id = #{rglt_vltn_id}	
    </update>
    
	<delete id="deleteRgltVltn" parameterType="sqlMap">
        /* deleteRgltVltn */
        delete from tb_sh_rglt_vltn
		where rglt_vltn_id = #{rglt_vltn_id}
    </delete>
	
	<select id="selectRgltVltnId" parameterType="sqlMap" resultType="string">
		/* selectRgltVltnId */
		select to_char(now(), 'RVYYMMDD') || to_char(substring(coalesce(MAX(rglt_vltn_id), to_char(now(), 'RVYYMMDD0000')), 9, 4)::INTEGER + 1, 'FM0000') rglt_vltn_id
		from tb_sh_rglt_vltn
		where rglt_vltn_id like to_char(now(), 'RVYYMMDD') || '%'
	</select>
	
	<select id="selectRgltVltnAprvDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltVltnAprvDtl */
		select rglt_vltn_aprv_no
		      ,rglt_vltn_prst_cd
		  from tb_sh_rglt_vltn 
		 where rglt_vltn_aprv_no = #{rglt_vltn_aprv_no}
	</select>
	
	<update id="updateRgltVltnAprvAf" parameterType="sqlMap">
        /* updateRgltVltnAprvAf */
        update tb_sh_rglt_vltn
		   set rglt_vltn_prst_cd = #{rglt_vltn_prst_cd}
		      ,upt_dt = now()
		 where rglt_vltn_aprv_no = #{rglt_vltn_aprv_no}
    </update>
    
    <update id ="delRglt" parameterType="sqlMap">
    /* delRglt */
        update tb_sh_rglt_vltn
		   set	del_yn = 'Y'
				,upt_usr_id  = #{username}
		      	,upt_dt = current_timestamp
		 where rglt_vltn_id = #{rglt_vltn_id}
    </update>
    
</mapper>