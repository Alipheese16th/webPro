<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.acdtmgnt.mapper.AcdtRecvMgntMapper">

	<!-- 기본정보 조회 -->
	<select id="selectAcdtRecvMgntBasic" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtRecvMgntBasic */
		select #{cmpy_cd} as cmpy_cd
			  ,fn_get_cd('CO00000009', #{cmpy_cd}, 'NM', #{SESS_LANG_CD}) as cmpy_nm
			  ,#{wkpl_id} as wkpl_id
			  ,fn_get_cd('ST00000002', #{wkpl_id}, 'NM', #{SESS_LANG_CD}) as wkpl_nm
			  ,#{acdt_cl_cd} as acdt_cl_cd
			  ,fn_get_cd('SH00000024', #{acdt_cl_cd}, 'NM', #{SESS_LANG_CD}) as acdt_cl_cd_nm
	</select>
	
	<!-- 수신처 부서 목록 조회 -->
	<select id="selectAcdtRecvMgntRcvDeptList" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtRecvMgntRcvDeptList */
		select #{cmpy_cd} as cmpy_cd
			  ,a.wkpl_id 
	          ,a.acdt_cl_cd
	  		  ,a.eml_rcv_tp_cd
	  		  ,a.eml_rcv_sn
	  		  ,a.eml_dstn_cl_cd
	 	      ,a.eml_dstn_id
	 	      ,fn_get_dept(a.eml_dstn_id) as eml_dstn_nm
		  from tb_sh_acdt_news_dstn a
		 where a.eml_rcv_tp_cd = 'TO'
		   and a.eml_dstn_cl_cd = 'D'
		   and a.wkpl_id = #{wkpl_id}
	       and a.acdt_cl_cd = #{acdt_cl_cd}
	     order by a.eml_rcv_sn
	</select>

	<!-- 수신처 인원 목록 조회 -->
	<select id="selectAcdtRecvMgntRcvEmpList" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtRecvMgntRcvEmpList */
		select #{cmpy_cd} as cmpy_cd
			  ,a.wkpl_id
	          ,a.acdt_cl_cd
	  		  ,a.eml_rcv_tp_cd
	  		  ,a.eml_rcv_sn
	  		  ,a.eml_dstn_cl_cd
	 	      ,a.eml_dstn_id
	 	      ,b.dept_nm || ' ' || fn_get_user(a.eml_dstn_id, 'NM', #{SESS_LANG_CD}) as eml_dstn_nm
		  from tb_sh_acdt_news_dstn a
		 inner join (select tcu.usr_id
						   ,tcu.dept_cd
						   ,(select case when #{SESS_LANG_CD} = 'KO' then tcd.dept_ko_nm
									     else tcd.dept_en_nm
									 end as dept_nm
							   from tb_co_dept tcd
							  where tcd.dept_cd = tcu.dept_cd 
							) as dept_nm
		       		   from tb_co_user tcu
		       		  where tcu.usg_yn = 'Y'
						and tcu.del_yn  = 'N'
					) b
		         on a.eml_dstn_id = b.usr_id
		 where a.eml_rcv_tp_cd = 'TO'
		   and a.eml_dstn_cl_cd = 'E'
		   and a.wkpl_id = #{wkpl_id}
	       and a.acdt_cl_cd = #{acdt_cl_cd}
	     order by a.eml_rcv_sn
	</select>

	<!-- 참조처 부서 목록 조회 -->
	<select id="selectAcdtRecvMgntRefDeptList" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtRecvMgntRefDeptList */
		select #{cmpy_cd} as cmpy_cd
			  ,a.wkpl_id 
	          ,a.acdt_cl_cd
	  		  ,a.eml_rcv_tp_cd
	  		  ,a.eml_rcv_sn
	  		  ,a.eml_dstn_cl_cd
	 	      ,a.eml_dstn_id
	 	      ,fn_get_dept(a.eml_dstn_id) as eml_dstn_nm
		  from tb_sh_acdt_news_dstn a
		 where a.eml_rcv_tp_cd = 'CC'
		   and a.eml_dstn_cl_cd = 'D'
		   and a.wkpl_id = #{wkpl_id}
	       and a.acdt_cl_cd = #{acdt_cl_cd}
	     order by a.eml_rcv_sn
	</select>

	<!-- 참조처 인원 목록 조회 -->
	<select id="selectAcdtRecvMgntRefEmpList" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtRecvMgntRefEmpList */
		select #{cmpy_cd} as cmpy_cd
			  ,a.wkpl_id
	          ,a.acdt_cl_cd
	  		  ,a.eml_rcv_tp_cd
	  		  ,a.eml_rcv_sn
	  		  ,a.eml_dstn_cl_cd
	 	      ,a.eml_dstn_id
	 	      ,b.dept_nm || ' ' || fn_get_user(a.eml_dstn_id, 'NM', #{SESS_LANG_CD}) as eml_dstn_nm
		  from tb_sh_acdt_news_dstn a
		 inner join (select tcu.usr_id
						   ,tcu.dept_cd
						   ,(select case when #{SESS_LANG_CD} = 'KO' then tcd.dept_ko_nm
									     else tcd.dept_en_nm
									 end as dept_nm
							   from tb_co_dept tcd
							  where tcd.dept_cd = tcu.dept_cd 
							) as dept_nm
		       		   from tb_co_user tcu
		       		  where tcu.usg_yn = 'Y'
						and tcu.del_yn  = 'N'
					) b
		         on a.eml_dstn_id = b.usr_id
		 where a.eml_rcv_tp_cd = 'CC'
		   and a.eml_dstn_cl_cd = 'E'
		   and a.wkpl_id = #{wkpl_id}
	       and a.acdt_cl_cd = #{acdt_cl_cd}
	     order by a.eml_rcv_sn
	</select>

    <delete id="deleteAcdtRcv" parameterType="sqlMap">
        /* deleteAcdtRcv */
        delete from tb_sh_acdt_news_dstn
		 where wkpl_id = #{wkpl_id}
		   and acdt_cl_cd = #{acdt_cl_cd}
    </delete>
    
    <insert id="insertAcdtRcv" parameterType="sqlMap">
      	/* insertAcdtRcv */
      	insert into tb_sh_acdt_news_dstn (
			 wkpl_id
			,acdt_cl_cd
			,eml_rcv_tp_cd
			,eml_rcv_sn
			,eml_dstn_cl_cd
			,eml_dstn_id
			,crt_usr_id
			,crt_dt
			,upt_usr_id
			,upt_dt
		) values (
			 #{wkpl_id}
			,#{acdt_cl_cd}
			,#{eml_rcv_tp_cd}
			,#{sn}
		    ,#{eml_dstn_cl_cd}
			,#{eml_dstn_id}
			,#{SESS_USR_ID}
			,current_timestamp
			,#{SESS_USR_ID}
			,current_timestamp
		)
    </insert>

</mapper>