<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.ch.csttstat.mapper.CsttStatMapper">
	
	<!-- 규제 콤보 조회 -->
	<select id="selectRgltComboList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltComboList */
		select a.value
		      ,a.label
		      ,a.sort_seq
		  from (select rglt_no as value
				      ,rglt_nm as label
				      ,sort_seq 
				  from tb_ch_rglt 
				 where del_yn = 'N'
				   and usg_yn = 'Y'
				   and law_cd = #{law_cd}
			   ) a
		 order by a.sort_seq
	</select>
	
	<!-- 화학물질 현황 조회 -->
	<select id="selectRgltChkTotalList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltChkTotalList */
		select ms.wkpl_id 
		      ,ml1.mlang_cntn as wkpl_nm
		      ,mt.macl_cd 
		      ,ml2.mlang_cntn as macl_nm
		      ,mt.mtrl_no 
		      ,coalesce(mt.mtrl_ko_nm, mt.mtrl_en_nm) as mtrl_nm
		      ,mv.vndr_no
		      ,vd.vndr_nm 
		      ,mt.impt_yn 
		      ,mt.mtrl_puse_cd 
		      ,ml3.mlang_cntn as mtrl_puse_nm
		      ,mt.mtrl_puse_cntn
		      ,dd.wrk_center_cd
		      ,ml4.mlang_cntn as wrk_center_nm
		      ,coalesce (mb.sbst_ko_nm, mb.sbst_en_nm) as sbst_nm
		      ,mb.cas_no 
		      ,mb.sbst_rati
		      ,dd.use_qty
		      ,coalesce(rg.rglt01_yn,'N') as rglt01_yn 
		      ,coalesce(rg.rglt02_yn,'N') as rglt02_yn
		      ,coalesce(rg.rglt03_yn,'N') as rglt03_yn
		      ,coalesce(rg.rglt04_yn,'N') as rglt04_yn
		      ,coalesce(rg.rglt05_yn,'N') as rglt05_yn
		      ,coalesce(rg.rglt06_yn,'N') as rglt06_yn
		      ,coalesce(rg.rglt07_yn,'N') as rglt07_yn
		      ,coalesce(rg.rglt08_yn,'N') as rglt08_yn
		      ,coalesce(rg.rglt09_yn,'N') as rglt09_yn
		      ,coalesce(rg.rglt10_yn,'N') as rglt10_yn
		      ,coalesce(rg.rglt12_yn,'N') as rglt12_yn
		      ,coalesce(rg.rglt13_yn,'N') as rglt13_yn
		      ,coalesce(rg.rglt14_yn,'N') as rglt14_yn
		      ,coalesce(rg.rglt15_yn,'N') as rglt15_yn
		      ,coalesce(rg.rglt16_yn,'N') as rglt16_yn
		      ,coalesce(rg.rglt17_yn,'N') as rglt17_yn
		      ,coalesce(rg.rglt11_yn,'N') as rglt11_yn
		      ,coalesce(rg.rglt18_yn,'N') as rglt18_yn
		      ,coalesce(rg.rglt19_yn,'N') as rglt19_yn
		      ,coalesce(rg.rglt20_yn,'N') as rglt20_yn
		      ,mt.mtrl_fspt_vl
		  from tb_co_mtrl mt
		  join tb_ch_mtrl_sbst mb on mt.mtrl_no = mb.mtrl_no and mb.usg_yn = 'Y' and mb.del_yn = 'N'
		  join tb_co_mtrl_site ms on mt.mtrl_no = ms.mtrl_no and ms.del_yn = 'N'
		  left outer join tb_co_mtrl_vndr mv on mt.mtrl_no = mv.mtrl_no and mv.del_yn = 'N'
		  left outer join tb_co_vndr vd on mv.vndr_no = vd.vndr_no and mt.mtrl_clsf_cd = vd.vndr_clsf_cd
		  left outer join tb_co_mlang ml1 on ms.wkpl_id = ml1.cd and ml1.cd_grp_no = 'CO00000006' and ml1.lang_cd = #{SESS_LANG}
		  left outer join tb_co_mlang ml2 on mt.macl_cd = ml2.cd and ml2.cd_grp_no = 'CH00000006' and ml2.lang_cd = #{SESS_LANG}
		  left outer join tb_co_mlang ml3 on mt.mtrl_puse_cd = ml3.cd and ml3.cd_grp_no = 'CO00000018' and ml3.lang_cd = #{SESS_LANG}
	      left outer join (select dm.mtrl_no 
                        , dm.sbst_no  
                        , dm.wkpl_id 
                        , dm.wrk_area_cd as wrk_center_cd
                        , sum(dm.dl_qty) as use_qty 
                     from tb_ch_sbst_dl_dd dm  
                    where (dm.dl_ya between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.dl_ya is null or dm.dl_ya = '')
                      and dm.mtrl_no like '6%'
                    group by dm.mtrl_no 
                           , dm.sbst_no  
                           , dm.wkpl_id  
                           , dm.wrk_area_cd 
                    union 
                    select wm.mtrl_no
                        , wm.sbst_no
                        , wm.wkpl_id
                        , wm.wrk_area_cd as wrk_center_cd
                        , sum(wm.wh_qty) as use_qty
                     from tb_ch_sbst_wh_dd wm
                    where (wm.wh_da between replace(#{sDate},'-','') and replace(#{eDate},'-','') or wm.wh_da is null or wm.wh_da = '')
                      and wm.mtrl_no like 'M%'
                    group by wm.mtrl_no
                           , wm.sbst_no
                           , wm.wkpl_id
                           , wm.wrk_area_cd
                  ) dd on mt.mtrl_no = dd.mtrl_no and mb.sbst_no = dd.sbst_no and ms.wkpl_id = dd.wkpl_id 
          left outer join tb_co_mlang ml4 on dd.wrk_center_cd = ml4.cd and ml4.cd_grp_no = 'CH00000023' and ml4.lang_cd = #{SESS_LANG}                     
		  left outer join (
		                    select rs.mtrl_no
		                          ,max(case when rs.rglt_no = 'RGLT000001' then 'Y' else 'N' end) as rglt01_yn
		                          ,max(case when rs.rglt_no = 'RGLT000002' then 'Y' else 'N' end) as rglt02_yn
		                          ,max(case when rs.rglt_no = 'RGLT000003' then 'Y' else 'N' end) as rglt03_yn
		                          ,max(case when rs.rglt_no = 'RGLT000004' then 'Y' else 'N' end) as rglt04_yn
		                          ,max(case when rs.rglt_no = 'RGLT000005' then 'Y' else 'N' end) as rglt05_yn
		                          ,max(case when rs.rglt_no = 'RGLT000006' then 'Y' else 'N' end) as rglt06_yn
		                          ,max(case when rs.rglt_no = 'RGLT000007' then 'Y' else 'N' end) as rglt07_yn
		                          ,max(case when rs.rglt_no = 'RGLT000008' then 'Y' else 'N' end) as rglt08_yn
		                          ,max(case when rs.rglt_no = 'RGLT000009' then 'Y' else 'N' end) as rglt09_yn
		                          ,max(case when rs.rglt_no = 'RGLT000010' then 'Y' else 'N' end) as rglt10_yn
		                          ,max(case when rs.rglt_no = 'RGLT000012' then 'Y' else 'N' end) as rglt12_yn
		                          ,max(case when rs.rglt_no = 'RGLT000013' then 'Y' else 'N' end) as rglt13_yn
		                          ,max(case when rs.rglt_no = 'RGLT000014' then 'Y' else 'N' end) as rglt14_yn
		                          ,max(case when rs.rglt_no = 'RGLT000015' then 'Y' else 'N' end) as rglt15_yn
		                          ,max(case when rs.rglt_no = 'RGLT000016' then 'Y' else 'N' end) as rglt16_yn
		                          ,max(case when rs.rglt_no = 'RGLT000017' then 'Y' else 'N' end) as rglt17_yn
		                          ,max(case when rs.rglt_no = 'RGLT000011' then 'Y' else 'N' end) as rglt11_yn
		                          ,max(case when rs.rglt_no = 'RGLT000018' then 'Y' else 'N' end) as rglt18_yn
		                          ,max(case when rs.rglt_no = 'RGLT000019' then 'Y' else 'N' end) as rglt19_yn
		                          ,max(case when rs.rglt_no = 'RGLT000020' then 'Y' else 'N' end) as rglt20_yn
		                      from tb_ch_mtrl_rglt rs
		                     where rs.del_yn = 'N'
		                       and rs.usg_yn = 'Y'
		                       and rs.rglt_obj_yn = 'Y'
		                     group by rs.mtrl_no
		                  ) rg on mt.mtrl_no = rg.mtrl_no
		 where mt.rglt_chk_yn = 'Y'
		   and dd.use_qty is not null
		   and dd.use_qty != 0
		   and mt.usg_yn = 'Y'
		   and mt.del_yn = 'N'
		 <if test='wkpl_id != null and wkpl_id != ""'>
		   and ms.wkpl_id = #{wkpl_id}
		 </if>
 		 <if test='mtrl_clsf_cd != null and mtrl_clsf_cd != ""'>
		   and mt.mtrl_clsf_cd = #{mtrl_clsf_cd}
		 </if>
 		 <if test='macl_cd != null and macl_cd != ""'>
		   and mt.macl_cd = #{macl_cd}
		 </if>
 		 <if test='"under".equals(mtrl_fspt_vl_cd)'>
		   and mt.mtrl_fspt_vl <![CDATA[<=]]> 60
		 </if>
 		 <if test='"over".equals(mtrl_fspt_vl_cd)'>
		   and mt.mtrl_fspt_vl > 60
		 </if>
		 <if test='rgltSelect != null and rgltSelect != ""'>
		   and (${RGLT_OBJ})
		 </if>
		 <if test='RGLT_LIST != null and RGLT_LIST.size != 0'>
		 	and mt.dngr_kind_cd in 
		 	<foreach collection='RGLT_LIST' item="item" index="index" open="(" close=")" separator=",">
		 		#{item}
		 	</foreach>
		 </if>
		 <if test='RGLT_DTL_LIST != null and RGLT_DTL_LIST.size != 0'>
		 	and mt.dngr_dtl_kind_cd in 
		 	<foreach collection='RGLT_DTL_LIST' item="item" index="index" open="(" close=")" separator=",">
		 		#{item}
		 	</foreach>
		 </if>
		 order by mt.mtrl_no
	</select>
	
	<!-- 화학물질 통계조사 제품정보 조회 -->
	<select id="selectStatReschListTab1" parameterType="sqlMap" resultType="sqlMap">
	    /* selectStatReschListTab1 */
		select mt.mtrl_no                                                       -- 자재코드
	      ,case when mt.macl_cd = 'MTN' then '3'
	            when mt.macl_cd = 'IIP' then '2'
	            else '2'
	       end as mtrl_clsf                                                 -- 제품구분
	      ,coalesce (mt.mtrl_ko_nm, mt.mtrl_en_nm) as mtrl_nm               -- 제품명
	      ,replace(mt.mtrl_puse_cd,'U','') as mtrl_puse                     -- 용도
	      ,mt.mtrl_puse_cntn                                                -- 기타 용도
	      ,case when mss.sbst_cnt > 1 then '2' else '1' end as mtrl_cmp     -- 제품구성
	      ,mt.phase_cd                                                      -- 제품형태
	      ,case when mt.pchs_unit_cd is null and mt.mtrl_clsf_cd = '1' then '2' end as mtrl_unit -- 단위
	      ,null as wh01                                                     -- 입고량 제조
	      ,null as wh02                                                     -- 입고량 수입
	      ,wh.wh_qty as wh03                                                -- 입고량 구매
	      ,null as wh04                                                     -- 입고량 이월
	      ,dd.dl_qty as dl01                                                -- 출고량 사용
	      ,null as dl02                                                     -- 출고량 판매
	      ,null as dl03                                                     -- 출고량 수출
	      ,null as dl04                                                     -- 출고량 재고
	      ,null as nn01                                                     -- 나노물질 포함여부 제조
	      ,null as nn02                                                     -- 나노물질 포함여부 수입
	      ,null as nn03                                                     -- 나노물질 포함여부 해당없음
	      ,null as nn04                                                     -- 나노물질 포함여부 모름
	      ,fn_get_user(mt.mtrl_reg_usr_id,'NM',#{SESS_LANG}) as user_nm             -- 담당자
	      ,null as wh_yn                                                    -- 보관시설(창고) 시설현황 유/무
	      ,null as wh_max_qty                                               -- 보관시설(창고) 시설현황 최대 보관, 저장량(톤)
	      ,null as wh_tank_yn                                               -- 보관시설(탱크) 시설현황 유/무
	      ,null as wh_tank_max_qty                                          -- 보관시설(탱크) 시설현황 최대 보관, 저장량(톤)
	      ,null as equip_yn                                                 -- 제조,사용 시설 현황 유무
	  from tb_co_mtrl mt
	  left outer join (select ms.mtrl_no, count(*) as sbst_cnt from tb_ch_mtrl_sbst ms group by ms.mtrl_no) mss on mss.mtrl_no = mt.mtrl_no
	  left outer join (select dm.mtrl_no
	                        , sum(dm.dl_qty)/1000 as dl_qty
	                     from tb_ch_mtrl_dl_dd dm 
	                    where (dm.dl_ya between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.dl_ya is null or dm.dl_ya = '')
	                     <if test='wkpl_id != null and wkpl_id != ""'>
						   and dm.wkpl_id = #{wkpl_id}
						 </if>
	                    group by dm.mtrl_no
	                  ) dd on mt.mtrl_no = dd.mtrl_no 
	  left outer join (select dw.mtrl_no
	                        , sum(dw.wh_qty)/1000 as wh_qty
	                     from tb_ch_mtrl_wh_dd dw 
	                    where (dw.wh_da between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dw.wh_da is null or dw.wh_da = '')
             	         <if test='wkpl_id != null and wkpl_id != ""'>
						   and dw.wkpl_id = #{wkpl_id}
						 </if>
	                    group by dw.mtrl_no
	                  ) wh on mt.mtrl_no = wh.mtrl_no 
	 where mt.rglt_chk_yn = 'Y'
	   and mt.usg_yn = 'Y'
	   and mt.del_yn = 'N'
	   and exists (select 1 
	                 from tb_co_mtrl_site ms 
	                where mt.mtrl_no = ms.mtrl_no 
	                     <if test='wkpl_id != null and wkpl_id != ""'>
						   and ms.wkpl_id = #{wkpl_id}
						 </if>
	              )
		<if test='mtrl_clsf_cd != null and mtrl_clsf_cd != ""'>
		   and mt.mtrl_clsf_cd = #{mtrl_clsf_cd}
		</if>	              
	</select>
	
	<!-- 화학물질 통계조사 구성성분정보 조회 -->
	<select id="selectStatReschListTab2" parameterType="sqlMap" resultType="sqlMap">
		select mt.mtrl_no                                                       	-- 자재코드
		      ,ms.cas_no                                                        	-- cas_no
		      ,coalesce (sb.sbst_ko_nm,sb.sbst_en_nm) as sbst_nm                	-- 물질명
		      ,sb.ke_no                                                         	-- 고유번호(KE번호)
		      ,ms.sbst_rati                                                     	-- 순도 및 함량
		      ,null as make_clsf                                                	-- 제조구분
		      ,case when sbc.sbst_cnt is null then 'Y' else 'N' end as no_sbst_yn	-- 성분정보 없음
		      ,fn_get_user(mt.mtrl_reg_usr_id,'NM',#{SESS_LANG}) as user_nm             	-- 담당자
		  from tb_co_mtrl mt
		  left outer join tb_ch_mtrl_sbst ms on mt.mtrl_no = ms.mtrl_no
		  left outer join (select ms.mtrl_no, count(*) as sbst_cnt from tb_ch_mtrl_sbst ms group by ms.mtrl_no) sbc on mt.mtrl_no = sbc.mtrl_no
		  left outer join tb_ch_sbst sb on ms.sbst_no = sb.sbst_no
 		  left outer join (select dm.mtrl_no
                     		 from tb_ch_mtrl_dl_dd dm 
                    		where (dm.dl_ya between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.dl_ya is null or dm.dl_ya = '')
	                     <if test='wkpl_id != null and wkpl_id != ""'>
						   and dm.wkpl_id = #{wkpl_id}
						 </if>
                    	 group by dm.mtrl_no
                  		   ) dd on mt.mtrl_no = dd.mtrl_no 
 		  left outer join (select dw.mtrl_no
		                     from tb_ch_mtrl_wh_dd dw 
		                    where (dw.wh_da between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dw.wh_da is null or dw.wh_da = '')
		                 <if test='wkpl_id != null and wkpl_id != ""'>
						   and dw.wkpl_id = #{wkpl_id}
						 </if>
		                 group by dw.mtrl_no
                  		  ) wh on mt.mtrl_no = wh.mtrl_no 
		 where mt.rglt_chk_yn = 'Y'
		   and mt.usg_yn = 'Y'
		   and mt.del_yn = 'N'
		   and exists (select 1 
		                 from tb_co_mtrl_site ms 
		   				where mt.mtrl_no = ms.mtrl_no
  				     <if test='wkpl_id != null and wkpl_id != ""'>
						  and ms.wkpl_id = #{wkpl_id}
					 </if>
		   			  )
		<if test='mtrl_clsf_cd != null and mtrl_clsf_cd != ""'>
		   and mt.mtrl_clsf_cd = #{mtrl_clsf_cd}
		</if>			   			  
	</select>
	
	<!-- 화학물질 베출량조사 조회 -->
	<select id="selectChemsSqtRreschList" parameterType="sqlMap" resultType="sqlMap">
		select ms.wkpl_id
		     , fn_get_cd('CO00000006', ms.wkpl_id,'NM',#{SESS_LANG}) as wkpl_nm	-- 사업장	
		     , mt.mtrl_no						-- 자재코드
		     , case when length(mt.mtrl_ko_nm) = 0 then mt.mtrl_en_nm else mt.mtrl_ko_nm end as mtrl_nm	-- 자재명
		     , mt.macl_cd
		     , fn_get_cd('CH00000006',mt.macl_cd,'NM',#{SESS_LANG}) as macl_nm		-- 용도
		     , mt.mtrl_puse_cd
		     , fn_get_cd('CO00000018',mt.mtrl_puse_cd,'NM',#{SESS_LANG}) as mtrl_puse_nm 	-- 세부용도
		     , mt.mtrl_puse_cntn 
		     , coalesce (sbb.sbst_ko_nm,sbb.sbst_en_nm) as sbst_nm 		-- 물질명
		     , sbb.cas_no							-- CAS NO
		     , sb.sbst_rati							-- 함량
		     , to_char(round(coalesce (da.mtrl_use_qty, db.mtrl_use_qty)/1000,2),'FM999,999,999,999,990.90') as mtrl_use_qty -- 자재사용량
		     , to_char(round(coalesce (coalesce (dd.use_qty,de.use_qty),0)/1000,2),'FM999,999,999,999,990.90') as use_qty	-- 물징사용량
		     , case when coalesce (coalesce (df.sb_use_qty,dg.sb_use_qty),0)/1000 >= 1000 then fn_get_cd('CH00000029', '1','NM',#{SESS_LANG}) 
		            when coalesce (coalesce (df.sb_use_qty,dg.sb_use_qty),0)/1000 >= 10000 then fn_get_cd('CH00000029', '2','NM',#{SESS_LANG})
		       end as group_nm
		  from tb_ch_mtrl_sbst sb
		  join tb_ch_sbst sbb on sb.sbst_no = sbb.sbst_no 
		  join tb_co_mtrl mt on mt.mtrl_no = sb.mtrl_no
		  join tb_co_mtrl_site ms on mt.mtrl_no = ms.mtrl_no
		  left outer join (select dm.mtrl_no
		                        , dm.wkpl_id 
		                        , sum(dm.dl_qty)::numeric(15,2) as mtrl_use_qty
		                     from tb_ch_mtrl_dl_dd dm 
		                    where (dm.dl_ya between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.dl_ya is null or dm.dl_ya = '')
		                 <if test='wkpl_id != null and wkpl_id != ""'>
						  	  and dm.wkpl_id = #{wkpl_id}
					 	 </if>
		                      and dm.mtrl_no like '6%'
		                      and exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and dm.mtrl_no = rs.mtrl_no)
		                    group by dm.mtrl_no
		                            ,dm.wkpl_id 
		                  ) da on mt.mtrl_no = da.mtrl_no and ms.wkpl_id = da.wkpl_id
		  left outer join (select dw.mtrl_no
		                        , dw.wkpl_id
		                        , sum(dw.wh_qty)::numeric(15,2) as mtrl_use_qty
		                     from tb_ch_mtrl_wh_dd dw 
		                    where (dw.wh_da between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dw.wh_da is null or dw.wh_da = '')
		                 <if test='wkpl_id != null and wkpl_id != ""'>
						  	  and dw.wkpl_id = #{wkpl_id}
					 	 </if>		                    
		                      and dw.mtrl_no like 'M%'
		                      and exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and dw.mtrl_no = rs.mtrl_no)
		                    group by dw.mtrl_no
		                            ,dw.wkpl_id 
		                  ) db on mt.mtrl_no = db.mtrl_no and ms.wkpl_id = db.wkpl_id
		  left outer join (select dm.mtrl_no
		                        , dm.sbst_no
		                        , dm.wkpl_id
		                        , sum(dm.dl_qty)::numeric(15,2) as use_qty
		                     from tb_ch_sbst_dl_dd dm 
		                    where (dm.dl_ya between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.dl_ya is null or dm.dl_ya = '')
		                 <if test='wkpl_id != null and wkpl_id != ""'>
						  	  and dm.wkpl_id = #{wkpl_id}
					 	 </if>			                    
		                      and dm.mtrl_no like '6%'
		                      and exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and dm.mtrl_no = rs.mtrl_no and dm.sbst_no = rs.sbst_no)
		                    group by dm.mtrl_no
		                           , dm.sbst_no 
		                           , dm.wkpl_id 
		                  ) dd on sb.mtrl_no = dd.mtrl_no and sb.sbst_no = dd.sbst_no and ms.wkpl_id = dd.wkpl_id
		  left outer join (select dm.mtrl_no
		                        , dm.sbst_no
		                        , dm.wkpl_id
		                        , sum(dm.wh_qty)::numeric(15,2) as use_qty
		                     from tb_ch_sbst_wh_dd dm 
		                    where (dm.wh_da between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.wh_da is null or dm.wh_da = '')
		                 <if test='wkpl_id != null and wkpl_id != ""'>
						  	  and dm.wkpl_id = #{wkpl_id}
					 	 </if>				                    
		                      and dm.mtrl_no like 'M%'
		                      and exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and dm.mtrl_no = rs.mtrl_no and dm.sbst_no = rs.sbst_no)
		                    group by dm.mtrl_no
		                           , dm.sbst_no 
		                           , dm.wkpl_id 
		                  ) de on sb.mtrl_no = de.mtrl_no and sb.sbst_no = de.sbst_no and ms.wkpl_id = de.wkpl_id
		  left outer join (select dm.sbst_no
		                        , sum(dm.dl_qty)::numeric(15,2) as sb_use_qty
		                     from tb_ch_sbst_dl_dd dm 
		                    where (dm.dl_ya between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.dl_ya is null or dm.dl_ya = '')
		                      and dm.mtrl_no like '6%'
		                      and exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and dm.mtrl_no = rs.mtrl_no and dm.sbst_no = rs.sbst_no)
		                    group by dm.sbst_no
		                  ) df on sb.sbst_no = df.sbst_no
		  left outer join (select dm.sbst_no
		                        , sum(dm.wh_qty)::numeric(15,2) as sb_use_qty
		                     from tb_ch_sbst_wh_dd dm 
		                    where (dm.wh_da between replace(#{sDate},'-','') and replace(#{eDate},'-','') or dm.wh_da is null or dm.wh_da = '')
		                      and dm.mtrl_no like 'M%'
		                      and exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and dm.mtrl_no = rs.mtrl_no and dm.sbst_no = rs.sbst_no)
		                    group by dm.sbst_no 
		                  ) dg on sb.sbst_no = dg.sbst_no
		where exists (select 1 from tb_ch_mtrl_rglt_sbst rs where rs.rglt_no = 'RGLT000003' and mt.mtrl_no = rs.mtrl_no and sb.sbst_no = rs.sbst_no)
		<if test='wkpl_id != null and wkpl_id != ""'>
		  and ms.wkpl_id = #{wkpl_id}
		</if>
		<if test='mtrl_clsf_cd != null and mtrl_clsf_cd != ""'>
		  and mt.mtrl_clsf_cd = #{mtrl_clsf_cd}
		</if>	    
	</select>
	
</mapper>