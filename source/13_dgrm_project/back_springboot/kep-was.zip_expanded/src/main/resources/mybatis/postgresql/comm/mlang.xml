<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.common.chems.mapper.MlangMapper">

	<select id="selectMlangList" parameterType="sqlMap" resultType="sqlMap">
		/* selectMlangList */
		select
			ROW_NUMBER() OVER(order by tcm.upt_dt desc) AS rownum,
			tcm.mlang_no ,
			tcm.lang_cd ,
			tcm.mlang_type_cd ,
			tcm.biz_cd ,
			tcm.mlang_cntn ,
			tcm.mlang_abbr ,
			tcm.role_no ,
			tcm.menu_no ,
			tcm.cd_grp_no ,
			tcm.cd ,
			tcm.usg_yn ,
			tcm.del_yn ,
			tcm.crt_usr_id ,
			tcm.crt_dt ,
			tcm.upt_usr_id ,
			case when #{SESS_LANG} = 'KO' then (select tce.usr_ko_nm from tb_co_user tce where tce.usr_id = tcm.upt_usr_id) 
				 when #{SESS_LANG} = 'EN' then (select tce.usr_en_nm from tb_co_user tce where tce.usr_id = tcm.upt_usr_id) 		  
				 else (select tce.usr_zh_nm from tb_co_user tce where tce.usr_id = tcm.upt_usr_id) 
			end as usr_nm
			,fn_get_time(tcm.upt_dt, #{SESS_TIME_ZONE},'DA', '-') as upt_dt
		    ,fn_get_time(tcm.upt_dt, #{SESS_TIME_ZONE},'TS', ':') as upt_tm
		from
			tb_co_mlang tcm
		where
			1 = 1
		and del_yn = 'N'
		<if test='mlang_type_cd != null and mlang_type_cd != ""'>
			and tcm.mlang_type_cd = #{mlang_type_cd}
		</if>
		<if test='biz_cd != null and biz_cd != ""'>
			and tcm.biz_cd = #{biz_cd}
		</if>
		<if test='mlang_cntn != null and mlang_cntn != ""'>
			and tcm.mlang_cntn like concat('%', trim(#{mlang_cntn}), '%')
		</if>	
		<if test='lang_cd != null and lang_cd != ""'>
			and tcm.lang_cd = #{lang_cd}
		</if>	
		<if test='usg_yn != null and usg_yn != ""'>
			and tcm.usg_yn = #{usg_yn}
		</if>
		<if test='mlang_no != null and mlang_no != ""'>
			and tcm.mlang_no = #{mlang_no}
		</if>	
		<if test='role_no != null and role_no != ""'>
			and tcm.role_no = #{role_no}
		</if>
		<if test='menu_no != null and menu_no != ""'>
			and tcm.menu_no = #{menu_no}
		</if>
		<if test='cd_grp_no != null and cd_grp_no != ""'>
			and tcm.cd_grp_no = #{cd_grp_no}
		</if>
		<if test='cd != null and cd != ""'>
			and tcm.cd = #{cd}
		</if>
		order by tcm.upt_dt desc
	</select>
	
	<select id="selectMlangkey" parameterType="sqlMap" resultType="string">
		/* selectMlangkey */
		select concat(#{mlang_type_cd},coalesce(lpad((max(substring(mlang_no, 3, 8)::integer) + 1)::text, 8, '0'),'00000001')) as key
		from tb_co_mlang 
		where mlang_type_cd = #{mlang_type_cd}
	</select>
	
	<insert id="insertMlangList" parameterType="sqlMap">
	   /* insertMlangList */
      insert into tb_co_mlang
		(
		             mlang_no 
		        	,lang_cd 
		        	,mlang_type_cd 
		        	,biz_cd
		        	,mlang_cntn
		        	,mlang_abbr 
		        	,role_no 
		        	,menu_no 
		        	,cd_grp_no 
		        	,cd 
		        	,usg_yn 
		        	,del_yn 
		        	,crt_usr_id 
					,crt_dt 
					,upt_usr_id 
					,upt_dt 
		) select * from (
				select a.mlang_no 
		        	,b.lang_cd 
		        	,a.mlang_type_cd 
		        	,a.biz_cd
		        	,case when b.lang_cd = #{lang_cd} then a.mlang_cntn else a.mlang_cntn || '(' || b.lang_cd || ')' end as mlang_cntn
		        	,case when b.lang_cd = #{lang_cd} then a.mlang_abbr else a.mlang_abbr || '(' || b.lang_cd || ')' end as mlang_abbr
		        	,a.role_no 
		        	,a.menu_no 
		        	,a.cd_grp_no 
		        	,a.cd 
		        	,a.usg_yn 
		        	,a.del_yn 
		        	,#{SESS_USR_ID} as crt_usr_id 
					,to_char(now(), 'YYYYMMDDHH24MISS') as crt_dt 
					,#{SESS_USR_ID} as upt_usr_id 
					,to_char(now(), 'YYYYMMDDHH24MISS') as upt_dt 
		        from 
		        	(
		        		select 
							#{mlang_no} as mlang_no
							,#{mlang_type_cd} as mlang_type_cd
							,#{biz_cd} as biz_cd
							,trim(#{mlang_cntn}) as mlang_cntn
							,#{mlang_abbr} as mlang_abbr
							,#{role_no} as role_no
							,#{menu_no} as menu_no
							,#{cd_grp_no} as cd_grp_no
							,#{cd} as cd
							,#{usg_yn} as usg_yn
							,'N' as del_yn
					) a
					,(
						select cd as lang_cd  
						from tb_co_cd cd 
						where cd.cd_grp_no = 'CO00000002'
					) b
		) as A
    </insert>
    
    
    
    <update id="updateMlangList" parameterType="sqlMap">
        /* updateMlangList */
        update tb_co_mlang set
        	biz_cd = #{biz_cd}
        	,mlang_cntn = trim(#{mlang_cntn})
        	,mlang_abbr = #{mlang_abbr}
        	,usg_yn = #{usg_yn}
        	,upt_usr_id = #{SESS_USR_ID}
        	,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS')
        where mlang_no = #{mlang_no}
        and  lang_cd = #{lang_cd}
    </update>
    
    <update id="deleteMlangList" parameterType="sqlMap">
        /* deleteMlangList */
        update tb_co_mlang set
        	del_yn = 'Y'
        	,usg_yn = 'N'
        	,upt_usr_id = #{SESS_USR_ID}
        	,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS')
        where mlang_no = #{mlang_no}
    </update>
	
	<update id="updateRoleMlangList" parameterType="sqlMap">
        /* updateRoleMlangList */
        update tb_co_mlang set
        	biz_cd = #{biz_cd}
        	,mlang_cntn = case when #{SESS_LANG} = lang_cd	then trim(#{mlang_cntn})
        					   else mlang_cntn
        	 			   end
        	,mlang_abbr = case when #{SESS_LANG} = lang_cd	then #{mlang_abbr}
        					   else mlang_abbr
        	 			   end
        	,upt_usr_id = #{SESS_USR_ID}
        	,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS')
        where role_no = #{role_no}
    </update>
	
	<select id="selectMlangInfo" parameterType="sqlMap" resultType="string">
		/* selectMlangInfo */
		select mlang_cntn 
		from tb_co_mlang tcm 
		where usg_yn = 'Y'
		  and del_yn = 'N'
		  and mlang_no = #{mlang_no}
		  and lang_cd = #{lang_cd}
	</select>
	
	<select id="selectMlangListInfo" parameterType="sqlMap" resultType="sqlMap">
		/* selectMlangListInfo */
		select mlang_no
		      ,mlang_cntn 
		from tb_co_mlang tcm 
		where usg_yn = 'Y'
		  and del_yn = 'N'
		  and mlang_no in
		  <foreach item="data" collection="mlang_no"
      		open="(" separator="," close=")">
		   #{data}::text
		  </foreach>
		  and lang_cd = #{lang_cd}::text
	</select>

</mapper>