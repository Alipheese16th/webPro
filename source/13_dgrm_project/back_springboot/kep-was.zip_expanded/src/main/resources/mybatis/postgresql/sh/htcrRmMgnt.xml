<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.htcrrm.mapper.HtcrRmMgntMapper">

	<select id="selectHtcrRmList" parameterType="sqlMap" resultType="sqlMap">
		/* selectHtcrRmList */
		select 
			hlth_maof_usg_no
			,substring(hlth_maof_usg_dt, 0, 5) || '-' || substring(hlth_maof_usg_dt, 5, 2) || '-' || substring(hlth_maof_usg_dt, 7, 2) as hlth_maof_usg_dt
		    ,hlth_maof_user_id
			,wkpl_id
			,fn_get_cd('ST00000002', wkpl_id, 'NM', #{SESS_LANG}) as wkpl_nm
			,fn_get_cmpy(wkpl_id, 'NM', #{SESS_LANG}) as cmpy_nm
		    ,user_blng_bsen_cl_cd
		    ,fn_get_cd('SH00000054', user_blng_bsen_cl_cd, 'NM', #{SESS_LANG}) as user_blng_bsen_cl_nm
		    ,hlth_maof_user_org_cd
		    ,engl_org_nm
		    ,org_nm
		    ,substring(hlth_maof_user_nm, 1, 1) || '*' || substring(hlth_maof_user_nm, 3) as hlth_maof_user_nm
		    ,substring(engl_hlth_maof_user_nm, 1, 1) || '*' || substring(engl_hlth_maof_user_nm, 3) as engl_hlth_maof_user_nm
		    ,fn_get_cd('SH00000039', hlth_maof_actn_cl_cd, 'NM', #{SESS_LANG}) as hlth_maof_actn_cl_nm
		    ,hlth_maof_actn_cl_cd
		    ,user_symp_cat_cd
		    ,fn_get_cd('SH00000040', user_symp_cat_cd, 'NM', #{SESS_LANG}) as user_symp_cat_nm
		    ,user_symp_cd
		    ,fn_get_cd('SH00000041', user_symp_cd, 'NM', #{SESS_LANG}) as user_symp_nm
		    ,hspt_care_yn 
		    ,symp_dtl_txt
		    ,symp_note_txt
		from tb_sh_hlth_maof shm
		where hlth_maof_usg_dt between replace(#{sDate}, '-', '') and replace(#{eDate}, '-', '')
		<if test='wkpl_id != null and wkpl_id != ""'>
			and wkpl_id = #{wkpl_id}
		</if>
		<if test='user_blng_bsen_cl_cd != null and user_blng_bsen_cl_cd != ""'>
			and user_blng_bsen_cl_cd = #{user_blng_bsen_cl_cd}
		</if>
		<if test='hlth_maof_actn_cl_cd != null and hlth_maof_actn_cl_cd != ""'>
			and hlth_maof_actn_cl_cd = #{hlth_maof_actn_cl_cd}
		</if>
		<if test='user_symp_cat_cd != null and user_symp_cat_cd != ""'>
			and user_symp_cat_cd = #{user_symp_cat_cd}
		</if>
		<if test='org_nm != null and org_nm != ""'>
			and org_nm like '%' || #{org_nm} || '%'
		</if>
		<if test='cmpy_cd != null and cmpy_cd != ""'>
		   and exists (select 1
		      			 from tb_sh_wkpl w
		      			where w.wkpl_id = shm.wkpl_id 
		      			  and w.cmpy_cd = #{cmpy_cd}
		   			  )
		 </if>
		order by hlth_maof_usg_no desc
	</select>
	
	<insert id="insertHtcrRm" parameterType="sqlMap">
      	/* insertHtcrRm */
		insert into tb_sh_hlth_maof (
			hlth_maof_usg_dt
		    ,hlth_maof_user_id
			,wkpl_id
		    ,user_blng_bsen_cl_cd
		    ,hlth_maof_user_org_cd
		    ,engl_org_nm
		    ,org_nm
		    ,hlth_maof_user_nm
		    ,engl_hlth_maof_user_nm
		    ,hlth_maof_actn_cl_cd
		    ,user_symp_cat_cd
		    ,user_symp_cd
		    ,hspt_care_yn 
		    ,symp_dtl_txt
		    ,symp_note_txt
			,crt_usr_id
			,upt_usr_id
		) values (
			replace(#{hlth_maof_usg_dt}, '-', '')
		    ,#{hlth_maof_user_id}
			,#{wkpl_id}
		    ,#{user_blng_bsen_cl_cd}
		    ,#{hlth_maof_user_org_cd}
		    ,#{engl_org_nm}
		    ,#{org_nm}
		    ,#{hlth_maof_user_nm}
		    ,#{engl_hlth_maof_user_nm}
		    ,#{hlth_maof_actn_cl_cd}
		    ,#{user_symp_cat_cd}
		    ,#{user_symp_cd}
		    ,#{hspt_care_yn}
		    ,#{symp_dtl_txt}
		    ,#{symp_note_txt}	
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		)
    </insert>
    
    <update id="updateHtcrRm" parameterType="sqlMap">
      	/* updateHtcrRm */
		update tb_sh_hlth_maof set
			wkpl_id					= #{wkpl_id}
			,hlth_maof_usg_dt			= replace(#{hlth_maof_usg_dt}, '-', '')
		    ,user_blng_bsen_cl_cd	= #{user_blng_bsen_cl_cd}
		    ,hlth_maof_user_org_cd		= #{hlth_maof_user_org_cd}
		    ,engl_org_nm				= #{engl_org_nm}
		    ,org_nm						= #{org_nm}
		    ,hlth_maof_user_nm			= #{hlth_maof_user_nm}
		    ,engl_hlth_maof_user_nm		= #{engl_hlth_maof_user_nm}
		    ,hlth_maof_actn_cl_cd	= #{hlth_maof_actn_cl_cd}
		    ,user_symp_cat_cd		= #{user_symp_cat_cd}
		    ,user_symp_cd			= #{user_symp_cd}
		    ,hspt_care_yn				= #{hspt_care_yn}
		    ,symp_dtl_txt				= #{symp_dtl_txt}
		    ,symp_note_txt				= #{symp_note_txt}	
			,crt_usr_id					= #{SESS_USR_ID}
			,upt_usr_id					= #{SESS_USR_ID}
		where hlth_maof_usg_no = #{hlth_maof_usg_no}::INTEGER
    </update>
    
    <delete id="deleteHtcrRm" parameterType="sqlMap">
        /* deleteHtcrRm */
        delete from tb_sh_hlth_maof
        where hlth_maof_usg_no = #{hlth_maof_usg_no}::INTEGER
    </delete>
</mapper>