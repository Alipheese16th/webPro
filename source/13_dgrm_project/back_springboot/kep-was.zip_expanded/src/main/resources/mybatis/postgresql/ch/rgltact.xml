<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.ch.rgltact.mapper.LncsMapper">

	<select id="selectLncsList" parameterType="sqlMap" resultType="sqlMap">
		/* selectLncsList */
		select 
			tcb.bbs_doc_no
			,tcb.bbs_doc_ttl
			,tcb.upt_usr_id
			,case when #{SESS_LANG} = 'KO' then (select tce.usr_ko_nm from tb_co_user tce where tce.usr_id = tcb.upt_usr_id) 
			      when #{SESS_LANG} = 'EN' then (select tce.usr_en_nm from tb_co_user tce where tce.usr_id = tcb.upt_usr_id) 					 
				  else (select tce.usr_zh_nm from tb_co_user tce where tce.usr_id = tcb.upt_usr_id) 
			end as usr_nm
			,fn_get_time(tcb.upt_dt, #{SESS_TIME_ZONE},'DA', '-') as upt_dt
		    ,fn_get_time(tcb.upt_dt, #{SESS_TIME_ZONE},'TS', ':') as upt_tm
			,tcb.noti_yn
			,tcb.bbs_type_cd
			,tcb.doc_type_cd
			,fn_get_cd('CO00000013',tcb.doc_type_cd,'NM',#{SESS_LANG}) as doc_type_cd_nm
			,tcb.bbs_doc_cntn
			,tcb.atfl_no
			,tcb.del_yn
		from tb_co_bbs tcb 
		where 1=1
		and tcb.bbs_type_cd = #{bbs_type_cd}
		and tcb.del_yn = 'N'
        <if test='bbs_doc_ttl != null and bbs_doc_ttl != ""'>
            and tcb.bbs_doc_ttl like concat('%', trim(#{bbs_doc_ttl}), '%')
        </if>
         <if test='bbs_doc_cntn != null and bbs_doc_cntn != ""'>
            and tcb.bbs_doc_cntn like concat('%', trim(#{bbs_doc_cntn}), '%')
        </if>
        <if test='doc_type_cd != null and doc_type_cd != ""'>
            and tcb.doc_type_cd = #{doc_type_cd}
        </if>
		order by tcb.bbs_doc_no desc
	</select>
	
	<insert id="saveLncs" parameterType="sqlMap">
      insert into tb_co_bbs (
       		bbs_doc_no
       		,bbs_type_cd
			,doc_type_cd
			,bbs_doc_ttl
			,bbs_doc_cntn
			,atfl_no
			,noti_yn
			,del_yn
			,crt_usr_id
			,crt_dt
			,upt_usr_id
			,upt_dt
		) values (
			#{bbs_doc_no}::INTEGER
       		,#{bbs_type_cd}
			,#{doc_type_cd}
			,trim(#{bbs_doc_ttl})
			,trim(#{bbs_doc_cntn})
			,case when #{atfl_no} = '' then null 
				   else #{atfl_no}::INTEGER 
		     end
			,'N'
			,'N'
			,#{SESS_USR_ID}
			,to_char(now(), 'YYYYMMDDHH24MISS')
			,#{SESS_USR_ID}
			,to_char(now(), 'YYYYMMDDHH24MISS')
		) 
    </insert>
    
    <update id="updateLncs" parameterType="sqlMap">
        /* updateLncs */
        update tb_co_bbs set
        	bbs_doc_ttl = trim(#{bbs_doc_ttl})
		   ,bbs_doc_cntn = trim(#{bbs_doc_cntn})
		   ,doc_type_cd = #{doc_type_cd}
		   ,atfl_no = case when #{atfl_no}::text  = '' then null 
			   				else #{atfl_no}::INTEGER 
	    	 			end
		   ,upt_usr_id = #{SESS_USR_ID}
		   ,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS') 
		where tb_co_bbs.bbs_doc_no = #{bbs_doc_no}::INTEGER
    </update>
    
    <select id="selectLncsDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectLncsDtl */
		select 
			tcb.bbs_doc_no
			,tcb.bbs_doc_ttl
			,tcb.upt_usr_id
			,case when #{SESS_LANG} = 'KO' then (select tce.usr_ko_nm from tb_co_user tce where tce.usr_id = tcb.upt_usr_id) 
				  when #{SESS_LANG} = 'EN' then	 (select tce.usr_en_nm from tb_co_user tce where tce.usr_id = tcb.upt_usr_id) 		  
				  else (select tce.usr_zh_nm from tb_co_user tce where tce.usr_id = tcb.upt_usr_id) 
			end as usr_nm
			,tcb.noti_yn
			,tcb.bbs_type_cd
			,tcb.doc_type_cd
			,fn_get_cd('CO00000013',tcb.doc_type_cd,'NM',#{SESS_LANG}) as doc_type_cd_nm
			,tcb.bbs_doc_cntn
			,tcb.atfl_no
			,tcb.del_yn
			,fn_get_time(tcb.upt_dt, #{SESS_TIME_ZONE},'DA', '-') as upt_dt
		    ,fn_get_time(tcb.upt_dt, #{SESS_TIME_ZONE},'TS', ':') as upt_tm
		from tb_co_bbs tcb 
		where 1=1
		and tcb.bbs_doc_no = #{bbs_doc_no}::INTEGER
	</select>
	
	<select id="selectBbskey" parameterType="sqlMap" resultType="string">
		/* selectBbskey */
		select nextval('tb_co_bbs_bbs_doc_no_seq'::regclass) as key
	</select>
	
	<update id="deleteLncs" parameterType="sqlMap">
        /* deleteLncs */
        update tb_co_bbs set
		   del_yn = 'Y'
		   ,upt_usr_id = #{SESS_USR_ID}
		   ,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS') 
		where tb_co_bbs.bbs_doc_no = #{bbs_doc_no}::INTEGER
     </update>
     
     <select id="selectRgltActList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltActList */
		select rglt_act_alrm_no
		     , substring(tcraa.crt_da , 0, 5) || '-' || substring(tcraa.crt_da, 5, 2) || '-' || substring(tcraa.crt_da, 7, 2) as crt_da
		     , alrm_type_cd
		     , alrm_ttl
		     , (select count(*) from tb_ch_rglt_act_mtrl tcram where tcram.rglt_act_alrm_no = tcraa.rglt_act_alrm_no) as mtrl_cnt
		  from tb_ch_rglt_act_alrm tcraa 
		 where del_yn = 'N'
		 <if test='alrm_ttl != null and alrm_ttl != ""'>
            and tcraa.alrm_ttl like concat('%', trim(#{alrm_ttl}), '%')
        </if>
         <if test='alrm_cntn != null and alrm_cntn != ""'>
            and tcraa.alrm_cntn like concat('%', trim(#{alrm_cntn}), '%')
        </if>
        <if test='alrm_type_cd != null and alrm_type_cd != ""'>
            and tcraa.alrm_type_cd = #{alrm_type_cd}
        </if>
        <if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
		   and (tcraa.crt_da between replace(#{sDate},'-','') || '000000' and replace(#{eDate},'-','') || '235959' or tcraa.crt_da is null or tcraa.crt_da = '')
		 </if>
	</select>
	
	<select id="selectRgltActDetail" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltActDetail */
		select (select tcraa.alrm_ttl 
		          from tb_ch_rglt_act_alrm tcraa 
		         where tcraa.rglt_act_alrm_no = tcram.rglt_act_alrm_no) as alrm_ttl
		     , (select fn_get_cd('CH00000018',tcraa.alrm_type_cd,'NM',#{SESS_LANG}) 
		          from tb_ch_rglt_act_alrm tcraa 
		         where tcraa.rglt_act_alrm_no = tcram.rglt_act_alrm_no) as alrm_type_nm
		     , (select substring(tcraa.crt_da , 0, 5) || '-' || substring(tcraa.crt_da, 5, 2) || '-' || substring(tcraa.crt_da, 7, 2) 
		          from tb_ch_rglt_act_alrm tcraa 
		         where tcraa.rglt_act_alrm_no = tcram.rglt_act_alrm_no) as crt_da
		     , fn_get_cd('CO00000017',tcm.mtrl_clsf_cd,'NM',#{SESS_LANG}) as mtrl_clsf_nm 
			 , fn_get_cd('CH00000006',tcm.macl_cd,'NM',#{SESS_LANG}) as macl_nm
		     , fn_get_cd('CO00000006',tcram.wkpl_id,'NM',#{SESS_LANG}) as wkpl_nm
		     , tcm.mtrl_no 
		     , case when #{SESS_LANG} = 'KO' then tcm.mtrl_ko_nm
			        else tcm.mtrl_en_nm 
				    end as mtrl_nm
		     , tcram.anul_use_tot 
		     , (select substring(max(tcmwd.wh_da) , 0, 5) || '-' || substring(max(tcmwd.wh_da), 5, 2) || '-' || substring(max(tcmwd.wh_da), 7, 2) from tb_ch_mtrl_wh_dd tcmwd where tcmwd.mtrl_no = tcm.mtrl_no) as wh_da
		  from tb_ch_rglt_act_mtrl tcram 
		  join tb_co_mtrl tcm on tcram.mtrl_no = tcm.mtrl_no
		 where tcram.rglt_act_alrm_no = #{rglt_act_alrm_no}
	</select>
     
</mapper>