<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.ch.rgltdb.mapper.RgltSbstMapper">

	<!-- 물질 목록 조회 -->
	<select id="selectSbstList" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstList */
		select a.sbst_no 
		      ,a.cas_no
		      ,a.sbst_ko_nm
		      ,a.sbst_en_nm
		      ,a.usg_yn 
		      ,(select case when #{SESS_LANG} = 'KO' then u.usr_ko_nm 
				            when #{SESS_LANG} = 'EN' then u.usr_en_nm 
				            else u.usr_zh_nm 
				       end as usr_nm
			      from tb_co_user u
			     where u.usr_id = a.upt_usr_id
			   ) as upt_usr_nm
			  ,(select count(1) as cnt
			      from tb_ch_rglt_sbst b
			     where b.sbst_no = a.sbst_no
			       and b.usg_yn = 'Y'
			       and b.del_yn = 'N'
			   ) as rglt_sbst_cnt
			  ,fn_get_time(a.upt_dt, #{SESS_TIME_ZONE},'DT', '-') as upt_dt
		  from tb_ch_sbst a
		 where a.del_yn = 'N'
		 <if test='cas_no != null and cas_no != ""'>
		   and a.cas_no like concat('%', rtrim(ltrim(#{cas_no})), '%')
		 </if>
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and (a.sbst_ko_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		     or a.sbst_en_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		       )
		 </if>
		 <if test='rglt_chk_doma_cd != null and rglt_chk_doma_cd != ""'>
		   and exists (select 1
		                 from tb_ch_rglt_sbst b
		                     ,tb_ch_rglt c
		                where b.rglt_no = c.rglt_no 
		                  and b.sbst_no = a.sbst_no 
		                  and c.rglt_chk_doma_cd = #{rglt_chk_doma_cd}
		              )
		 </if>
		 <if test='law_cd != null and law_cd != ""'>
		   and exists (select 1
		                 from tb_ch_rglt_sbst b
		                     ,tb_ch_rglt c
		                where b.rglt_no = c.rglt_no 
		                  and b.sbst_no = a.sbst_no 
		                  and c.law_cd = #{law_cd}
		              )
		 </if>
		 <if test='rglt_nm != null and rglt_nm != ""'>
		   and exists (select 1
		                 from tb_ch_rglt_sbst b
		                     ,tb_ch_rglt c
		                where b.rglt_no = c.rglt_no 
		                  and b.sbst_no = a.sbst_no 
		                  and c.rglt_nm like concat('%', rtrim(ltrim(#{rglt_nm})), '%')
		              )
		 </if>
		 order by a.sbst_type_cd, a.sbst_no, a.cas_no nulls last
	</select>
	
	<!-- 물질 상세 조회 -->
	<select id="selectSbstDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstDtl */
		select a.sbst_no
			  ,a.sbst_type_cd
			  ,a.sbst_ko_nm
			  ,a.sbst_en_nm
			  ,a.cas_no
			  ,a.ke_no
			  ,a.ec_no
			  ,a.nfpa_he_cd
			  ,a.nfpa_fire_cd
			  ,a.nfpa_creac_cd
			  ,a.phase_1st_cntn
			  ,a.phase_2nd_cntn
			  ,a.clr_cntn
			  ,a.odor_cntn
			  ,a.odor_thshld_cntn
			  ,a.ph_cntn
			  ,a.ph_val
			  ,a.meltp_cntn
			  ,a.boilp_cntn
			  ,a.boilp_val
			  ,a.boinp_unit_nm
			  ,a.flashp_cntn
			  ,a.flashp_val
			  ,a.flashp_unit_nm
			  ,a.mol_wgt_cntn
			  ,a.eva_rate_cntn
			  ,a.flamabl_cntn
			  ,a.explos_cntn
			  ,a.stpress_cntn
			  ,a.solub_cntn
			  ,a.vapden_cntn
			  ,a.spgrav_cntn
			  ,a.kow_cntn
			  ,a.autoigt_cntn
			  ,a.thermsis_cntn
			  ,a.visco_cntn
			  ,a.ko_syno_nm
			  ,a.en_syno_nm
			  ,a.usg_yn
			  ,a.del_yn
			  ,a.crt_usr_id
			  ,a.crt_dt
			  ,a.upt_usr_id
			  ,a.upt_dt
		  from tb_ch_sbst a
		 where a.sbst_no = #{sbst_no}
		   and a.del_yn = 'N'
	</select>
	
	<!-- 물질 키 채번 -->
	<select id="selectSbstKeyChk" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstKeyChk */
		select case when count(1) > 0 then 'Y' else 'N' end as dup_yn
		  from tb_ch_sbst a
		 where a.sbst_no = #{sbst_no}
	</select>
	
	<!-- 물질 등록 -->
	<insert id="insertSbstDtl" parameterType="sqlMap">
        /* insertSbstDtl */
        insert into tb_ch_sbst (
        	 sbst_no
        	,sbst_type_cd
			,sbst_ko_nm
			,sbst_en_nm
			,usg_yn
			,del_yn
			,crt_usr_id
			,crt_dt
			,upt_usr_id
			,upt_dt
			,kyin_yn
		) values (
			 #{sbst_no}
			,#{sbst_type_cd}
			,#{sbst_ko_nm}
			,#{sbst_en_nm}
			,#{usg_yn}
			,'N'
			,#{username}
			,to_char(now(), 'YYYYMMDDHH24MISS')
			,#{username}
			,to_char(now(), 'YYYYMMDDHH24MISS')
			,'Y'
		)
    </insert>
    
    <!-- 물질 수정 -->
    <update id="updateSbstDtl" parameterType="sqlMap">
        /* updateSbstDtl */
        update tb_ch_sbst
		   set sbst_type_cd = #{sbst_type_cd}
		      ,sbst_ko_nm = #{sbst_ko_nm}
		      ,sbst_en_nm = #{sbst_en_nm}
		      ,usg_yn = #{usg_yn}
		      ,upt_usr_id = #{username}
		      ,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS')
		 where sbst_no = #{sbst_no}
    </update>
    
    <!-- 물질 변경 이력 저장 -->
    <insert id="insertSbstDtlHst" parameterType="sqlMap">
        /* insertSbstDtlHst */
        insert into tb_ch_sbst_hst (
        	 chg_type_cd
        	,chg_dt
        	,chg_usr_id
        	,ver_seq
        	,sbst_no
        	,sbst_type_cd
        	,sbst_ko_nm
			,sbst_en_nm
			,cas_no
			,ke_no
			,ec_no
			,nfpa_he_cd
			,nfpa_fire_cd
			,nfpa_creac_cd
			,phase_1st_cntn
			,phase_2nd_cntn
			,clr_cntn
			,odor_cntn
			,odor_thshld_cntn
			,ph_cntn
			,ph_val
			,meltp_cntn
			,boilp_cntn
			,boilp_val
			,boinp_unit_nm
			,flashp_cntn
			,flashp_val
			,flashp_unit_nm
			,mol_wgt_cntn
			,eva_rate_cntn
			,flamabl_cntn
			,explos_cntn
			,stpress_cntn
			,solub_cntn
			,vapden_cntn
			,spgrav_cntn
			,kow_cntn
			,autoigt_cntn
			,thermsis_cntn
			,visco_cntn
			,ko_syno_nm
			,en_syno_nm
			,usg_yn
			,del_yn
			,crt_usr_id
			,crt_dt
			,upt_usr_id
			,upt_dt
		) values (
	 		 #{chg_type_cd}
	 		,to_char(now(), 'YYYYMMDDHH24MISS')
	 		,#{username}
			,(select coalesce(max(ver_seq::integer),0) + 1 as key
			    from tb_ch_sbst_hst
			   where sbst_no = #{sbst_no}
			 )
			,#{sbst_no}
			,#{sbst_type_cd}
        	,#{sbst_ko_nm}
			,#{sbst_en_nm}
			,#{cas_no}
			,#{ke_no}
			,#{ec_no}
			,#{nfpa_he_cd}
			,#{nfpa_fire_cd}
			,#{nfpa_creac_cd}
			,#{phase_1st_cntn}
			,#{phase_2nd_cntn}
			,#{clr_cntn}
			,#{odor_cntn}
			,#{odor_thshld_cntn}
			,#{ph_cntn}
			,#{ph_val}::numeric
			,#{meltp_cntn}
			,#{boilp_cntn}
			,#{boilp_val}::numeric
			,#{boinp_unit_nm}
			,#{flashp_cntn}
			,#{flashp_val}::numeric
			,#{flashp_unit_nm}
			,#{mol_wgt_cntn}
			,#{eva_rate_cntn}
			,#{flamabl_cntn}
			,#{explos_cntn}
			,#{stpress_cntn}
			,#{solub_cntn}
			,#{vapden_cntn}
			,#{spgrav_cntn}
			,#{kow_cntn}
			,#{autoigt_cntn}
			,#{thermsis_cntn}
			,#{visco_cntn}
			,#{ko_syno_nm}
			,#{en_syno_nm}
			,#{usg_yn}
			,'N'
			,#{crt_usr_id}
			,#{crt_dt}
			,#{username}
			,to_char(now(), 'YYYYMMDDHH24MISS')
		)
    </insert>
    
    <!-- 물질 변경 이력 조회 -->
    <select id="selectSbstHstList" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstHstList */
		select a.chg_type_cd 
		      ,(select m.mlang_cntn
				  from tb_co_mlang m
				      ,tb_co_cd c
				 where c.cd = a.chg_type_cd 
				   and m.cd  = c.cd 
				   and m.cd_grp_no  = c.cd_grp_no 
				   and c.cd_grp_no = 'CO00000015'
				   and m.lang_cd = #{SESS_LANG}
			   ) as chg_type_nm
			  ,a.sbst_no 
			  ,a.cas_no 
			  ,a.sbst_ko_nm 
			  ,a.sbst_en_nm 
			  ,a.usg_yn 
			  ,a.upt_usr_id 
			  ,(select case when #{SESS_LANG} = 'KO' then u.usr_ko_nm 
				            when #{SESS_LANG} = 'EN' then u.usr_en_nm 
				            else u.usr_zh_nm 
				       end as usr_nm
			      from tb_co_user u
			     where u.usr_id = a.upt_usr_id
			   ) as upt_usr_nm
			  ,fn_get_time(a.upt_dt, #{SESS_TIME_ZONE},'DT', '-') as upt_dt
		  from tb_ch_sbst_hst a
		 where 1=1
		 <if test='cas_no != null and cas_no != ""'>
		   and a.cas_no like concat('%', rtrim(ltrim(#{cas_no})), '%')
		 </if>
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and (a.sbst_ko_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		     or a.sbst_en_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		       )
		 </if>
		 <if test='rglt_chk_doma_cd != null and rglt_chk_doma_cd != ""'>
		   and exists (select 1
		                 from tb_ch_rglt_sbst b
		                     ,tb_ch_rglt c
		                where b.rglt_no = c.rglt_no 
		                  and b.sbst_no = a.sbst_no 
		                  and c.rglt_chk_doma_cd = #{rglt_chk_doma_cd}
		              )
		 </if>
		 <if test='law_cd != null and law_cd != ""'>
		   and exists (select 1
		                 from tb_ch_rglt_sbst b
		                     ,tb_ch_rglt c
		                where b.rglt_no = c.rglt_no 
		                  and b.sbst_no = a.sbst_no 
		                  and c.law_cd = #{law_cd}
		              )
		 </if>
		 <if test='rglt_nm != null and rglt_nm != ""'>
		   and exists (select 1
		                 from tb_ch_rglt_sbst b
		                     ,tb_ch_rglt c
		                where b.rglt_no = c.rglt_no 
		                  and b.sbst_no = a.sbst_no 
		                  and c.rglt_nm like concat('%', rtrim(ltrim(#{rglt_nm})), '%')
		              )
		 </if>
		 <if test='chg_usr_id != null and chg_usr_id != ""'>
		   and a.chg_usr_id = #{chg_usr_id}
		 </if>
		 <if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
		   and a.chg_dt between replace(#{sDate},'-','') || '000000' and replace(#{eDate},'-','') || '235959'
		 </if>
		 <if test='chg_type_cd != null and chg_type_cd != ""'>
		   and a.chg_type_cd = #{chg_type_cd}
		 </if>
		 order by a.sbst_no, a.ver_seq
	</select>
	
	<!-- 물질별 규재정보 상세 조회 -->
    <select id="selectSbstRgltDtlInfo" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstRgltDtlInfo */
		select a.sbst_no
		      ,a.cas_no 
		      ,a.sbst_type_cd 
		      ,fn_get_cd('CH00000004', a.sbst_type_cd, 'NM', #{SESS_LANG}) as sbst_type_nm
		      ,a.sbst_ko_nm 
		      ,a.sbst_en_nm 
		      ,a.usg_yn 
		      ,a.del_yn 
		  from tb_ch_sbst a
		 where a.sbst_no = #{sbst_no}
		   and a.del_yn = 'N'
	</select>
	
	<!-- 물질별 규재정보 목록 조회 -->
    <select id="selectSbstRgltDtlList" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstRgltDtlList */
		select b.sbst_no
		      ,a.rglt_no 
		      ,fn_get_cd('CH00000003', a.law_cd, 'NM', #{SESS_LANG}) as law_nm
		      ,a.rglt_nm
		      ,case when b.del_yn = 'Y' or b.sbst_no is null then 'N' else 'Y' end as org_tgt_yn
		      ,case when b.del_yn = 'Y' or b.sbst_no is null then FALSE else TRUE end as tgt_yn
		      ,b.rglt_crtr_rati::text
		      ,b.rglt_crtr_cntn
		      ,b.rglt_sbst_note 
		      ,a.rglt_type_cd 
		      ,b.crt_usr_id
		      ,b.crt_dt
		      ,case when b.usg_yn is null then 'Y' else b.usg_yn end as usg_yn
		      ,case when b.del_yn is null then 'Y' else b.del_yn end as del_yn
		  from tb_ch_rglt a
		  left join tb_ch_rglt_sbst b
		    on a.rglt_no = b.rglt_no and b.del_yn = 'N' and b.usg_yn = 'Y'
		   and b.sbst_no = #{sbst_no}
		 where a.usg_yn = 'Y'
           and a.del_yn = 'N'
		 order by a.sort_seq
	</select>
	
	<!-- 물질별 규재정보 존재 여부 체크 -->
    <select id="selectSbstRgltDtlChk" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstRgltDtlChk */
		select case when count(1) > 0 then 'Y' else 'N' end as up_yn 
		  from tb_ch_rglt_sbst a
		 where a.rglt_no = #{rglt_no}
   		   and a.sbst_no = #{sbst_no}
   		   and a.del_yn = 'N'
	</select>
	
	<!-- 규재 물질 저장 -->
    <insert id="insertSbstRgltDtlList" parameterType="sqlMap">
        /* insertRgltSbstDtlList */
        with upsert as (
		update tb_ch_rglt_sbst
		   set rglt_crtr_rati    = #{rglt_crtr_rati}::numeric
		      ,rglt_crtr_cntn    = #{rglt_crtr_cntn}
		      ,rglt_sbst_note    = #{rglt_sbst_note}
		      ,del_yn            = #{del_yn}
		      ,upt_usr_id        = #{username}
		      ,upt_dt            = to_char(now(), 'YYYYMMDDHH24MISS')
		 where rglt_no = #{rglt_no} 
		   and sbst_no = #{sbst_no} RETURNING *
		)
		insert into tb_ch_rglt_sbst (
			   rglt_no
			  ,sbst_no
			  ,rglt_crtr_rati
			  ,rglt_crtr_cntn
			  ,rglt_sbst_note
			  ,usg_yn
			  ,del_yn
			  ,crt_usr_id
			  ,crt_dt
			  ,upt_usr_id
			  ,upt_dt
		)
		select #{rglt_no}
		      ,#{sbst_no}
		      ,#{rglt_crtr_rati}::numeric
		      ,#{rglt_crtr_cntn}
		      ,#{rglt_sbst_note}
		      ,'Y'
		      ,'N'
		      ,#{username}
		      ,to_char(now(), 'YYYYMMDDHH24MISS')
		      ,#{username}
		      ,to_char(now(), 'YYYYMMDDHH24MISS')
	     where not exists (select * from upsert)
    </insert>
    
    <!-- 규제 물질 삭제 -->
    <update id="deleteSbstRgltDtlList" parameterType="sqlMap">
        /* deleteSbstRgltDtlList */
        update tb_ch_rglt_sbst
		   set del_yn = 'Y'
		      ,rglt_crtr_rati = null
		      ,rglt_crtr_cntn = null
		      ,rglt_sbst_note = null
		      ,upt_usr_id = #{username}
		      ,upt_dt = to_char(now(), 'YYYYMMDDHH24MISS')
		 where sbst_no = #{sbst_no}
		   and rglt_no = #{rglt_no}
    </update>
	
	<!-- 규재 물질 변경 이력 저장 -->
    <insert id="insertSbstRgltDtlHst" parameterType="sqlMap">
        /* insertSbstRgltDtlHst */
        insert into tb_ch_rglt_sbst_hst (
        	 chg_type_cd
        	,chg_dt
        	,chg_usr_id
        	,ver_seq
        	,rglt_no
        	,sbst_no
        	,rglt_crtr_rati
			,rglt_crtr_cntn
			,rglt_sbst_note
			,usg_yn
			,del_yn
			,crt_usr_id
			,crt_dt
			,upt_usr_id
			,upt_dt
			,nat_cd
			,rglt_type_cd
			,rglt_chk_doma_cd
			,law_cd
			,rglt_nm
			,rglt_abbr
			,sbst_ko_nm
			,sbst_en_nm
			,cas_no
			,ke_no
			,ec_no
		) values (
	 		 #{chg_type_cd}
	 		,to_char(now(), 'YYYYMMDDHH24MISS')
	 		,#{username}
			,(select coalesce(max(ver_seq::integer),0) + 1 as key
			    from tb_ch_rglt_sbst_hst
			   where sbst_no = #{sbst_no}
			     and rglt_no = #{rglt_no}
			 )
			,#{rglt_no}
			,#{sbst_no}
        	,#{rglt_crtr_rati}::numeric
			,#{rglt_crtr_cntn}
			,#{rglt_sbst_note}
			,#{usg_yn}
			,#{del_yn}
			,#{crt_usr_id}
			,#{crt_dt}
			,#{username}
			,to_char(now(), 'YYYYMMDDHH24MISS')
			,(select a.nat_cd
			    from tb_ch_rglt a
			   where a.rglt_no = #{rglt_no}
			 )
			,(select a.rglt_type_cd
			    from tb_ch_rglt a
			   where a.rglt_no = #{rglt_no}
			 )
			,(select a.rglt_chk_doma_cd
			    from tb_ch_rglt a
			   where a.rglt_no = #{rglt_no}
			 )
			,(select a.law_cd
			    from tb_ch_rglt a
			   where a.rglt_no = #{rglt_no}
			 )
			,(select a.rglt_nm
			    from tb_ch_rglt a
			   where a.rglt_no = #{rglt_no}
			 )
			,(select a.rglt_abbr
			    from tb_ch_rglt a
			   where a.rglt_no = #{rglt_no}
			 )
			,(select a.sbst_ko_nm
			    from tb_ch_sbst a
			   where a.sbst_no = #{sbst_no}
			 )
			,(select a.sbst_en_nm
			    from tb_ch_sbst a
			   where a.sbst_no = #{sbst_no}
			 )
			,(select a.cas_no
			    from tb_ch_sbst a
			   where a.sbst_no = #{sbst_no}
			 )
			,(select a.ke_no
			    from tb_ch_sbst a
			   where a.sbst_no = #{sbst_no}
			 )
			,(select a.ec_no
			    from tb_ch_sbst a
			   where a.sbst_no = #{sbst_no}
			 )
		)
    </insert>
	
	<!-- 규재별 물질정보 상세 조회 -->
    <select id="selectRgltSbstDtlInfo" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltSbstDtlInfo */
		select a.rglt_no 
		      ,fn_get_cd('CH00000002', a.rglt_chk_doma_cd, 'NM', #{SESS_LANG}) as rglt_chk_doma_nm
		      ,fn_get_cd('CH00000003', a.law_cd, 'NM', #{SESS_LANG}) as law_nm
		      ,a.usg_yn 
		      ,a.rglt_nm 
		      ,(select case when #{SESS_LANG} = 'KO' then u.usr_ko_nm 
				            when #{SESS_LANG} = 'EN' then u.usr_en_nm 
				            else u.usr_zh_nm 
				       end as usr_nm
			      from tb_co_user u
			     where u.usr_id = a.crt_usr_id
			   ) as crt_usr_nm
			  ,fn_get_time(a.crt_dt, #{SESS_TIME_ZONE},'DT', '-') as crt_dt
		  from tb_ch_rglt a
		 where a.rglt_no = #{rglt_no}
		   and a.del_yn = 'N'
	</select>
	
	<!-- 규재별 물질정보 목록 조회 -->
    <select id="selectRgltSbstDtlList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltSbstDtlList */
		select a.sbst_no 
		      ,a.rglt_no 
		      ,b.ke_no
		      ,b.cas_no 
		      ,b.sbst_ko_nm 
		      ,a.rglt_crtr_rati::text
		      ,a.rglt_crtr_cntn
		      ,a.rglt_sbst_note 
		      ,a.crt_usr_id
		      ,a.crt_dt
		      ,a.usg_yn 
		      ,a.del_yn 
		  from tb_ch_rglt_sbst a
		      ,tb_ch_sbst b
		 where a.sbst_no = b.sbst_no 
		   and a.del_yn = 'N'
		   and b.del_yn = 'N'
		   and a.rglt_no = #{rglt_no}
		 order by b.sbst_type_cd, b.sbst_no, b.cas_no nulls last
	</select>
	
	<!-- 규재 물질 목록 조회 -->
    <select id="selectRgltSbstList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltSbstList */
		select a.rglt_no 
		      ,fn_get_cd('CH00000002', b.rglt_chk_doma_cd, 'NM', #{SESS_LANG}) as rglt_chk_doma_nm
		      ,fn_get_cd('CH00000003', b.law_cd, 'NM', #{SESS_LANG}) as law_nm
		      ,b.rglt_nm 
			  ,a.sbst_no 
			  ,c.cas_no 
			  ,c.sbst_ko_nm 
			  ,c.sbst_en_nm 
			  ,a.rglt_crtr_rati::text 
			  ,a.make_crtr_qty
			  ,a.sk_crtr_qty
			  ,a.trt_crtr_qty
			  ,a.impt_crtr_qty
			  ,a.helthsc_cycl_val
			  ,a.helthsc_1st_cycl_val
			  ,a.dngr_crtr_qty
			  ,a.dngr_crtr_unit_nm
			  ,a.rglt_crtr_cntn 
			  ,a.usg_yn 
			  ,a.upt_usr_id 
			  ,(select case when #{SESS_LANG} = 'KO' then u.usr_ko_nm 
				            when #{SESS_LANG} = 'EN' then u.usr_en_nm 
				            else u.usr_zh_nm 
				       end as usr_nm
			      from tb_co_user u
			     where u.usr_id = a.upt_usr_id
			   ) as upt_usr_nm
			  ,fn_get_time(a.upt_dt, #{SESS_TIME_ZONE},'DT', '-') as upt_dt
		  from tb_ch_rglt_sbst a
		      ,tb_ch_rglt b
		      ,tb_ch_sbst c
		 where a.rglt_no = b.rglt_no 
		   and a.sbst_no = c.sbst_no 
		   and a.del_yn = 'N'
		   and b.del_yn = 'N'
		   and c.del_yn = 'N'
		 <if test='cas_no != null and cas_no != ""'>
		   and c.cas_no like concat('%', rtrim(ltrim(#{cas_no})), '%')
		 </if>
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and (c.sbst_ko_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		     or c.sbst_en_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		       )
		 </if>
		 <if test='rglt_chk_doma_cd != null and rglt_chk_doma_cd != ""'>
		   and b.rglt_chk_doma_cd = #{rglt_chk_doma_cd}
		 </if>
		 <if test='law_cd != null and law_cd != ""'>
		   and b.law_cd = #{law_cd}
		 </if>
		 <if test='rglt_cd != null and rglt_cd != ""'>
		   and b.rglt_no = #{rglt_cd}
		 </if>
		 order by a.rglt_no, a.sbst_no
	</select>
	
	<!-- 규재 물질 변경 이력 목록 조회 -->
    <select id="selectRgltSbstChgHstList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRgltSbstChgHstList */
		select a.chg_type_cd 
		      ,a.rglt_no 
		      ,fn_get_cd('CH00000002', a.rglt_chk_doma_cd, 'NM', #{SESS_LANG}) as rglt_chk_doma_nm
		      ,fn_get_cd('CH00000003', a.law_cd, 'NM', #{SESS_LANG}) as law_nm
		      ,a.rglt_nm 
		      ,(select m.mlang_cntn
				  from tb_co_mlang m
				      ,tb_co_cd c
				 where c.cd = a.chg_type_cd 
				   and m.cd  = c.cd 
				   and m.cd_grp_no  = c.cd_grp_no 
				   and c.cd_grp_no = 'CO00000015'
				   and m.lang_cd = #{SESS_LANG}
			   ) as chg_type_nm
			  ,a.sbst_no 
			  ,a.cas_no 
			  ,a.sbst_ko_nm 
			  ,a.sbst_en_nm 
			  ,a.rglt_crtr_rati::text 
			  ,a.rglt_crtr_cntn 
			  ,a.usg_yn 
			  ,a.upt_usr_id 
			  ,(select case when #{SESS_LANG} = 'KO' then u.usr_ko_nm 
				            when #{SESS_LANG} = 'EN' then u.usr_en_nm 
				            else u.usr_zh_nm 
				       end as usr_nm
			      from tb_co_user u
			     where u.usr_id = a.upt_usr_id
			   ) as upt_usr_nm
			  ,fn_get_time(a.upt_dt, #{SESS_TIME_ZONE},'DT', '-') as upt_dt
		  from tb_ch_rglt_sbst_hst a
		 where 1=1
		 <if test='cas_no != null and cas_no != ""'>
		   and a.cas_no like concat('%', rtrim(ltrim(#{cas_no})), '%')
		 </if>
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and (a.sbst_ko_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		     or a.sbst_en_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		       )
		 </if>
		 <if test='rglt_chk_doma_cd != null and rglt_chk_doma_cd != ""'>
		   and a.rglt_chk_doma_cd = #{rglt_chk_doma_cd}
		 </if>
		 <if test='law_cd != null and law_cd != ""'>
		   and a.law_cd = #{law_cd}
		 </if>
		 <if test='rglt_nm != null and rglt_nm != ""'>
		   and a.rglt_nm like concat('%', rtrim(ltrim(#{rglt_nm})), '%')
		 </if>
		 <if test='chg_usr_id != null and chg_usr_id != ""'>
		   and a.chg_usr_id = #{chg_usr_id}
		 </if>
		 <if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
		   and a.chg_dt between replace(#{sDate},'-','') || '000000' and replace(#{eDate},'-','') || '235959'
		 </if>
		 <if test='chg_type_cd != null and chg_type_cd != ""'>
		   and a.chg_type_cd = #{chg_type_cd}
		 </if>
		 order by a.rglt_no, a.sbst_no, a.ver_seq
	</select>
</mapper>