<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.opem.mapper.OpemActnMapper">

	<select id="selectOpemActnList" parameterType="sqlMap" resultType="sqlMap">
		/* selectOpemActnList */
		select 
			t1.wem_actn_id
			,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
			,fn_get_cmpy(t1.wkpl_id, 'NM', #{SESS_LANG}) as cmpy_nm
			,t1.acrq_nm
			,t2.upp_incl_wkpl_loc_nm as acrq_wkpl_loc_nm
			,t1.acrq_dtl_loc_nm
			,to_char(t1.acrq_dttm, 'YYYY-MM-DD HH:MI') as acrq_dttm
			,substring(t1.acrq_hope_dt, 0, 5) || '-' || substring(t1.acrq_hope_dt, 5, 2) || '-' || substring(t1.acrq_hope_dt, 7, 2) as acrq_hope_dt
			,substring(t1.acco_dt, 0, 5) || '-' || substring(t1.acco_dt, 5, 2) || '-' || substring(t1.acco_dt, 7, 2) as acco_dt
			,fn_get_user(t1.wem_acrq_usr_id, 'nm', #{SESS_LANG}) as wem_acrq_usr_nm
			,t1.acco_prst_cd
			,fn_get_cd('SH00000067', t1.acco_prst_cd, 'nm', #{SESS_LANG}) as acco_prst_nm
			,t1.acco_aprv_no
			,case when (select dept_cd from tb_co_user where usr_id = t1.crt_usr_id) = #{SESS_DEPT} then 'U'
		     else 'R' end as mode
		from tb_sh_wem_actn t1
		left outer join tb_sh_wkpl_loc t2 on t1.acrq_wkpl_loc_id = t2.wkpl_loc_id 
		where 1 = 1
		<if test='wkpl_id != null and wkpl_id != ""'>
			and t1.wkpl_id = #{wkpl_id}
		</if>
		<if test='wem_acrq_usr_id != null and wem_acrq_usr_id != ""'>
		and t1.wem_acrq_usr_id = #{wem_acrq_usr_id}
		</if>
		<if test='acrq_wkpl_loc_id != null and acrq_wkpl_loc_id != ""'>
			and t1.acrq_wkpl_loc_id  = #{acrq_wkpl_loc_id}
		</if>
		<if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
		and to_char(t1.acrq_dttm, 'YYYY-MM-DD') between #{sDate} and #{eDate}
		</if>
		<if test='acco_prst_cd != null and acco_prst_cd != ""'>
			and t1.acco_prst_cd  = #{acco_prst_cd}
		</if>
		<if test='cmpy_cd != null and cmpy_cd != ""'>
		   and exists (select 1
		      			 from tb_sh_wkpl w
		      			where w.wkpl_id = t1.wkpl_id 
		      			  and w.cmpy_cd = #{cmpy_cd}
		   			  )
		 </if>
		order by wem_actn_id desc
	</select>
	
	<select id="selectOpemActn" parameterType="sqlMap" resultType="sqlMap">
		/* selectOpemActn */
		select 
			t1.wem_actn_id
			,t1.wkpl_id
			,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
			,t1.wem_actn_prgr_usr_id
			,fn_get_user(t1.wem_actn_prgr_usr_id, 'nm', #{SESS_LANG}) as wem_actn_prgr_usr_nm
			,t1.acrq_nm
			,t1.acrq_wkpl_loc_id
			,t2.upp_incl_wkpl_loc_nm as acrq_wkpl_loc_nm
			,t1.acrq_dtl_loc_nm
			,to_char(t1.acrq_dttm, 'YYYY-MM-DD HH:MI') as acrq_dttm
			,t1.acrq_note_txt
			,substring(t1.acrq_hope_dt, 0, 5) || '-' || substring(t1.acrq_hope_dt, 5, 2) || '-' || substring(t1.acrq_hope_dt, 7, 2) as acrq_hope_dt
			,t1.wem_acrq_usr_id
			,fn_get_user(t1.wem_acrq_usr_id, 'nm', #{SESS_LANG}) as wem_acrq_usr_nm
			,t1.acrq_txt
			,t1.acrq_img_atfl_no1
			,t1.acrq_img_atfl_no2
			,t1.acrq_img_atfl_no3
			,t1.acrq_atfl_no
			,(select count(*) from tb_co_atfl where atfl_no = t1.acrq_atfl_no) as acrq_atfl_cnt
			,substring(t1.acco_dt, 0, 5) || '-' || substring(t1.acco_dt, 5, 2) || '-' || substring(t1.acco_dt, 7, 2) as acco_dt
			,t1.wem_acco_usr_id
			,fn_get_user(t1.wem_acco_usr_id, 'nm', #{SESS_LANG}) as wem_acco_usr_nm
			,t1.acco_txt
			,t1.acco_img_atfl_no1
			,t1.acco_img_atfl_no2
			,t1.acco_img_atfl_no3
			,t1.acco_atfl_no
			,(select count(*) from tb_co_atfl where atfl_no = t1.acco_atfl_no) as acco_atfl_cnt
			,t1.acco_aprv_no
			,t1.acco_prst_cd
		from tb_sh_wem_actn t1
		left outer join tb_sh_wkpl_loc t2 on t1.acrq_wkpl_loc_id = t2.wkpl_loc_id 
		where t1.wem_actn_id = #{wem_actn_id}
	</select>
	
	<insert id="insertOpemActn" parameterType="sqlMap">
		<selectKey keyProperty="wem_actn_id" resultType="String" order="BEFORE">
        	select to_char(now(), 'ACYYMMDD') || to_char(substring(coalesce(MAX(wem_actn_id), to_char(now(), 'ACYYMMDD0000')), 9, 4)::INTEGER + 1, 'FM0000') wem_actn_id
			from tb_sh_wem_actn
			where wem_actn_id like to_char(now(), 'ACYYMMDD') || '%'
    	</selectKey>
    	
      	/* insertOpemActn */
		insert into tb_sh_wem_actn (
			wem_actn_id
			,wkpl_id
			,wem_actn_prgr_usr_id
			,acrq_nm
			,acrq_wkpl_loc_id
			,acrq_dtl_loc_nm
			,acrq_dttm
			,acrq_note_txt
			,acrq_hope_dt
			,wem_acrq_usr_id
			,acrq_txt
			,acrq_img_atfl_no1
			,acrq_img_atfl_no2
			,acrq_img_atfl_no3
			,acrq_atfl_no
			,acco_dt
			,wem_acco_usr_id
			,acco_txt
			,acco_img_atfl_no1
			,acco_img_atfl_no2
			,acco_img_atfl_no3
			,acco_atfl_no
			,acco_aprv_no
			,acco_prst_cd
		    ,crt_usr_id
			,upt_usr_id
		) values (
			#{wem_actn_id}
			,#{wkpl_id}
			,#{wem_actn_prgr_usr_id}
			,#{acrq_nm}
			,#{acrq_wkpl_loc_id}
			,#{acrq_dtl_loc_nm}
			,statement_timestamp()
			,#{acrq_note_txt}
			,replace(#{acrq_hope_dt}, '-', '')
			,#{wem_acrq_usr_id}
			,#{acrq_txt}
			,#{acrq_img_atfl_no1}::INTEGER
			,#{acrq_img_atfl_no2}::INTEGER
			,#{acrq_img_atfl_no3}::INTEGER
			,#{acrq_atfl_no}::INTEGER
			,replace(#{acco_dt}, '-', '')
			,#{wem_acco_usr_id}
			,#{acco_txt}
			,#{acco_img_atfl_no1}::INTEGER
			,#{acco_img_atfl_no2}::INTEGER
			,#{acco_img_atfl_no3}::INTEGER
			,#{acco_atfl_no}::INTEGER
			,#{acco_aprv_no}
			,#{acco_prst_cd}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		)
    </insert>
    
    <update id="updateOpemActn" parameterType="sqlMap">
        /* updateOpemActn */
		update tb_sh_wem_actn set
			wem_actn_id				= #{wem_actn_id}
			,wkpl_id				= #{wkpl_id}			
			,wem_actn_prgr_usr_id		= #{wem_actn_prgr_usr_id}		
			,acrq_nm					= #{acrq_nm}				
			,acrq_wkpl_loc_id		= #{acrq_wkpl_loc_id}	
			,acrq_dtl_loc_nm			= #{acrq_dtl_loc_nm}		
			,acrq_note_txt				= #{acrq_note_txt}			
			,acrq_hope_dt				= replace(#{acrq_hope_dt}, '-', '')		
			,wem_acrq_usr_id			= #{wem_acrq_usr_id}		
			,acrq_txt					= #{acrq_txt}				
			,acrq_img_atfl_no1		= #{acrq_img_atfl_no1}::INTEGER
			,acrq_img_atfl_no2		= #{acrq_img_atfl_no2}::INTEGER
			,acrq_img_atfl_no3		= #{acrq_img_atfl_no3}::INTEGER
			,acrq_atfl_no			= #{acrq_atfl_no}::INTEGER	
			,acco_dt					= replace(#{acco_dt}, '-', '')
			,wem_acco_usr_id			= #{wem_acco_usr_id}		
			,acco_txt					= #{acco_txt}				
			,acco_img_atfl_no1		= #{acco_img_atfl_no1}::INTEGER
			,acco_img_atfl_no2		= #{acco_img_atfl_no2}::INTEGER
			,acco_img_atfl_no3		= #{acco_img_atfl_no3}::INTEGER
			,acco_atfl_no			= #{acco_atfl_no}::INTEGER
			,acco_aprv_no			= #{acco_aprv_no}		
			,acco_prst_cd		= #{acco_prst_cd}
			,upt_usr_id					= #{SESS_USR_ID}
			,upt_dt 					= statement_timestamp()
		where wem_actn_id = #{wem_actn_id}
    </update>
    
    <update id="updateAppr" parameterType="sqlMap">
        /* updateAppr */
        update tb_sh_wem_actn set
			acco_aprv_no = #{acco_aprv_no}
			,upt_usr_id = #{SESS_USR_ID}
			,upt_dt = statement_timestamp()
		where wem_actn_id = #{wem_actn_id}
    </update>
    
	<delete id="deleteOpemActn" parameterType="sqlMap">
        /* deleteOpemActn */
        delete from tb_sh_wem_actn
		where wem_actn_id = #{wem_actn_id}
    </delete>
	
	<select id="selectOpemActnId" parameterType="sqlMap" resultType="string">
		/* selectOpemActnId */
		select to_char(now(), 'ACYYMMDD') || to_char(substring(coalesce(MAX(wem_actn_id), to_char(now(), 'ACYYMMDD0000')), 9, 4)::INTEGER + 1, 'FM0000') wem_actn_id
		from tb_sh_wem_actn
		where wem_actn_id like to_char(now(), 'ACYYMMDD') || '%'
	</select>
	
	<select id="selectOpemActnAprvDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectOpemActnAprvDtl */
		select acco_aprv_no
		      ,acco_prst_cd
		  from tb_sh_wem_actn
		 where acco_aprv_no = #{acco_aprv_no}
	</select>
	
	<update id="updateOpemActnAprvAf" parameterType="sqlMap">
        /* updateOpemActnAprvAf */
        update tb_sh_wem_actn
		   set acco_prst_cd = #{acco_prst_cd}
		      ,upt_dt = now()
		 where acco_aprv_no = #{acco_aprv_no}
    </update>
</mapper>