<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.common.comm.mapper.CommPopMapper">

	<!-- 물질 공통 팝업 조회 -->
    <select id="selectSbstCommPopList" parameterType="sqlMap" resultType="sqlMap">
		/* selectSbstCommPopList */
		select aa.sbst_no
		      ,aa.cas_no 
		      ,aa.sbst_nm
		      ,aa.sbst_ko_nm 
		      ,aa.sbst_en_nm 
		      ,aa.ke_no 
		      ,aa.usg_yn 
		      ,aa.sbst_type_cd
		      ,fn_get_cd('CH00000004',aa.sbst_type_cd,'NM',#{SESS_LANG}) as sbst_type_nm
		      ,aa.kyin_yn
		  from (
		select a.sbst_no
		      ,a.cas_no 
		      ,case when #{SESS_LANG} = 'KO' then a.sbst_ko_nm 
		            else a.sbst_en_nm 
		       end as sbst_nm
		      ,a.sbst_ko_nm 
		      ,a.sbst_en_nm 
		      ,a.ke_no 
		      ,a.usg_yn 
		      ,a.sbst_type_cd
		      ,kyin_yn
		  from tb_ch_sbst a
		 where a.del_yn = 'N'
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and a.sbst_ko_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		 </if>
		 union
		select a.sbst_no
		      ,a.cas_no 
		      ,case when #{SESS_LANG} = 'KO' then a.sbst_ko_nm 
		            else a.sbst_en_nm 
		       end as sbst_nm
		      ,a.sbst_ko_nm 
		      ,a.sbst_en_nm 
		      ,a.ke_no 
		      ,a.usg_yn 
		      ,a.sbst_type_cd
		      ,kyin_yn
		  from tb_ch_sbst a
		 where a.del_yn = 'N'
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and a.sbst_en_nm like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		 </if>
		 union
		select a.sbst_no
		      ,a.cas_no 
		      ,case when #{SESS_LANG} = 'KO' then a.sbst_ko_nm 
		            else a.sbst_en_nm 
		       end as sbst_nm
		      ,a.sbst_ko_nm 
		      ,a.sbst_en_nm 
		      ,a.ke_no 
		      ,a.usg_yn 
		      ,a.sbst_type_cd
		      ,kyin_yn
		  from tb_ch_sbst a
		 where a.del_yn = 'N'
		 <if test='sbst_nm != null and sbst_nm != ""'>
		   and a.cas_no like concat('%', rtrim(ltrim(#{sbst_nm})), '%')
		 </if>
		 ) aa
		 order by aa.sbst_type_cd, aa.sbst_no, aa.cas_no nulls last
	</select>
	
	<select id="selectMtrlCommPopList" parameterType="sqlMap" resultType="sqlMap">
		/* selectMtrlCommPopList */
		select tcm.mtrl_no 
		      ,case when #{SESS_LANG} = 'KO' then tcm.mtrl_ko_nm 
		            when #{SESS_LANG} = 'EN' then tcm.mtrl_en_nm 
		            else tcm.mtrl_zh_nm end as mtrl_nm
		from tb_co_mtrl tcm
		where 1=1
		<if test='chkYnAll == "Y"'>
		  and tcm.rglt_chk_yn = 'Y'
		</if>
		<if test='chkYnAll == "N"'>
		  and tcm.rglt_chk_yn = 'N'
		</if>
		<if test='mtrl_no != null and mtrl_no != ""'>
		  and tcm.mtrl_no like concat('%', trim(BOTH FROM #{mtrl_no}::text), '%')
		</if>
		<if test='mtrl_nm != null and mtrl_nm != ""'>
		<if test='SESS_LANG == "KO"'>
		  and tcm.mtrl_ko_nm like concat('%', trim(BOTH FROM #{mtrl_nm}::text), '%')
		</if>
		<if test='SESS_LANG == "EN"'>
		  and tcm.mtrl_en_nm like concat('%', trim(BOTH FROM #{mtrl_nm}::text), '%')
		</if>
		<if test='SESS_LANG == "ZH"'>
		  and tcm.mtrl_zh_nm like concat('%', trim(BOTH FROM #{mtrl_nm}::text), '%')
		</if>
		</if>
		  and tcm.usg_yn = 'Y'
		  and tcm.del_yn = 'N'
	</select>
	
	<select id="selectVndrCommPopList" parameterType="sqlMap" resultType="sqlMap">
		/* selectVndrCommPopList */
		select vndr_no 
		      ,vndr_nm 
		      ,coalesce(vndr_phon_no, '') as vndr_phon_no
		      ,vndr_addr 
		      ,nat_cd
		      ,coalesce(vndr_rprs_nm, '') as vndr_rprs_nm
		      ,coalesce(vndr_coreg_no, '') as vndr_coreg_no
		      ,coalesce(vndr_url, '') as vndr_url
		      ,coalesce(vndr_email, '') as vndr_email
		      ,vndr_type_cd
		from tb_co_vndr tcv 
		where 1=1
		<if test='vndr_no != null and vndr_no != ""'>
		  and vndr_no like concat('%', trim(BOTH FROM #{vndr_no}::text), '%')
		</if>
		<if test='vndr_nm != null and vndr_nm != ""'>
		  and vndr_nm like concat('%', trim(BOTH FROM #{vndr_nm}::text), '%')
		</if>
		<if test='vndr_type_cd != null and vndr_type_cd != ""'>
		  and vndr_type_cd = #{vndr_type_cd}
		</if>
	</select>
	
	<select id="selectMtrlMultiCommPopList" parameterType="sqlMap" resultType="sqlMap">
		/* selectMtrlMultiCommPopList */
		select tcm.mtrl_no 
		      ,case when #{SESS_LANG} = 'KO' then tcm.mtrl_ko_nm 
		            when #{SESS_LANG} = 'EN' then tcm.mtrl_en_nm 
		            else tcm.mtrl_zh_nm end as mtrl_nm
		       ,coalesce(tcmv.vndr_no, 'V000000001') as vndr_no
		       ,coalesce(tcmv.vndr_nm, '(주)아이마켓코리아') as vndr_nm
		       ,tcm.macl_cd
		       ,fn_get_cd('CH00000006',tcm.macl_cd,'NM',#{SESS_LANG})  as macl_cd_nm
   		       ,tcm.pchs_unit_cd
   		       ,tcm.pchs_req_unit_cd
			   ,case when tcm.pchs_unit_cd = '6' then tcm.pchs_unit_nm
			            						 else fn_get_cd('CH00000026',tcm.pchs_unit_cd,'NM','KO') 
			 	end as pchs_unit_nm
			   ,case when tcm.pchs_req_unit_cd = '6' then tcm.pchs_req_unit_nm
			            						 else fn_get_cd('CH00000026',tcm.pchs_req_unit_cd,'NM','KO') 
			 	end as pchs_req_unit_nm
			   ,RTRIM(RTRIM(tcm.pchs_unit_weght::text, '0'), '.') as pchs_unit_weght
			   ,RTRIM(RTRIM(tcm.pchs_req_unit_weght::text, '0'), '.') as pchs_req_unit_weght
			   ,tcm.pchs_unit_nweght_qty
			   ,tcm.impt_yn
		from tb_co_mtrl tcm
		left join (select a.mtrl_no
		                  ,max(a.vndr_no) as vndr_no
		                  ,max(a.vndr_nm) as vndr_nm
		              from tb_ch_mro_pchs_mtrl a
		                  ,tb_co_vndr b
		             where a.vndr_no = b.vndr_no
		             group by a.mtrl_no
		           ) tcmv
	  	   on tcm.mtrl_no  = tcmv.mtrl_no
	  	left join tb_co_user tcu on tcu.usr_id = tcm.mtrl_reg_usr_id
		where 1=1
		  and tcm.mtrl_clsf_cd  ='2'
		<if test='chkYnAll == "Y"'>
		  and tcm.rglt_chk_yn = 'Y'
		</if>
		<if test='chkYnAll == "N"'>
		  and tcm.rglt_chk_yn = 'N'
		</if>
		<if test='mtrl_no != null and mtrl_no != ""'>
		  and tcm.mtrl_no like concat('%', #{mtrl_no}, '%')
		</if>
		<if test='mtrl_nm != null and mtrl_nm != ""'>
		<if test='SESS_LANG == "KO"'>
		  and tcm.mtrl_ko_nm like concat('%', #{mtrl_nm}, '%')
		</if>
		<if test='SESS_LANG == "EN"'>
		  and tcm.mtrl_en_nm like concat('%', #{mtrl_nm}, '%')
		</if>
		<if test='SESS_LANG == "ZH"'>
		  and tcm.mtrl_zh_nm like concat('%', #{mtrl_nm}, '%')
		</if>
		</if>
		<if test='vndr_nm != null and vndr_nm != ""'>
		  and tcmv.vndr_nm like concat('%', #{vndr_nm}, '%')
		</if>
		<if test='dept_nm != null and dept_nm != ""'>
		  and fn_get_dept(tcu.dept_cd) like concat('%', #{dept_nm}, '%')
		</if>
		<if test='(usr_nm != null and usr_nm != "") or (sDate != null and sDate != "" and eDate != null and eDate != "")'>
		  and tcm.mtrl_no in (select tcmpm.mtrl_no
								from (select tcmpm.mro_pchs_no , tcmpm.mtrl_no, tcmpm.vndr_no, tcmp.upt_dt
							  		    from tb_ch_mro_pchs tcmp
										   , tb_ch_mro_pchs_mtrl tcmpm
									   where tcmp.mro_pchs_no = tcmpm.mro_pchs_no  
										 and tcmp.del_yn = 'N'
									<if test='usr_nm != null and usr_nm != ""' >
										 and ((select tce.usr_ko_nm from tb_co_user tce where tce.usr_id = tcmp.upt_usr_id) like concat('%', trim(#{usr_nm}), '%')
											or (select tce.usr_en_nm from tb_co_user tce where tce.usr_id = tcmp.upt_usr_id) like concat('%', trim(#{usr_nm}), '%')
											or (select tce.usr_zh_nm from tb_co_user tce where tce.usr_id = tcmp.upt_usr_id) like concat('%', trim(#{usr_nm}), '%'))
									</if>
									<if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
									   <![CDATA[
										 and (to_timestamp(tcmp.upt_dt,  'YYYYMMDDHH24MIss') >= #{sDate}::timestamp and to_timestamp(tcmp.upt_dt,  'YYYYMMDDHH24MIss') <= concat(#{eDate}, ' 23:59:59')::timestamp)
										]]>
									</if>
										 and tcmpm.del_yn = 'N'
								   	 ) tcmpm
							   	 where tcmpm.mtrl_no = tcm.mtrl_no
							 )
		</if>
		  and tcm.usg_yn = 'Y'
		  and tcm.del_yn = 'N'
	</select>
	
	<select id="selectBsendCommPopList" parameterType="sqlMap" resultType="sqlMap">
		/* selectBsendCommPopList */
		select a.otsr_con_bsen_id
		      ,a.otsr_con_bsen_nm
		  from tb_sh_otsr_con_bsen a
		 where a.usg_yn = 'Y'
		<if test='otsr_con_bsen_nm != null and otsr_con_bsen_nm != ""'>
		  and a.otsr_con_bsen_nm like concat('%', trim(BOTH FROM #{otsr_con_bsen_nm}::text), '%')
		</if>
	</select>
	
	<select id="selectBsendUserCommPopList" parameterType="sqlMap" resultType="sqlMap">
		/* selectBsendUserCommPopList */
		select a.oprr_id
		      ,a.oprr_nm
		      ,a.otsr_con_bsen_id
		      ,(select b.otsr_con_bsen_nm 
		          from tb_sh_otsr_con_bsen b
		         where b.otsr_con_bsen_id = a.otsr_con_bsen_id
		       ) as otsr_con_bsen_nm
		      ,a.oprn_cl_cd
		      ,fn_get_cd('SH00000010', a.oprn_cl_cd, 'NM', #{SESS_LANG}) as oprn_cl_nm
		  from tb_sh_otsr_con_oprr a
		 where a.oprr_del_yn = 'N'
		<if test='otsr_con_bsen_nm != null and otsr_con_bsen_nm != ""'>
		  and exists (select 1
		      			from tb_sh_otsr_con_bsen b
		      		   where b.otsr_con_bsen_id = a.otsr_con_bsen_id 
		      			 and b.otsr_con_bsen_nm like concat('%', trim(BOTH FROM #{otsr_con_bsen_nm}::text), '%')
		             )
		</if>
		<if test='oprr_nm != null and oprr_nm != ""'>
		  and a.oprr_nm like concat('%', trim(BOTH FROM #{oprr_nm}::text), '%')
		</if>
	</select>
</mapper>