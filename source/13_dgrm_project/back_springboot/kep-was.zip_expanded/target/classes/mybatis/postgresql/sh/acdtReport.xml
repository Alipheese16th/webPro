<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.acdtmgnt.mapper.AcdtReportMapper">

	<select id="selectAcdtTot1" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtTot1 */
		with acdt as (
			select
			(count(case when t1.acdt_cl_cd = 'S01' then 1 end) +
			 count(case when t1.acdt_cl_cd = 'S02' then 1 end) + 
			 count(case when t1.acdt_cl_cd = 'S03' then 1 end) + 
			 count(case when t1.acdt_cl_cd = 'S04' then 1 end) + 
			 count(case when t1.acdt_cl_cd = 'S05' then 1 end)) as tot
			,count(case when t1.inac_yn ='Y' then 1 end) as inac_cnt /*산재승인*/
			,count(case when t1.acdt_cl_cd = 'S01' then 1 end) as s01_cnt /*중대재해*/
			,count(case when t1.acdt_cl_cd = 'S02' then 1 end) as s02_cnt /*고위험사고*/
			,count(case when t1.acdt_cl_cd = 'S03' then 1 end) as s03_cnt /*병원치료*/
			,count(case when t1.acdt_cl_cd = 'S04' then 1 end) as s04_cnt /*경미사고*/
			,count(case when t1.acdt_cl_cd = 'S05' then 1 end) as s05_cnt /*아차사고*/
			from tb_sh_acdt t1
			left outer join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
			join tb_sh_wkpl_cat_mapg swcm on t1.wkpl_id = swcm.wkpl_id and swcm.wkpl_cat_cd ='AP02'
		   where 1 = 1
		  <if test='now != null and now == "Y"'>
		   	and to_char(t1.acdt_occr_tsp,'YYYY') = to_char(now(), 'YYYY')
		  </if>
		  <if test='now != null and now == "N"'>
		   	and to_char(t1.acdt_occr_tsp,'YYYYMMDD') between to_char(now() + '-1 years', 'YYYY0101') and to_char(now() + '-1 years', 'YYYYMMDD')
		  </if>
		   	and t1.del_yn = 'N'
		   	and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		   	and t2.dfdt_cl_cd in ('01', '09')
	   ),
	   prsn as (
	       	select 
	       		sum(wkpl_work_prsn_cnt) as prsn_cnt
	       	from tb_sh_wkpl 
	   		where cmpy_cd = '1100' and del_yn = 'N'
	   )
	   select 
	   	tot
	   	,inac_cnt
	   	,s01_cnt
	   	,s02_cnt
	   	,s03_cnt
	   	,s04_cnt
	   	,s05_cnt
	   	,round((tot / prsn_cnt * 100)::numeric, 2) as ratio1
	   	,round((inac_cnt / (prsn_cnt * 8 * 20 * 12 * 1000000))::numeric, 2) as ratio2
	   from acdt a, prsn b
	</select>
	
	<select id="selectAcdtTot2" parameterType="sqlMap" resultType="sqlMap">
		/* selectAcdtTot2 */
		with acdt as (
			select
			(count(case when t1.acdt_cl_cd = 'S01' then 1 end) +
			 count(case when t1.acdt_cl_cd = 'S02' then 1 end) + 
			 count(case when t1.acdt_cl_cd = 'S03' then 1 end) + 
			 count(case when t1.acdt_cl_cd = 'S04' then 1 end) + 
			 count(case when t1.acdt_cl_cd = 'S05' then 1 end)) as tot
			,count(case when t1.inac_yn ='Y' then 1 end) as inac_cnt /*산재승인*/
			,count(case when t1.acdt_cl_cd = 'S01' then 1 end) as s01_cnt /*중대재해*/
			,count(case when t1.acdt_cl_cd = 'S02' then 1 end) as s02_cnt /*고위험사고*/
			,count(case when t1.acdt_cl_cd = 'S03' then 1 end) as s03_cnt /*병원치료*/
			,count(case when t1.acdt_cl_cd = 'S04' then 1 end) as s04_cnt /*경미사고*/
			,count(case when t1.acdt_cl_cd = 'S05' then 1 end) as s05_cnt /*아차사고*/
			from tb_sh_acdt t1
			left outer join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
			join tb_sh_wkpl_cat_mapg swcm on t1.wkpl_id = swcm.wkpl_id and swcm.wkpl_cat_cd ='AP02'
		   where 1 = 1
		  <if test='now != null and now == "Y"'>
		   	and to_char(t1.acdt_occr_tsp,'YYYY') = to_char(now(), 'YYYY')
		  </if>
		  <if test='now != null and now == "N"'>
		   	and to_char(t1.acdt_occr_tsp,'YYYYMMDD') between to_char(now() + '-1 years', 'YYYY0101') and to_char(now() + '-1 years', 'YYYYMMDD')
		  </if>
		   	and t1.del_yn = 'N'
		   	and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		   	and t2.dfdt_cl_cd in ('02', '08')
	   ),
	   prsn as (
	       	select 
	       		sum(sbcn_prsn_cnt) as prsn_cnt
	       	from tb_sh_wkpl_rsdt_sbcn a, tb_sh_wkpl b
			where a.wkpl_id = b.wkpl_id 
				and b.cmpy_cd = '1100' and b.del_yn = 'N'
	   )
	   select 
	   	tot
	   	,inac_cnt
	   	,s01_cnt
	   	,s02_cnt
	   	,s03_cnt
	   	,s04_cnt
	   	,s05_cnt
	   	,round((tot / prsn_cnt * 100)::numeric, 2) as ratio1
	   	,round((inac_cnt / (prsn_cnt * 8 * 20 * 12 * 1000000))::numeric, 2) as ratio2
	   from acdt a, prsn b
	</select>
	
	<select id="selectApTot" parameterType="sqlMap" resultType="sqlMap">
		/* selectApTot */
		select
			to_char(t1.acdt_occr_tsp,'YY') as yy
			,t3.wkpl_main_bsns_cd
			,case when t2.dfdt_cl_cd = '09' then '01' when t2.dfdt_cl_cd = '08' then '02' else t2.dfdt_cl_cd end dfdt_cl_cd
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_dfdt t2
			on t1.acdt_id = t2.acdt_id
		join tb_sh_wkpl t3
			on t1.wkpl_id = t3.wkpl_id
		where to_char(t1.acdt_occr_tsp,'YY') between to_char(now() + '-2 years', 'YY') and to_char(now(), 'YY')
			and t3.wkpl_main_bsns_cd in ('SG01', 'SG02', 'SG03', 'SG04', 'SG05', 'SG06', 'SG07')
			and t1.del_yn = 'N'
			and t2.dfdt_cl_cd in ('01', '02', '08', '09')
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by to_char(t1.acdt_occr_tsp,'YY'), t3.wkpl_main_bsns_cd, t2.dfdt_cl_cd
		order by yy, wkpl_main_bsns_cd, dfdt_cl_cd
	</select>
	
	<select id="selectApWkpl" parameterType="sqlMap" resultType="sqlMap">
		/* selectApWkpl */
		select
			to_char(t1.acdt_occr_tsp,'YY') as yy
			,case when t2.dfdt_cl_cd = '09' then '01' when t2.dfdt_cl_cd = '08' then '02' else t2.dfdt_cl_cd end dfdt_cl_cd
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_dfdt t2
			on t1.acdt_id = t2.acdt_id
		where to_char(t1.acdt_occr_tsp,'YY') between to_char(now() + '-2 years', 'YY') and to_char(now(), 'YY')
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list}, ','))
			and t1.del_yn = 'N'
			and t2.dfdt_cl_cd in ('01', '02', '08', '09')
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by to_char(t1.acdt_occr_tsp,'YY'), t2.dfdt_cl_cd
		order by yy, dfdt_cl_cd
	</select>
	
	<select id="selectCat" parameterType="sqlMap" resultType="sqlMap">
		/* selectCat */
		select 
			wkpl_cat_cd as val
			,fn_get_cd('ST00000022', wkpl_cat_cd, 'nm', 'KO') as txt
		from tb_sh_wkpl_cat_mapg
		where del_yn = 'N'
		group by wkpl_cat_cd
		order by wkpl_cat_cd
	</select>
	
	<select id="selectWkpl" parameterType="sqlMap" resultType="sqlMap">
		/* selectWkpl */
		select 
			wkpl_id as val
			,fn_get_cd('ST00000002', wkpl_id, 'nm', 'KO') as txt
		from tb_sh_wkpl_cat_mapg
		where del_yn = 'N'
		group by wkpl_id
		order by wkpl_id
	</select>
	
	<select id="selecCatWkpl" parameterType="sqlMap" resultType="sqlMap">
		/* selecCatWkpl */
		select 
			wkpl_cat_cd 
			,wkpl_id 
		from tb_sh_wkpl_cat_mapg
		where del_yn = 'N'
		order by wkpl_cat_cd, wkpl_id
	</select>
	
	<select id="selecAcdtPerQt" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtPerQt */
		select
			to_char(t1.acdt_occr_tsp,'YY') as yy
			,extract(quarter from t1.acdt_occr_tsp) as qt
			,case when t2.dfdt_cl_cd = '09' then '01' when t2.dfdt_cl_cd = '08' then '02' else t2.dfdt_cl_cd end dfdt_cl_cd
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_dfdt t2
			on t1.acdt_id = t2.acdt_id
		where 1 = 1
		<choose>
			<when test='period1 =="2"'>
			and to_char(t1.acdt_occr_tsp,'YY') between to_char(now() - interval '2 years', 'YY') and to_char(now(), 'YY')
			</when>
			<when test='period1 =="3"'>
			and to_char(t1.acdt_occr_tsp,'YY') between to_char(now() - interval '3 years', 'YY') and to_char(now(), 'YY')
			</when>
			<when test='period1 =="4"'>
			and to_char(t1.acdt_occr_tsp,'YY') between to_char(now() - interval '4 years', 'YY') and to_char(now(), 'YY')
			</when>
		</choose>
		<choose>
			<when test='wkpl_list1 != null and wkpl_list1 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list1}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
			and t1.del_yn = 'N'
			and t2.dfdt_cl_cd in ('01', '02', '08', '09')
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by to_char(t1.acdt_occr_tsp,'YY'), extract(quarter from t1.acdt_occr_tsp), t2.dfdt_cl_cd
		order by yy, qt, dfdt_cl_cd
	</select>
	
	<select id="selecAcdtPerMon" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtPerMon */
		select
			to_char(t1.acdt_occr_tsp,'YY') as yy
			,extract(month from t1.acdt_occr_tsp) as mm
			,case when t2.dfdt_cl_cd = '09' then '01' when t2.dfdt_cl_cd = '08' then '02' else t2.dfdt_cl_cd end dfdt_cl_cd
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_dfdt t2
			on t1.acdt_id = t2.acdt_id
		where 1 = 1
		<choose>
			<when test='period2 != null and period2 != ""'>
			and to_char(t1.acdt_occr_tsp,'YYYY') = #{period2}
			</when>
			<otherwise>
			and to_char(t1.acdt_occr_tsp,'YY') between to_char(now() - interval '1 years', 'YY') and to_char(now(), 'YY')
			</otherwise>
		</choose>
		<choose>
			<when test='wkpl_list1 != null and wkpl_list1 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list1}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
			and t1.del_yn = 'N'
			and t2.dfdt_cl_cd in ('01', '02', '08', '09')
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by to_char(t1.acdt_occr_tsp,'YY'), extract(month from t1.acdt_occr_tsp), t2.dfdt_cl_cd
		order by yy, mm, dfdt_cl_cd
	</select>
	
	<select id="selecAcdtType" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtType */
		select 
			(row_number() over(order by count(*) desc)) as rownum
			,t1.acdt_tp_cd as cd
			,fn_get_cd('SH00000071', t1.acdt_tp_cd, 'nm', #{SESS_LANG}) as label
			,count(*) as cnt
		from tb_sh_acdt t1
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by t1.acdt_tp_cd
		order by cnt desc
	</select>
	
	<select id="selecAcdtOprn" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtOprn */
		select 
			(row_number() over(order by count(*) desc)) as rownum
			,t2.acdt_oprn_txt_cl_cd as cd
			,fn_get_cd('SH00000026', t2.acdt_oprn_txt_cl_cd, 'nm', #{SESS_LANG}) as label
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_oprn_txt t2
			on t1.acdt_id = t2.acdt_id 
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t2.oprn_txt_chc_yn ='Y'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by t2.acdt_oprn_txt_cl_cd
		order by cnt desc
	</select>
	
	<select id="selecAcdtUsftTxt" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtUsftTxt */
		select 
			(row_number() over(order by count(*) desc)) as rownum
			,t2.usft_txt_cl_cd as cd
			,fn_get_cd('SH00000027', t2.usft_txt_cl_cd, 'nm', #{SESS_LANG}) as label
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_usft_txt t2
			on t1.acdt_id = t2.acdt_id 
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t2.usft_txt_chc_yn ='Y'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by t2.usft_txt_cl_cd
		order by cnt desc
	</select>
	
	<select id="selecAcdtUsftSt" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtUsftSt */
		select 
			(row_number() over(order by count(*) desc)) as rownum
			,t2.usft_st_cd as cd
			,fn_get_cd('SH00000028', t2.usft_st_cd, 'nm', #{SESS_LANG}) as label
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_usft_st t2
			on t1.acdt_id = t2.acdt_id 
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t2.usft_txt_chc_yn ='Y'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by t2.usft_st_cd
		order by cnt desc
	</select>
	
	<select id="selecAcdtCausTgt" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtCausTgt */
		select 
			(row_number() over(order by count(*) desc)) as rownum
			,t1.acdt_caus_tgt_cd as cd
			,fn_get_cd('SH00000072', t1.acdt_caus_tgt_cd, 'nm', #{SESS_LANG}) as label
			,count(*) as cnt
		from tb_sh_acdt t1
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by t1.acdt_caus_tgt_cd
		order by cnt desc
	</select>
	
	<select id="selecAcdtPrst" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtPrst */
		with acdt as (
			select 
				count(case when t1.acdt_prst_cd = '2' or t1.acdt_prst_cd = '3' or t1.acdt_prst_cd = '4' then 1 end) as cnt1 /* 조치완료  */
				,count(case when t1.acdt_prst_cd = '0' or t1.acdt_prst_cd = '1' or t1.acdt_prst_cd = '5' then 1 end) as cnt2 /* 진행중  */
				,count(case when t1.acdt_prst_cd = '6' then 1 end) as cnt3 /* 조치지연  */
			from tb_sh_acdt t1
			where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
			<choose>
				<when test='wkpl_list2 != null and wkpl_list2 != ""'>
				and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
				</when>
				<otherwise>
				and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
				</otherwise>
			</choose>
			and t1.del_yn = 'N'
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		)
		select 
			(cnt1 + cnt2 + cnt3) as tot
			,cnt1
			,cnt2
			,cnt3 
			,case when cnt1 = 0 then 0 else round((cnt1 / ((cnt1 + cnt2 + cnt3) * 1.0)) * 100) end as ratio1
			,case when (cnt2 + cnt3) = 0 then 0 else round(((cnt2 + cnt3) / ((cnt1 + cnt2 + cnt3) * 1.0)) * 100) end as ratio2
		from acdt
	</select>
	
	<select id="selecAcdtDept" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtDept */
		select
			t1.wkpl_id
			,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
			,t2.dfdt_dept_nm
			,count(*) as cnt
		from tb_sh_acdt t1
		join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by t1.wkpl_id, t2.dfdt_dept_nm
		order by cnt desc
		limit 3
	</select>
	
	<select id="selecAcdtPeriod" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtPeriod */
		with acdt as (
			select 
				t2.dfdt_pric_id 
				,round(((extract(year from age(case when t3.joinc_da = '' then null else t3.joinc_da end::timestamp))::numeric * 12) + extract(month from age(case when t3.joinc_da = '' then null else t3.joinc_da end::timestamp))::numeric) / 12, 1) as period
			from tb_sh_acdt t1
			join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
			join tb_co_user t3 on t3.usr_id = t2.dfdt_pric_id and joinc_da is not null
			where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
			<choose>
				<when test='wkpl_list2 != null and wkpl_list2 != ""'>
				and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
				</when>
				<otherwise>
				and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
				</otherwise>
			</choose>
			and t1.del_yn = 'N'
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
			group by t2.dfdt_pric_id, t3.joinc_da
		)
		select 
			count(case when period <![CDATA[<]]> 1 then 1 end) as cnt1
			,count(case when period <![CDATA[>=]]> 1 and period <![CDATA[<]]> 3 then 1 end) as cnt2
			,count(case when period <![CDATA[>=]]> 3 and period <![CDATA[<]]> 10 then 1 end) as cnt3
			,count(case when period <![CDATA[>]]> 10 then 1 end) as cnt4
		from acdt
	</select>
	
	<select id="selecAcdtHh" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtHh */
		select 
			substring(t1.acdt_occr_hm, 1, 2) as hh
			,count(*) as cnt
		from tb_sh_acdt t1
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by substring(t1.acdt_occr_hm, 1, 2)
		order by hh
	</select>
	
	<select id="selecAcdtMm" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtMm */
		select 
			to_char(t1.acdt_occr_tsp, 'MM') as mm
			,count(*) as cnt
		from tb_sh_acdt t1
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by to_char(t1.acdt_occr_tsp, 'MM')
		order by mm
	</select>
	
	<select id="selecAcdtDow" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtDow */
		select 
			extract(dow from t1.acdt_occr_tsp) as dow
			,count(*) as cnt
		from tb_sh_acdt t1
		where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
		<choose>
			<when test='wkpl_list2 != null and wkpl_list2 != ""'>
			and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
			</when>
			<otherwise>
			and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
			</otherwise>
		</choose>
		and t1.del_yn = 'N'
		and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
		and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		group by extract(dow from t1.acdt_occr_tsp)
		order by dow
	</select>
	
	<select id="selecAcdtCareDays" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtCareDays */
		with acdt as (
			select 
				t2.dfdt_care_days as dd
			from tb_sh_acdt t1
			join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
			where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
			<choose>
				<when test='wkpl_list2 != null and wkpl_list2 != ""'>
				and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
				</when>
				<otherwise>
				and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
				</otherwise>
			</choose>
			and t1.del_yn = 'N'
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		)
		select 
			count(case when dd <![CDATA[<]]> 3 then 1 end) as cnt1
			,count(case when dd <![CDATA[>=]]> 3 then 1 end) as cnt2
			,count(*) as tot
			,coalesce(round(avg(case when dd <![CDATA[<]]> 3 then dd end), 1), 0) as avg1
			,coalesce(round(avg(case when dd <![CDATA[>=]]> 3 then dd end), 1), 0) as avg2
			,coalesce(round(avg(dd), 1), 0) as tot_avg
		from acdt
	</select>
	
	<select id="selecAcdtAge" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtAge */
		with acdt as (
			select 
				t2.dfdt_age as age
			from tb_sh_acdt t1
			join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
			where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
			<choose>
				<when test='wkpl_list2 != null and wkpl_list2 != ""'>
				and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
				</when>
				<otherwise>
				and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
				</otherwise>
			</choose>
			and t1.del_yn = 'N'
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		)
		select 
			count(case when age <![CDATA[>=]]> 20 and age <![CDATA[<]]> 30 then 1 end) as cnt1
			,count(case when age <![CDATA[>=]]> 30 and age <![CDATA[<]]> 40 then 1 end) as cnt2
			,count(case when age <![CDATA[>=]]> 40 and age <![CDATA[<]]> 50 then 1 end) as cnt3
			,count(case when age <![CDATA[>=]]> 50 and age <![CDATA[<]]> 60 then 1 end) as cnt4
			,count(case when age <![CDATA[>=]]> 60 then 1 end) as cnt5
		from acdt
	</select>
	
	<select id="selecAcdtSex" parameterType="sqlMap" resultType="sqlMap">
		/* selecAcdtSex */
		with acdt as (
			select 
				t2.dfdt_sex_cd as sex
			from tb_sh_acdt t1
			join tb_sh_acdt_dfdt t2 on t1.acdt_id = t2.acdt_id
			where to_char(t1.acdt_occr_tsp, 'YYYY-MM') between #{sDate} and #{eDate}
			<choose>
				<when test='wkpl_list2 != null and wkpl_list2 != ""'>
				and t1.wkpl_id = ANY (regexp_split_to_array(#{wkpl_list2}, ','))
				</when>
				<otherwise>
				and t1.wkpl_id in (select wkpl_id from tb_sh_wkpl_cat_mapg where wkpl_cat_cd = 'AP01' and del_yn = 'N')
				</otherwise>
			</choose>
			and t1.del_yn = 'N'
			and t1.acdt_cl_cd != 'S04' -- 경미사고 제외
			and t1.acdt_dtl_cl_cd != 'SD11' -- 출퇴근사고 제외
		)
		select 
			count(case when sex = 'M' then 1 end) as cnt1
			,count(case when sex = 'F' then 1 end) as cnt2
		from acdt
	</select>

</mapper>