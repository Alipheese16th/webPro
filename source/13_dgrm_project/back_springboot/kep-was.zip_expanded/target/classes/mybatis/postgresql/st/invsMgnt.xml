<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.st.stndinfr.mapper.InvsMgntMapper">

	<!-- 사업장별 투자 관리 조회 -->
	<select id="selectInvsMgntList" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntList  */
		select a.wkpl_id
		      ,fn_get_cd('ST00000002', a.wkpl_id, 'NM', #{SESS_LANG}) as wkpl_nm
		      ,b.cmpy_cd
		      ,b.wkpl_main_bsns_cd
		      ,fn_get_cd('ST00000015', b.wkpl_main_bsns_cd, 'NM', #{SESS_LANG}) as wkpl_main_bsns_nm
		      ,a.invs_year
		      ,fn_get_cd('CO00000009', b.cmpy_cd, 'NM', #{SESS_LANG}) as cmpy_nm
		      ,a.invs_prst_cd
		      ,fn_get_cd('ST00000016', a.invs_prst_cd, 'NM', #{SESS_LANG}) as invs_prst_nm
		      ,case when c.invs_item_amt > 0 then c.invs_item_amt / 1000 else 0 end as invs_item_amt
		      ,case when d.prfr_amt > 0 then d.prfr_amt / 1000 else 0 end as prfr_amt
		      ,case when d.prfr_amt > 0 and c.invs_item_amt > 0 then d.prfr_amt / c.invs_item_amt * 100 else 0 end as amt_per
		      ,(select u.dept_cd
			      from tb_co_user u
			     where u.usr_id = a.upt_usr_id
			   ) as dept_cd
		  from tb_sh_wkpl_invs a
		 inner join tb_sh_wkpl b 
		  		 on a.wkpl_id = b.wkpl_id
		  left outer join (select c.wkpl_id
					             ,c.invs_year
					             ,sum(c.invs_item_amt) as invs_item_amt
					         from tb_sh_wkpl_invs_item c
					        where 1 = 1
							<if test='invs_cat_cd != null and invs_cat_cd != ""'>
							  and c.invs_cat_cd = #{invs_cat_cd}
							</if>
					        group by c.invs_year, c.wkpl_id
					      ) c 
		    		   on a.wkpl_id = c.wkpl_id 
			   			  and a.invs_year = c.invs_year
		  left outer join (select c.wkpl_id
					             ,c.invs_year
					             ,sum(c.prfr_amt) as prfr_amt
					         from tb_sh_wkpl_mtly_prfr c
					        where 1=1
					        <if test='sDatez != null and sDatez != "" and eDatez != null and eDatez != ""'>
							  and c.invs_year || c.prfr_reg_mth between replace(#{sDate},'-','') and replace(#{eDate},'-','')
							</if>
							<if test='invs_cat_cd != null and invs_cat_cd != ""'>
							  and c.invs_cat_cd = #{invs_cat_cd}
							</if>
					        group by c.invs_year, c.wkpl_id
					      ) d
					   on a.wkpl_id = d.wkpl_id
					      and a.invs_year = d.invs_year
		 where a.invs_year = #{invs_year}
		 <if test='cmpy_cd != null and cmpy_cd != ""'>
		   and b.cmpy_cd = #{cmpy_cd}
		 </if>
		 <if test='wkpl_id != null and wkpl_id != ""'>
		   and a.wkpl_id = #{wkpl_id}
		 </if>
		 order by a.wkpl_id
	</select>
	
	<!-- 사업장별 투자 관리 상세 기본 조회 -->
	<select id="selectInvsMgntDtlInfo" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntDtlInfo  */
		select a.wkpl_id
		      ,fn_get_cd('ST00000002', a.wkpl_id, 'NM', #{SESS_LANG}) as wkpl_nm
		      ,a.invs_year
		      ,round(a.yrly_invs_amt,0) as yrly_invs_amt
		      ,a.invs_rel_guid_txt
		      ,a.wkpl_note_txt
		      ,a.invs_atfl_no
		      ,a.invs_aprv_no
		      ,a.invs_prst_cd
		      ,fn_get_cd('ST00000016', a.invs_prst_cd, 'NM', #{SESS_LANG}) as invs_prst_nm
		      ,a.crt_usr_id
		      ,to_char(a.upt_dt, 'YYYY-MM-DD') as upt_dt
		      ,(select case when #{SESS_LANG} = 'KO' then u.usr_ko_nm 
				            when #{SESS_LANG} = 'EN' then u.usr_en_nm 
				            else u.usr_zh_nm 
				       end as usr_nm
			      from tb_co_user u
			     where u.usr_id = a.upt_usr_id
			   ) as lsch_nm
		  from tb_sh_wkpl_invs a
		 where a.wkpl_id = #{wkpl_id}
		   and a.invs_year = #{invs_year}
	</select>
	
	<!-- 사업장별 투자 관리 상세 계획 조회 -->
	<select id="selectInvsMgntDtlPlan" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntDtlPlan  */
		select 'Y' as chk_gb
		      ,a.wkpl_id
		      ,a.invs_year
		      ,a.invs_item_reg_sn
		      ,a.invs_item_nm
		      ,round(a.invs_item_amt,0) as invs_item_amt
		      ,a.wkpl_invs_item
		      ,fn_get_cd('ST00000021', a.wkpl_invs_item, 'NM', #{SESS_LANG}) as tb_sh_wkpl_invs_item_nm
		      ,a.invs_cat_cd
		      ,fn_get_cd('ST00000014', a.invs_cat_cd, 'NM', #{SESS_LANG}) as invs_cat_nm
		  from tb_sh_wkpl_invs_item a
		 where a.wkpl_id = #{wkpl_id}
		   and a.invs_year = #{invs_year}
		 order by a.invs_cat_cd, a.wkpl_invs_item
	</select>
	
	<!-- 사업장별 투자 관리 상세 실적 조회 -->
	<select id="selectInvsMgntDtlRslt" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntDtlRslt  */
		select 'Y' as chk_gb
		      ,a.wkpl_id
		      ,a.invs_year
		      ,a.invs_item_reg_sn
		      ,a.prfr_reg_mth
		      ,fn_get_cd('CO00000033', a.prfr_reg_mth, 'NM', #{SESS_LANG}) as prfr_reg_mth_nm
		      ,round(a.prfr_amt,0) as prfr_amt
		      ,a.prfr_txt
		      ,a.invs_stpl_item_cd
		      ,fn_get_cd('ST00000021', a.invs_stpl_item_cd, 'NM', #{SESS_LANG}) as invs_stpl_item_nm
		      ,a.invs_cat_cd
		      ,fn_get_cd('ST00000014', a.invs_cat_cd, 'NM', #{SESS_LANG}) as invs_cat_nm
		  from tb_sh_wkpl_mtly_prfr a
		 where a.wkpl_id = #{wkpl_id}
		   and a.invs_year = #{invs_year}
		 order by a.prfr_reg_mth, a.invs_cat_cd, a.invs_stpl_item_cd
	</select>
	
	<!-- 사업장별 투자 관리 중복체크 -->
	<select id="selectInvsMgntPass" parameterType="sqlMap" resultType="string">
		/* selectInvsMgntPass */
		select case when count(1) > 0 then 'N'
		            else 'Y'
		       end as pass_yn
		  from tb_sh_wkpl_invs 
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
	</select>
	
	<!-- 사업장별 투자 계획 중복체크 -->
	<select id="selectInvsMgntPlanPass" parameterType="sqlMap" resultType="string">
		/* selectInvsMgntPlanPass */
		select case when count(1) > 0 then 'N'
		            else 'Y'
		       end as pass_yn
		  from tb_sh_wkpl_invs_item a
		 where a.wkpl_id = #{wkpl_id}
		   and a.invs_year = #{invs_year}
		   and a.invs_cat_cd = #{invs_cat_cd}
		   and a.wkpl_invs_item = #{tb_sh_wkpl_invs_item}
	</select>
	
	<!-- 사업장별 투자 관리 상세 기본정보 저장 -->
	<insert id="insertInvsMgntDtlInfo" parameterType="sqlMap">
        /* insertInvsMgntDtlInfo */
        with upsert as (
		update tb_sh_wkpl_invs
		   set yrly_invs_amt     = 0
		      ,invs_rel_guid_txt = #{invs_rel_guid_txt}
		      ,wkpl_note_txt	 = #{wkpl_note_txt}
		      ,invs_prst_cd  = #{invs_prst_cd}
		      ,invs_atfl_no = case when #{invs_atfl_no}::text  = '' then null 
						   	 		    else #{invs_atfl_no}::INTEGER 
				    	 		   end
		      ,upt_usr_id       	 = #{username}
		      ,upt_dt          = current_timestamp
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year} RETURNING *
		)
        insert into tb_sh_wkpl_invs (
        	   wkpl_id
			  ,invs_year
			  ,yrly_invs_amt
			  ,invs_rel_guid_txt
			  ,wkpl_note_txt
			  ,invs_prst_cd
			  ,invs_atfl_no
			  ,crt_usr_id
			  ,crt_dt
			  ,upt_usr_id
			  ,upt_dt
		)
		select #{wkpl_id}
		      ,#{invs_year}
	 		  ,0
	 		  ,#{invs_rel_guid_txt}
			  ,#{wkpl_note_txt}
			  ,#{invs_prst_cd}
			  ,case when #{invs_atfl_no}::text  = '' then null 
	   			    else #{invs_atfl_no}::INTEGER 
   	 		   end
			  ,#{username}
			  ,current_timestamp
			  ,#{username}
			  ,current_timestamp
	     where not exists (select * from upsert)
    </insert>
	
	<!-- 사업장별 투자 관리 상세 계획 저장 -->
	<insert id="insertInvsMgntDtlPlan" parameterType="sqlMap">
        /* insertInvsMgntDtlPlan */
        with upsert as (
		update tb_sh_wkpl_invs_item
		   set invs_cat_cd    		= #{invs_cat_cd}
		      ,invs_item_nm    			= #{invs_item_nm}
		      ,invs_item_amt			= #{invs_item_amt}::numeric
		      ,tb_sh_wkpl_invs_item 	= #{tb_sh_wkpl_invs_item}
		      ,upt_usr_id       			= #{username}
		      ,upt_dt            		= current_timestamp
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
		   and invs_item_reg_sn = #{invs_item_reg_sn}::numeric RETURNING *
		)
        insert into tb_sh_wkpl_invs_item (
        	   wkpl_id
			  ,invs_year
			  ,invs_item_reg_sn
			  ,invs_cat_cd
			  ,tb_sh_wkpl_invs_item
			  ,invs_item_nm
			  ,invs_item_amt
			  ,crt_usr_id
			  ,crt_dt
			  ,upt_usr_id
			  ,upt_dt
		)
		select #{wkpl_id}
		      ,#{invs_year}
	 		  ,(select coalesce(max(invs_item_reg_sn ::integer),0) + 1 as key
		          from tb_sh_wkpl_invs_item
		         where wkpl_id = #{wkpl_id}
		           and invs_year = #{invs_year}
		       )
	 		  ,#{invs_cat_cd}
			  ,#{tb_sh_wkpl_invs_item}
			  ,#{invs_item_nm}
			  ,#{invs_item_amt}::numeric
			  ,#{username}
			  ,current_timestamp
			  ,#{username}
			  ,current_timestamp
	     where not exists (select * from upsert)
    </insert>
    
    <!-- 사업장별 투자 관리 상세 실적 저장 -->
	<insert id="insertInvsMgntDtlRslt" parameterType="sqlMap">
        /* insertInvsMgntDtlRslt */
        with upsert as (
		update tb_sh_wkpl_mtly_prfr
		   set prfr_amt    				= #{prfr_amt}::numeric
		      ,prfr_txt    				= #{prfr_txt}
		      ,invs_cat_cd			= #{invs_cat_cd}
		      ,invs_stpl_item_cd 	= #{invs_stpl_item_cd}
		      ,upt_usr_id       			= #{username}
		      ,upt_dt            		= current_timestamp
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
		   and invs_item_reg_sn = #{invs_item_reg_sn}::numeric
		   and prfr_reg_mth = #{prfr_reg_mth} RETURNING *
		)
        insert into tb_sh_wkpl_mtly_prfr (
        	   wkpl_id
			  ,invs_year
			  ,invs_item_reg_sn
			  ,prfr_reg_mth
			  ,prfr_amt
			  ,prfr_txt
			  ,invs_cat_cd
			  ,invs_stpl_item_cd
			  ,crt_usr_id
			  ,crt_dt
			  ,upt_usr_id
			  ,upt_dt
		)
		select #{wkpl_id}
		      ,#{invs_year}
	 		  ,#{invs_item_reg_sn}::numeric
	 		  ,#{prfr_reg_mth}
			  ,#{prfr_amt}::numeric
			  ,#{prfr_txt}
			  ,#{invs_cat_cd}
			  ,#{invs_stpl_item_cd}
			  ,#{username}
			  ,current_timestamp
			  ,#{username}
			  ,current_timestamp
	     where not exists (select * from upsert)
    </insert>
    
    <!-- 사업장별 투자 관리 상세 기본정보 삭제 -->
    <delete id="deleteInvsMgntDtlInfoDel" parameterType="sqlMap">
        /* deleteInvsMgntDtlInfoDel */
        delete 
          from tb_sh_wkpl_invs
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
    </delete>
    
    <!-- 사업장별 투자 관리 상세 계획 전체 삭제 -->
    <delete id="deleteInvsMgntDtlPlanAll" parameterType="sqlMap">
        /* deleteInvsMgntDtlPlanAll */
        delete 
          from tb_sh_wkpl_invs_item
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
    </delete>
    
     <!-- 사업장별 투자 관리 상세 실적 전체 삭제 -->
    <delete id="deleteInvsMgntDtlRsltAll" parameterType="sqlMap">
        /* deleteInvsMgntDtlRsltAll */
        delete 
          from tb_sh_wkpl_mtly_prfr
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
    </delete>
    
    <!-- 사업장별 투자 관리 상세 계획 삭제 -->
    <delete id="deleteInvsMgntDtlPlan" parameterType="sqlMap">
        /* deleteInvsMgntDtlPlan */
        delete 
          from tb_sh_wkpl_invs_item
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
		   and invs_item_reg_sn = #{invs_item_reg_sn}::numeric
    </delete>
    
    <!-- 사업장별 투자 관리 상세 실적 삭제 -->
    <delete id="deleteInvsMgntDtlRslt" parameterType="sqlMap">
        /* deleteInvsMgntDtlRslt */
        delete 
          from tb_sh_wkpl_mtly_prfr
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
		   and invs_item_reg_sn = #{invs_item_reg_sn}::numeric
		   and prfr_reg_mth = #{prfr_reg_mth}
    </delete>
    
    <!-- 사업장별 투자 관리 상세 투자 계획대비집행 조회 -->
	<select id="selectInvsMgntDtlTotRslt" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntDtlTotRslt  */
		select a.wkpl_id
		      ,a.invs_year
		      ,a.invs_cat_cd
		      ,fn_get_cd('ST00000014', a.invs_cat_cd, 'NM', #{SESS_LANG}) as invs_cat_nm
		      ,case when b.invs_item_amt > 0 then round(b.invs_item_amt / 1000,0) else 0 end as invs_item_amt
		      ,case when a.prfr_amt_tot > 0 and b.invs_item_amt > 0 then round(a.prfr_amt_tot / (b.invs_item_amt / 1000) * 100,0) else 0 end as amt_per
		      ,round(a.prfr_amt_tot,0) as prfr_amt_tot
		      ,round(a.prfr_amt_01,0) as prfr_amt_01
		      ,round(a.prfr_amt_02,0) as prfr_amt_02
		      ,round(a.prfr_amt_03,0) as prfr_amt_03
		      ,round(a.prfr_amt_04,0) as prfr_amt_04
		      ,round(a.prfr_amt_05,0) as prfr_amt_05
		      ,round(a.prfr_amt_06,0) as prfr_amt_06
		      ,round(a.prfr_amt_07,0) as prfr_amt_07
		      ,round(a.prfr_amt_08,0) as prfr_amt_08
		      ,round(a.prfr_amt_09,0) as prfr_amt_09
		      ,round(a.prfr_amt_10,0) as prfr_amt_10
		      ,round(a.prfr_amt_11,0) as prfr_amt_11
		      ,round(a.prfr_amt_12,0) as prfr_amt_12
		  from (select a.wkpl_id
				      ,a.invs_year
				      ,a.invs_cat_cd
				      ,max(a.prfr_amt_tot) as prfr_amt_tot
				      ,sum(prfr_amt_01) as prfr_amt_01
				      ,sum(prfr_amt_02) as prfr_amt_02
				      ,sum(prfr_amt_03) as prfr_amt_03
				      ,sum(prfr_amt_04) as prfr_amt_04
				      ,sum(prfr_amt_05) as prfr_amt_05
				      ,sum(prfr_amt_06) as prfr_amt_06
				      ,sum(prfr_amt_07) as prfr_amt_07
				      ,sum(prfr_amt_08) as prfr_amt_08
				      ,sum(prfr_amt_09) as prfr_amt_09
				      ,sum(prfr_amt_10) as prfr_amt_10
				      ,sum(prfr_amt_11) as prfr_amt_11
				      ,sum(prfr_amt_12) as prfr_amt_12
				  from (select a.wkpl_id
						      ,a.invs_year
						      ,a.invs_cat_cd
						      ,max(b.prfr_amt_tot) as prfr_amt_tot
						      ,case when a.prfr_reg_mth = '01' then max(a.prfr_amt) else 0 end as prfr_amt_01
						      ,case when a.prfr_reg_mth = '02' then max(a.prfr_amt) else 0 end as prfr_amt_02
						      ,case when a.prfr_reg_mth = '03' then max(a.prfr_amt) else 0 end as prfr_amt_03
						      ,case when a.prfr_reg_mth = '04' then max(a.prfr_amt) else 0 end as prfr_amt_04
						      ,case when a.prfr_reg_mth = '05' then max(a.prfr_amt) else 0 end as prfr_amt_05
						      ,case when a.prfr_reg_mth = '06' then max(a.prfr_amt) else 0 end as prfr_amt_06
						      ,case when a.prfr_reg_mth = '07' then max(a.prfr_amt) else 0 end as prfr_amt_07
						      ,case when a.prfr_reg_mth = '08' then max(a.prfr_amt) else 0 end as prfr_amt_08
						      ,case when a.prfr_reg_mth = '09' then max(a.prfr_amt) else 0 end as prfr_amt_09
						      ,case when a.prfr_reg_mth = '10' then max(a.prfr_amt) else 0 end as prfr_amt_10
						      ,case when a.prfr_reg_mth = '11' then max(a.prfr_amt) else 0 end as prfr_amt_11
						      ,case when a.prfr_reg_mth = '12' then max(a.prfr_amt) else 0 end as prfr_amt_12
						  from (select a.wkpl_id
								      ,a.invs_year
								      ,a.invs_cat_cd
								      ,a.prfr_reg_mth
								      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt
								  from tb_sh_wkpl_mtly_prfr a
								 where a.invs_year = #{invs_year}
								   and a.wkpl_id = #{wkpl_id}
								 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.prfr_reg_mth
							   ) a
							  ,(select a.wkpl_id
								      ,a.invs_year
								      ,a.invs_cat_cd
								      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt_tot
								  from tb_sh_wkpl_mtly_prfr a
								 where a.invs_year = #{invs_year}
								   and a.wkpl_id = #{wkpl_id}
								 group by a.wkpl_id,a.invs_year,a.invs_cat_cd
							   ) b
						 where a.wkpl_id = b.wkpl_id 
						   and a.invs_year = b.invs_year
						   and a.invs_cat_cd = b.invs_cat_cd
						 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.prfr_reg_mth
					  ) a
				group by a.wkpl_id,a.invs_year,a.invs_cat_cd
			   ) a
			  ,(select b.wkpl_id
			          ,b.invs_year 
			          ,b.invs_cat_cd
			          ,sum(b.invs_item_amt) as invs_item_amt
			      from tb_sh_wkpl_invs_item b
			     group by b.wkpl_id, b.invs_year, b.invs_cat_cd
			   ) b
		 where a.wkpl_id = b.wkpl_id 
		   and a.invs_year = b.invs_year 
		   and a.invs_cat_cd = b.invs_cat_cd 
		   and b.wkpl_id = #{wkpl_id}
		   and b.invs_year = #{invs_year}
		 order by a.invs_cat_cd
	</select>
	
	<!-- 전사 투자 상세현황 조회 -->
	<select id="selectInvsMgntTotList1" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntTotList  */
		select a.wkpl_id
		      ,fn_get_cd('ST00000002', a.wkpl_id, 'NM', #{SESS_LANG}) as wkpl_nm
		      ,c.wkpl_main_bsns_cd
		      ,fn_get_cd('ST00000015', c.wkpl_main_bsns_cd, 'NM', #{SESS_LANG}) as wkpl_main_bsns_nm
		      ,fn_get_cd('CO00000009', c.cmpy_cd, 'NM', #{SESS_LANG}) as cmpy_nm
		      ,a.invs_year
		      ,a.invs_cat_cd
		      ,a.invs_stpl_item_cd
		      ,fn_get_cd('ST00000014', a.invs_cat_cd, 'NM', #{SESS_LANG}) as invs_cat_nm
		      ,fn_get_cd('ST00000021', a.invs_stpl_item_cd, 'NM', #{SESS_LANG}) as invs_stpl_item_nm
		      ,case when b.invs_item_amt > 0 then b.invs_item_amt / 1000 else 0 end as invs_item_amt
		      ,case when a.prfr_amt_tot > 0 and b.invs_item_amt > 0 then a.prfr_amt_tot / (b.invs_item_amt / 1000) * 100 else 0 end as amt_per
		      ,a.prfr_amt_tot
		      ,a.prfr_amt_01
		      ,a.prfr_amt_02
		      ,a.prfr_amt_03
		      ,a.prfr_amt_04
		      ,a.prfr_amt_05
		      ,a.prfr_amt_06
		      ,a.prfr_amt_07
		      ,a.prfr_amt_08
		      ,a.prfr_amt_09
		      ,a.prfr_amt_10
		      ,a.prfr_amt_11
		      ,a.prfr_amt_12
		  from (select a.wkpl_id
				      ,a.invs_year
				      ,a.invs_cat_cd
				      ,a.invs_stpl_item_cd
				      ,max(a.prfr_amt_tot) as prfr_amt_tot
				      ,sum(prfr_amt_01) as prfr_amt_01
				      ,sum(prfr_amt_02) as prfr_amt_02
				      ,sum(prfr_amt_03) as prfr_amt_03
				      ,sum(prfr_amt_04) as prfr_amt_04
				      ,sum(prfr_amt_05) as prfr_amt_05
				      ,sum(prfr_amt_06) as prfr_amt_06
				      ,sum(prfr_amt_07) as prfr_amt_07
				      ,sum(prfr_amt_08) as prfr_amt_08
				      ,sum(prfr_amt_09) as prfr_amt_09
				      ,sum(prfr_amt_10) as prfr_amt_10
				      ,sum(prfr_amt_11) as prfr_amt_11
				      ,sum(prfr_amt_12) as prfr_amt_12
				  from (select a.wkpl_id
						      ,a.invs_year
						      ,a.invs_cat_cd
						      ,a.invs_stpl_item_cd
						      ,max(b.prfr_amt_tot) as prfr_amt_tot
						      ,case when a.prfr_reg_mth = '01' then max(a.prfr_amt) else 0 end as prfr_amt_01
						      ,case when a.prfr_reg_mth = '02' then max(a.prfr_amt) else 0 end as prfr_amt_02
						      ,case when a.prfr_reg_mth = '03' then max(a.prfr_amt) else 0 end as prfr_amt_03
						      ,case when a.prfr_reg_mth = '04' then max(a.prfr_amt) else 0 end as prfr_amt_04
						      ,case when a.prfr_reg_mth = '05' then max(a.prfr_amt) else 0 end as prfr_amt_05
						      ,case when a.prfr_reg_mth = '06' then max(a.prfr_amt) else 0 end as prfr_amt_06
						      ,case when a.prfr_reg_mth = '07' then max(a.prfr_amt) else 0 end as prfr_amt_07
						      ,case when a.prfr_reg_mth = '08' then max(a.prfr_amt) else 0 end as prfr_amt_08
						      ,case when a.prfr_reg_mth = '09' then max(a.prfr_amt) else 0 end as prfr_amt_09
						      ,case when a.prfr_reg_mth = '10' then max(a.prfr_amt) else 0 end as prfr_amt_10
						      ,case when a.prfr_reg_mth = '11' then max(a.prfr_amt) else 0 end as prfr_amt_11
						      ,case when a.prfr_reg_mth = '12' then max(a.prfr_amt) else 0 end as prfr_amt_12
						  from (select a.wkpl_id
								      ,a.invs_year
								      ,a.invs_cat_cd
								      ,a.invs_stpl_item_cd
								      ,a.prfr_reg_mth
								      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt
								  from tb_sh_wkpl_mtly_prfr a
								 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd,a.prfr_reg_mth
							   ) a
							  ,(select a.wkpl_id
								      ,a.invs_year
								      ,a.invs_cat_cd
								      ,a.invs_stpl_item_cd
								      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt_tot
								  from tb_sh_wkpl_mtly_prfr a
								 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd
							   ) b
						 where a.wkpl_id = b.wkpl_id 
						   and a.invs_year = b.invs_year
						   and a.invs_cat_cd = b.invs_cat_cd
						   and a.invs_stpl_item_cd = b.invs_stpl_item_cd
						 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd,a.prfr_reg_mth
					  ) a
				group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd
			   ) a
			  ,tb_sh_wkpl_invs_item b
			  ,tb_sh_wkpl c
			  ,tb_sh_wkpl_invs d
		 where a.wkpl_id = b.wkpl_id 
		   and a.invs_year = b.invs_year 
		   and a.invs_cat_cd = b.invs_cat_cd 
		   and a.invs_stpl_item_cd = b.wkpl_invs_item		   
		   and a.wkpl_id = d.wkpl_id 
		   and a.invs_year = d.invs_year
		   and d.wkpl_id = c.wkpl_id 
		 <if test='cmpy_cd != null and cmpy_cd != ""'>
		   and c.cmpy_cd = #{cmpy_cd}
		 </if>
		 <if test='wkpl_id != null and wkpl_id != ""'>
		   and d.wkpl_id = #{wkpl_id}
		 </if>
		 <if test='cmpy_cd != null and cmpy_cd != ""'>
		   and c.cmpy_cd = #{cmpy_cd}
		 </if>
		 <if test='wkpl_main_bsns_cd != null and wkpl_main_bsns_cd != ""'>
		   and c.wkpl_main_bsns_cd = #{wkpl_main_bsns_cd}
		 </if>
		 <if test='invs_year != null and invs_year != ""'>
		   and a.invs_year = #{invs_year}
		 </if>
		 <if test='invs_cat_cd != null and invs_cat_cd != ""'>
		   and a.invs_cat_cd = #{invs_cat_cd}
		 </if>
		 order by c.cmpy_cd, a.wkpl_id, a.invs_cat_cd, a.invs_stpl_item_cd
	</select>
	
	<!-- 전사 투자 상세현황 조회 -->
	<select id="selectInvsMgntTotList" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntTotList  */
		select a.wkpl_id
		      ,a.wkpl_nm
		      ,a.wkpl_main_bsns_cd
		      ,a.wkpl_main_bsns_nm
		      ,a.cmpy_nm
		      ,a.invs_year
		      ,a.invs_cat_cd
		      ,a.invs_stpl_item_cd
		      ,a.invs_cat_nm
		      ,a.invs_stpl_item_nm
		      ,a.invs_item_amt
		      ,a.amt_per
		      ,a.prfr_amt_tot
		      ,a.prfr_amt_01
		      ,a.prfr_amt_02
		      ,a.prfr_amt_03
		      ,a.prfr_amt_04
		      ,a.prfr_amt_05
		      ,a.prfr_amt_06
		      ,a.prfr_amt_07
		      ,a.prfr_amt_08
		      ,a.prfr_amt_09
		      ,a.prfr_amt_10
		      ,a.prfr_amt_11
		      ,a.prfr_amt_12
		  from (select a.wkpl_id
				      ,fn_get_cd('ST00000002', a.wkpl_id, 'NM', #{SESS_LANG}) as wkpl_nm
				      ,c.wkpl_main_bsns_cd
				      ,fn_get_cd('ST00000015', c.wkpl_main_bsns_cd, 'NM', #{SESS_LANG}) as wkpl_main_bsns_nm
				      ,fn_get_cd('CO00000009', c.cmpy_cd, 'NM', #{SESS_LANG}) as cmpy_nm
				      ,c.cmpy_cd
				      ,a.invs_year
				      ,a.invs_cat_cd
				      ,a.invs_stpl_item_cd
				      ,fn_get_cd('ST00000014', a.invs_cat_cd, 'NM', #{SESS_LANG}) as invs_cat_nm
				      ,fn_get_cd('ST00000021', a.invs_stpl_item_cd, 'NM', #{SESS_LANG}) as invs_stpl_item_nm
				      ,case when b.invs_item_amt > 0 then b.invs_item_amt / 1000 else 0 end as invs_item_amt
				      ,case when a.prfr_amt_tot > 0 and b.invs_item_amt > 0 then a.prfr_amt_tot / (b.invs_item_amt / 1000) * 100 else 0 end as amt_per
				      ,a.prfr_amt_tot
				      ,a.prfr_amt_01
				      ,a.prfr_amt_02
				      ,a.prfr_amt_03
				      ,a.prfr_amt_04
				      ,a.prfr_amt_05
				      ,a.prfr_amt_06
				      ,a.prfr_amt_07
				      ,a.prfr_amt_08
				      ,a.prfr_amt_09
				      ,a.prfr_amt_10
				      ,a.prfr_amt_11
				      ,a.prfr_amt_12
				      ,'0' as ord
				  from (select a.wkpl_id
						      ,a.invs_year
						      ,a.invs_cat_cd
						      ,a.invs_stpl_item_cd
						      ,max(a.prfr_amt_tot) as prfr_amt_tot
						      ,sum(prfr_amt_01) as prfr_amt_01
						      ,sum(prfr_amt_02) as prfr_amt_02
						      ,sum(prfr_amt_03) as prfr_amt_03
						      ,sum(prfr_amt_04) as prfr_amt_04
						      ,sum(prfr_amt_05) as prfr_amt_05
						      ,sum(prfr_amt_06) as prfr_amt_06
						      ,sum(prfr_amt_07) as prfr_amt_07
						      ,sum(prfr_amt_08) as prfr_amt_08
						      ,sum(prfr_amt_09) as prfr_amt_09
						      ,sum(prfr_amt_10) as prfr_amt_10
						      ,sum(prfr_amt_11) as prfr_amt_11
						      ,sum(prfr_amt_12) as prfr_amt_12
						  from (select a.wkpl_id
								      ,a.invs_year
								      ,a.invs_cat_cd
								      ,a.invs_stpl_item_cd
								      ,max(b.prfr_amt_tot) as prfr_amt_tot
								      ,case when a.prfr_reg_mth = '01' then max(a.prfr_amt) else 0 end as prfr_amt_01
								      ,case when a.prfr_reg_mth = '02' then max(a.prfr_amt) else 0 end as prfr_amt_02
								      ,case when a.prfr_reg_mth = '03' then max(a.prfr_amt) else 0 end as prfr_amt_03
								      ,case when a.prfr_reg_mth = '04' then max(a.prfr_amt) else 0 end as prfr_amt_04
								      ,case when a.prfr_reg_mth = '05' then max(a.prfr_amt) else 0 end as prfr_amt_05
								      ,case when a.prfr_reg_mth = '06' then max(a.prfr_amt) else 0 end as prfr_amt_06
								      ,case when a.prfr_reg_mth = '07' then max(a.prfr_amt) else 0 end as prfr_amt_07
								      ,case when a.prfr_reg_mth = '08' then max(a.prfr_amt) else 0 end as prfr_amt_08
								      ,case when a.prfr_reg_mth = '09' then max(a.prfr_amt) else 0 end as prfr_amt_09
								      ,case when a.prfr_reg_mth = '10' then max(a.prfr_amt) else 0 end as prfr_amt_10
								      ,case when a.prfr_reg_mth = '11' then max(a.prfr_amt) else 0 end as prfr_amt_11
								      ,case when a.prfr_reg_mth = '12' then max(a.prfr_amt) else 0 end as prfr_amt_12
								  from (select a.wkpl_id
										      ,a.invs_year
										      ,a.invs_cat_cd
										      ,a.invs_stpl_item_cd
										      ,a.prfr_reg_mth
										      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt
										  from tb_sh_wkpl_mtly_prfr a
										 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd,a.prfr_reg_mth
									   ) a
									  ,(select a.wkpl_id
										      ,a.invs_year
										      ,a.invs_cat_cd
										      ,a.invs_stpl_item_cd
										      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt_tot
										  from tb_sh_wkpl_mtly_prfr a
										 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd
									   ) b
								 where a.wkpl_id = b.wkpl_id 
								   and a.invs_year = b.invs_year
								   and a.invs_cat_cd = b.invs_cat_cd
								   and a.invs_stpl_item_cd = b.invs_stpl_item_cd
								 group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd,a.prfr_reg_mth
							  ) a
						group by a.wkpl_id,a.invs_year,a.invs_cat_cd,a.invs_stpl_item_cd
					   ) a
					  ,(select b.wkpl_id
					          ,b.invs_year
					          ,b.invs_cat_cd
					          ,b.wkpl_invs_item
					          ,sum(b.invs_item_amt) as invs_item_amt
					      from tb_sh_wkpl_invs_item b
					     where 1=1
					     group by b.wkpl_id,b.invs_year,b.invs_cat_cd,b.wkpl_invs_item
					   ) b
					  ,tb_sh_wkpl c
					  ,tb_sh_wkpl_invs d
				 where a.wkpl_id = b.wkpl_id 
				   and a.invs_year = b.invs_year 
				   and a.invs_cat_cd = b.invs_cat_cd 
				   and a.invs_stpl_item_cd = b.wkpl_invs_item		   
				   and a.wkpl_id = d.wkpl_id 
				   and a.invs_year = d.invs_year
				   and d.wkpl_id = c.wkpl_id
				 <if test='wkpl_id != null and wkpl_id != ""'>
				   and a.wkpl_id = #{wkpl_id}
				 </if>
				 <if test='cmpy_cd != null and cmpy_cd != ""'>
				   and c.cmpy_cd = #{cmpy_cd}
				 </if>
				 <if test='invs_year != null and invs_year != ""'>
				   and a.invs_year = #{invs_year}
				 </if>
				 <if test='wkpl_main_bsns_cd != null and wkpl_main_bsns_cd != ""'>
				   and c.wkpl_main_bsns_cd = #{wkpl_main_bsns_cd}
				 </if>
				 <if test='invs_cat_cd != null and invs_cat_cd != ""'>
				   and a.invs_cat_cd = #{invs_cat_cd}
				 </if>
				 union all
				select a.wkpl_id
				      ,fn_get_cd('ST00000002', a.wkpl_id, 'NM', #{SESS_LANG}) as wkpl_nm
				      ,c.wkpl_main_bsns_cd
				      ,fn_get_cd('ST00000015', c.wkpl_main_bsns_cd, 'NM', #{SESS_LANG}) as wkpl_main_bsns_nm
				      ,fn_get_cd('CO00000009', c.cmpy_cd, 'NM', #{SESS_LANG}) as cmpy_nm
				      ,c.cmpy_cd
				      ,a.invs_year
				      ,'zzzzzz' as invs_cat_cd
				      ,'' as invs_stpl_item_cd
				      ,'' as invs_cat_nm
				      ,'소계' as invs_stpl_item_nm
				      ,case when b.invs_item_amt > 0 then b.invs_item_amt / 1000 else 0 end as invs_item_amt
				      ,case when a.prfr_amt_tot > 0 and b.invs_item_amt > 0 then a.prfr_amt_tot / (b.invs_item_amt / 1000) * 100 else 0 end as amt_per
				      ,a.prfr_amt_tot
				      ,a.prfr_amt_01
				      ,a.prfr_amt_02
				      ,a.prfr_amt_03
				      ,a.prfr_amt_04
				      ,a.prfr_amt_05
				      ,a.prfr_amt_06
				      ,a.prfr_amt_07
				      ,a.prfr_amt_08
				      ,a.prfr_amt_09
				      ,a.prfr_amt_10
				      ,a.prfr_amt_11
				      ,a.prfr_amt_12
				      ,'1' as ord
				  from (select a.wkpl_id
						      ,a.invs_year
						      ,max(a.prfr_amt_tot) as prfr_amt_tot
						      ,sum(prfr_amt_01) as prfr_amt_01
						      ,sum(prfr_amt_02) as prfr_amt_02
						      ,sum(prfr_amt_03) as prfr_amt_03
						      ,sum(prfr_amt_04) as prfr_amt_04
						      ,sum(prfr_amt_05) as prfr_amt_05
						      ,sum(prfr_amt_06) as prfr_amt_06
						      ,sum(prfr_amt_07) as prfr_amt_07
						      ,sum(prfr_amt_08) as prfr_amt_08
						      ,sum(prfr_amt_09) as prfr_amt_09
						      ,sum(prfr_amt_10) as prfr_amt_10
						      ,sum(prfr_amt_11) as prfr_amt_11
						      ,sum(prfr_amt_12) as prfr_amt_12
						  from (select a.wkpl_id
								      ,a.invs_year
								      ,max(b.prfr_amt_tot) as prfr_amt_tot
								      ,case when a.prfr_reg_mth = '01' then max(a.prfr_amt) else 0 end as prfr_amt_01
								      ,case when a.prfr_reg_mth = '02' then max(a.prfr_amt) else 0 end as prfr_amt_02
								      ,case when a.prfr_reg_mth = '03' then max(a.prfr_amt) else 0 end as prfr_amt_03
								      ,case when a.prfr_reg_mth = '04' then max(a.prfr_amt) else 0 end as prfr_amt_04
								      ,case when a.prfr_reg_mth = '05' then max(a.prfr_amt) else 0 end as prfr_amt_05
								      ,case when a.prfr_reg_mth = '06' then max(a.prfr_amt) else 0 end as prfr_amt_06
								      ,case when a.prfr_reg_mth = '07' then max(a.prfr_amt) else 0 end as prfr_amt_07
								      ,case when a.prfr_reg_mth = '08' then max(a.prfr_amt) else 0 end as prfr_amt_08
								      ,case when a.prfr_reg_mth = '09' then max(a.prfr_amt) else 0 end as prfr_amt_09
								      ,case when a.prfr_reg_mth = '10' then max(a.prfr_amt) else 0 end as prfr_amt_10
								      ,case when a.prfr_reg_mth = '11' then max(a.prfr_amt) else 0 end as prfr_amt_11
								      ,case when a.prfr_reg_mth = '12' then max(a.prfr_amt) else 0 end as prfr_amt_12
								  from (select a.wkpl_id
										      ,a.invs_year
										      ,a.prfr_reg_mth
										      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt
										  from tb_sh_wkpl_mtly_prfr a
										      ,tb_sh_wkpl_invs_item b
										 where a.wkpl_id = b.wkpl_id 
										   and a.invs_year = b.invs_year 
										   and a.invs_cat_cd = b.invs_cat_cd
										   and a.invs_stpl_item_cd = b.wkpl_invs_item
										 <if test='invs_cat_cd != null and invs_cat_cd != ""'>
										   and a.invs_cat_cd = #{invs_cat_cd}
										 </if>
										 group by a.wkpl_id,a.invs_year,a.prfr_reg_mth
									   ) a
									  ,(select a.wkpl_id
										      ,a.invs_year
										      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt_tot
										  from tb_sh_wkpl_mtly_prfr a
										      ,tb_sh_wkpl_invs_item b
										 where a.wkpl_id = b.wkpl_id 
										   and a.invs_year = b.invs_year 
										   and a.invs_cat_cd = b.invs_cat_cd
										   and a.invs_stpl_item_cd = b.wkpl_invs_item
										 <if test='invs_cat_cd != null and invs_cat_cd != ""'>
										   and a.invs_cat_cd = #{invs_cat_cd}
										 </if>
										 group by a.wkpl_id,a.invs_year
									   ) b
								 where a.wkpl_id = b.wkpl_id 
								   and a.invs_year = b.invs_year
								 group by a.wkpl_id,a.invs_year,a.prfr_reg_mth
							  ) a
						group by a.wkpl_id,a.invs_year
					   ) a
					  ,(select b.wkpl_id
					          ,b.invs_year
					          ,sum(invs_item_amt) as invs_item_amt
					      from tb_sh_wkpl_invs_item b
					     where 1=1
					     <if test='invs_cat_cd != null and invs_cat_cd != ""'>
						   and b.invs_cat_cd = #{invs_cat_cd}
						 </if>
					     group by b.wkpl_id, b.invs_year
					   ) b
					  ,tb_sh_wkpl c
					  ,tb_sh_wkpl_invs d
				 where a.wkpl_id = b.wkpl_id 
				   and a.invs_year = b.invs_year 		   
				   and a.wkpl_id = d.wkpl_id 
				   and a.invs_year = d.invs_year
				   and d.wkpl_id = c.wkpl_id 
				 <if test='wkpl_id != null and wkpl_id != ""'>
				   and a.wkpl_id = #{wkpl_id}
				 </if>
				 <if test='cmpy_cd != null and cmpy_cd != ""'>
				   and c.cmpy_cd = #{cmpy_cd}
				 </if>
				 <if test='invs_year != null and invs_year != ""'>
				   and a.invs_year = #{invs_year}
				 </if>
				 <if test='wkpl_main_bsns_cd != null and wkpl_main_bsns_cd != ""'>
				   and c.wkpl_main_bsns_cd = #{wkpl_main_bsns_cd}
				 </if>
				 union all 
				select a.wkpl_id
				      ,max(a.wkpl_nm) as wkpl_nm
				      ,max(a.wkpl_main_bsns_cd) as wkpl_main_bsns_cd
				      ,max(a.wkpl_main_bsns_nm) as wkpl_main_bsns_nm
				      ,max(a.cmpy_nm) as cmpy_nm
				      ,max(a.cmpy_cd) as cmpy_cd
				      ,max(a.invs_year) as invs_year
				      ,max(a.invs_cat_cd) as invs_cat_cd
				      ,max(a.invs_stpl_item_cd) as invs_stpl_item_cd
				      ,max(a.invs_cat_nm) as invs_cat_nm
				      ,max(a.invs_stpl_item_nm) as invs_stpl_item_nm
				      ,sum(a.invs_item_amt) as invs_item_amt
				      ,case when sum(a.prfr_amt_tot) > 0 and sum(a.invs_item_amt) > 0 then sum(a.prfr_amt_tot) / sum(a.invs_item_amt) * 100 else 0 end as amt_per
				      ,sum(a.prfr_amt_tot) as prfr_amt_tot
				      ,sum(a.prfr_amt_01) as prfr_amt_01
				      ,sum(a.prfr_amt_02) as prfr_amt_02
				      ,sum(a.prfr_amt_03) as prfr_amt_03
				      ,sum(a.prfr_amt_04) as prfr_amt_04
				      ,sum(a.prfr_amt_05) as prfr_amt_05
				      ,sum(a.prfr_amt_06) as prfr_amt_06
				      ,sum(a.prfr_amt_07) as prfr_amt_07
				      ,sum(a.prfr_amt_08) as prfr_amt_08
				      ,sum(a.prfr_amt_09) as prfr_amt_09
				      ,sum(a.prfr_amt_10) as prfr_amt_10
				      ,sum(a.prfr_amt_11) as prfr_amt_11
				      ,sum(a.prfr_amt_12) as prfr_amt_12
				      ,'3' as ord
				  from (select 'zzzzzz' as wkpl_id
						      ,'' as wkpl_nm
						      ,'' as wkpl_main_bsns_cd
						      ,'' as wkpl_main_bsns_nm
						      ,'' as cmpy_nm
						      ,'zzzzzz' as cmpy_cd
						      ,'' as invs_year
						      ,'zzzzzz' as invs_cat_cd
						      ,'zzzzzz' as invs_stpl_item_cd
						      ,'' as invs_cat_nm
						      ,'합계' as invs_stpl_item_nm
						      ,case when b.invs_item_amt > 0 then b.invs_item_amt / 1000 else 0 end as invs_item_amt
						      ,case when a.prfr_amt_tot > 0 and b.invs_item_amt > 0 then a.prfr_amt_tot / (b.invs_item_amt / 1000) * 100 else 0 end as amt_per
						      ,a.prfr_amt_tot
						      ,a.prfr_amt_01
						      ,a.prfr_amt_02
						      ,a.prfr_amt_03
						      ,a.prfr_amt_04
						      ,a.prfr_amt_05
						      ,a.prfr_amt_06
						      ,a.prfr_amt_07
						      ,a.prfr_amt_08
						      ,a.prfr_amt_09
						      ,a.prfr_amt_10
						      ,a.prfr_amt_11
						      ,a.prfr_amt_12
						      ,'2' as ord
						  from (select a.wkpl_id
								      ,a.invs_year
								      ,max(a.prfr_amt_tot) as prfr_amt_tot
								      ,sum(prfr_amt_01) as prfr_amt_01
								      ,sum(prfr_amt_02) as prfr_amt_02
								      ,sum(prfr_amt_03) as prfr_amt_03
								      ,sum(prfr_amt_04) as prfr_amt_04
								      ,sum(prfr_amt_05) as prfr_amt_05
								      ,sum(prfr_amt_06) as prfr_amt_06
								      ,sum(prfr_amt_07) as prfr_amt_07
								      ,sum(prfr_amt_08) as prfr_amt_08
								      ,sum(prfr_amt_09) as prfr_amt_09
								      ,sum(prfr_amt_10) as prfr_amt_10
								      ,sum(prfr_amt_11) as prfr_amt_11
								      ,sum(prfr_amt_12) as prfr_amt_12
								  from (select a.wkpl_id
										      ,a.invs_year
										      ,max(b.prfr_amt_tot) as prfr_amt_tot
										      ,case when a.prfr_reg_mth = '01' then max(a.prfr_amt) else 0 end as prfr_amt_01
										      ,case when a.prfr_reg_mth = '02' then max(a.prfr_amt) else 0 end as prfr_amt_02
										      ,case when a.prfr_reg_mth = '03' then max(a.prfr_amt) else 0 end as prfr_amt_03
										      ,case when a.prfr_reg_mth = '04' then max(a.prfr_amt) else 0 end as prfr_amt_04
										      ,case when a.prfr_reg_mth = '05' then max(a.prfr_amt) else 0 end as prfr_amt_05
										      ,case when a.prfr_reg_mth = '06' then max(a.prfr_amt) else 0 end as prfr_amt_06
										      ,case when a.prfr_reg_mth = '07' then max(a.prfr_amt) else 0 end as prfr_amt_07
										      ,case when a.prfr_reg_mth = '08' then max(a.prfr_amt) else 0 end as prfr_amt_08
										      ,case when a.prfr_reg_mth = '09' then max(a.prfr_amt) else 0 end as prfr_amt_09
										      ,case when a.prfr_reg_mth = '10' then max(a.prfr_amt) else 0 end as prfr_amt_10
										      ,case when a.prfr_reg_mth = '11' then max(a.prfr_amt) else 0 end as prfr_amt_11
										      ,case when a.prfr_reg_mth = '12' then max(a.prfr_amt) else 0 end as prfr_amt_12
										  from (select a.wkpl_id
												      ,a.invs_year
												      ,a.prfr_reg_mth
												      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt
												  from tb_sh_wkpl_mtly_prfr a
												      ,tb_sh_wkpl_invs_item b
												 where a.wkpl_id = b.wkpl_id 
												   and a.invs_year = b.invs_year 
												   and a.invs_cat_cd = b.invs_cat_cd
												   and a.invs_stpl_item_cd = b.wkpl_invs_item
												 <if test='invs_cat_cd != null and invs_cat_cd != ""'>
												   and a.invs_cat_cd = #{invs_cat_cd}
												 </if>
												 group by a.wkpl_id,a.invs_year,a.prfr_reg_mth
											   ) a
											  ,(select a.wkpl_id
												      ,a.invs_year
												      ,case when sum(a.prfr_amt) > 0 then sum(a.prfr_amt) / 1000 else 0 end as prfr_amt_tot
												  from tb_sh_wkpl_mtly_prfr a
												      ,tb_sh_wkpl_invs_item b
												 where a.wkpl_id = b.wkpl_id 
												   and a.invs_year = b.invs_year 
												   and a.invs_cat_cd = b.invs_cat_cd
												   and a.invs_stpl_item_cd = b.wkpl_invs_item
												 <if test='invs_cat_cd != null and invs_cat_cd != ""'>
												   and a.invs_cat_cd = #{invs_cat_cd}
												 </if>
												 group by a.wkpl_id,a.invs_year
											   ) b
										 where a.wkpl_id = b.wkpl_id 
										   and a.invs_year = b.invs_year
										 group by a.wkpl_id,a.invs_year,a.prfr_reg_mth
									  ) a
								group by a.wkpl_id,a.invs_year
							   ) a
							  ,(select b.wkpl_id
							          ,b.invs_year
							          ,sum(invs_item_amt) as invs_item_amt
							      from tb_sh_wkpl_invs_item b
							     where 1=1
							     <if test='invs_cat_cd != null and invs_cat_cd != ""'>
								   and b.invs_cat_cd = #{invs_cat_cd}
								 </if>
							     group by b.wkpl_id, b.invs_year
							   ) b
							  ,tb_sh_wkpl c
							  ,tb_sh_wkpl_invs d
						 where a.wkpl_id = b.wkpl_id 
						   and a.invs_year = b.invs_year 		   
						   and a.wkpl_id = d.wkpl_id 
						   and a.invs_year = d.invs_year
						   and d.wkpl_id = c.wkpl_id 
						 <if test='wkpl_id != null and wkpl_id != ""'>
						   and a.wkpl_id = #{wkpl_id}
						 </if>
						 <if test='cmpy_cd != null and cmpy_cd != ""'>
						   and c.cmpy_cd = #{cmpy_cd}
						 </if>
						 <if test='invs_year != null and invs_year != ""'>
						   and a.invs_year = #{invs_year}
						 </if>
						 <if test='wkpl_main_bsns_cd != null and wkpl_main_bsns_cd != ""'>
						   and c.wkpl_main_bsns_cd = #{wkpl_main_bsns_cd}
						 </if>
						) a
			     group by a.wkpl_id
				) a
		 order by a.cmpy_cd, a.wkpl_id, a.invs_cat_cd, a.invs_stpl_item_cd, a.ord
	</select>
	
	<!-- 사업장별 투자 결재상신 -->
    <update id="updateInvsMgntAppr" parameterType="sqlMap">
        /* updateInvsMgntAppr */
        update tb_sh_wkpl_invs
		   set invs_aprv_no 		= #{invs_aprv_no}
		      ,upt_usr_id 					= #{username}
		      ,upt_dt 				= current_timestamp
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
    </update>
    
    <!-- 사업장별 투자 관리 조회 -->
	<select id="selectInvsMgntAprvDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntAprvDtl  */
		select a.wkpl_id
		      ,a.invs_year
		      ,a.invs_aprv_no
		  from tb_sh_wkpl_invs a
		 where a.invs_aprv_no = #{invs_aprv_no}
	</select>
	
	<!-- 사업장별 투자 결재상신 후처리 -->
    <update id="updateInvsMgntApprAf" parameterType="sqlMap">
        /* updateInvsMgntApprAf */
        update tb_sh_wkpl_invs
		   set invs_prst_cd = #{invs_prst_cd}
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
    </update>
    
    <!-- 사업장별 투자 연간 투자금액 저장 -->
    <update id="updateInvsMgntInvsAmt" parameterType="sqlMap">
        /* updateInvsMgntInvsAmt */
        update tb_sh_wkpl_invs
		   set yrly_invs_amt = (select sum(b.invs_item_amt) as invs_item_amt
		   						  from tb_sh_wkpl_invs_item b
		   						 where b.wkpl_id = #{wkpl_id}
		   						   and b.invs_year = #{invs_year}
		   					   )
		 where wkpl_id = #{wkpl_id}
		   and invs_year = #{invs_year}
    </update>
    
    <!-- 사업장별 투자 관리 엑셀업로드 양식 조회 -->
	<select id="selectInvsMgntExcelTemp" parameterType="sqlMap" resultType="sqlMap">
		/* selectInvsMgntExcelTemp  */
		select a.cd_nm as invs_cat_nm
		      ,b.cd_nm as tb_sh_wkpl_invs_item_nm
		  from (select tcc.cd
				      ,tcm.mlang_cntn as cd_nm
				      ,'1' as gb
				  from tb_co_cd tcc
				  join tb_co_cd_grp tccg on tccg.cd_grp_no = tcc.cd_grp_no 
				  join tb_co_mlang tcm on tcc.cd_grp_no = tcm.cd_grp_no and tcc.cd = tcm.cd
				 where tcc.cd_grp_no = 'ST00000014'
				   and tcm.lang_cd = #{SESS_LANG}
				   and tcc.del_yn = 'N'
				   and tcc.usg_yn = 'Y'
				   and tccg.usg_yn = 'Y'
				   and tccg.del_yn = 'N'
				   and tcm.usg_yn = 'Y'
				   and tcm.del_yn = 'N'
			   ) a
			  ,(select tcc.cd
				      ,tcm.mlang_cntn as cd_nm
				      ,'1' as gb
				  from tb_co_cd tcc
				  join tb_co_cd_grp tccg on tccg.cd_grp_no = tcc.cd_grp_no 
				  join tb_co_mlang tcm on tcc.cd_grp_no = tcm.cd_grp_no and tcc.cd = tcm.cd
				 where tcc.cd_grp_no = 'ST00000021'
				   and tcm.lang_cd = #{SESS_LANG}
				   and tcc.del_yn = 'N'
				   and tcc.usg_yn = 'Y'
				   and tccg.usg_yn = 'Y'
				   and tccg.del_yn = 'N'
				   and tcm.usg_yn = 'Y'
				   and tcm.del_yn = 'N'
			   ) b
		 order by a.cd_nm, b.cd_nm
	</select>
    
</mapper>