<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.hmex.mapper.HmexRsltMapper">

	<!-- 건강검진 결과 관리 조회  -->
	<select id="selectRsltList" parameterType="sqlMap" resultType="sqlMap">
		/* selectRsltList - 건강검진 결과 관리 조회 */
		select t1.hmex_year
			  ,t1.hmex_tgt_usr_id
			  ,t1.hmex_sn
			  ,t1.wkpl_id
			  ,fn_get_cmpy(t1.wkpl_id, 'NM', #{SESS_LANG}) as cmpy_nm
			  ,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', 'KO') as wkpl_nm
			  ,t1.hmex_cl_cd
			  ,fn_get_cd('SH00000037', t1.hmex_cl_cd, 'nm', 'KO') as hmex_cl_nm
			  ,t1.deal_mtra_cd
			  ,fn_get_cd('SH00000035', t1.deal_mtra_cd, 'nm', 'KO') as deal_mtra_nm
			  ,t1.org_nm
			  ,t1.hmex_trgp_nm as full_hmex_trgp_nm
              ,substring(t1.hmex_trgp_nm, 1, 1) || '*' || substring(t1.hmex_trgp_nm, 3) as hmex_trgp_nm
			  ,substring(t2.jncm_dt, 0, 5) || '-' || substring(t2.jncm_dt, 5, 2) || '-' || substring(t2.jncm_dt, 7, 2) as jncm_dt
			  ,substring(t2.rsgn_dt, 0, 5) || '-' || substring(t2.rsgn_dt, 5, 2) || '-' || substring(t2.rsgn_dt, 7, 2) as rsgn_dt
			  ,t1.hmex_insp_yn
			  ,substring(t1.hmex_insp_dt, 0, 5) || '-' || substring(t1.hmex_insp_dt, 5, 2) || '-' || substring(t1.hmex_insp_dt, 7, 2) as hmex_insp_dt
			  ,t1.hmex_insp_orga_nm
			  ,t1.abfd_xtra_cnsl_yn
			  ,t1.ovr_opin_yn
			  ,t1.hmex_ovr_opin_jgmt_cd1
			  ,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd1, 'nm', 'KO') as hmex_ovr_opin_jgmt_cd_nm1
			  ,t1.hmex_ovr_opin_nm1
			  ,t1.hmex_ovr_opin_jgmt_cd2
			  ,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd2, 'nm', 'KO') as hmex_ovr_opin_jgmt_cd_nm2
			  ,t1.hmex_ovr_opin_nm2
			  ,t1.hmex_ovr_opin_jgmt_cd3
			  ,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd3, 'nm', 'KO') as hmex_ovr_opin_jgmt_cd_nm3
			  ,t1.hmex_ovr_opin_nm3
			  ,t1.hmex_ovr_opin_jgmt_cd4
			  ,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd4, 'nm', 'KO') as hmex_ovr_opin_jgmt_cd_nm4
			  ,t1.hmex_ovr_opin_nm4
			  ,t1.hmex_ovr_opin_jgmt_cd5
			  ,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd5, 'nm', 'KO') as hmex_ovr_opin_jgmt_cd_nm5
			  ,t1.hmex_ovr_opin_nm5
		  from tb_sh_hmex_rslt t1
		  left outer join tb_sh_hmex_trgp t2
		    on t1.hmex_year = t2.hmex_year
		   and t1.hmex_tgt_usr_id = t2.hmex_tgt_usr_id 
		   and t2.hmex_sn = (
		   					 select min(hmex_sn)
		   					   from tb_sh_hmex_trgp
		   					  where hmex_year = t1.hmex_year
		   					    and hmex_tgt_usr_id = t1.hmex_tgt_usr_id
		   					)
		 where 1 = 1
		<if test='hmex_year != null and hmex_year != ""'>
		   and t1.hmex_year = #{hmex_year}
		</if>
		<if test='wkpl_id != null and wkpl_id != ""'>
		   and t1.wkpl_id = #{wkpl_id}
		</if>
		<if test='hmex_cl_cd != null and hmex_cl_cd != ""'>
		   and t1.hmex_cl_cd = #{hmex_cl_cd}
		</if>
		<if test='hmex_insp_yn == "Y"'>
		   and t1.hmex_insp_yn = 'Y'
		</if>
		<if test='hmex_insp_yn == "N"'>
		   and (t1.hmex_insp_yn = 'N' or t1.hmex_insp_yn is null)
		</if>
		<if test='org_nm != null and org_nm != ""'>
		   and t1.org_nm like '%' || #{org_nm} || '%'
		</if>
		<if test='hmex_trgp_nm != null and hmex_trgp_nm != ""'>
		   and t1.hmex_trgp_nm like concat('%', #{hmex_trgp_nm}, '%')
		</if>
		<if test='hmex_tgt_usr_id != null and hmex_tgt_usr_id != ""'>
		   and t1.hmex_tgt_usr_id like concat('%', #{hmex_tgt_usr_id}, '%')
		</if>
		<if test='cmpy_cd != null and cmpy_cd != ""'>
		   and exists (select 1
		      			 from tb_sh_wkpl w
		      			where w.wkpl_id = t1.wkpl_id 
		      			  and w.cmpy_cd = #{cmpy_cd}
		   			  )
		 </if>
		 order by t1.hmex_year desc
		 		 ,t1.hmex_tgt_usr_id
		 		 ,t1.hmex_sn
	</select>
	
	<select id="selectUser" parameterType="sqlMap" resultType="sqlMap">
		/* selectUser */
		select 
			t1.hmex_year
			,t1.hmex_tgt_usr_id
			,t1.wkpl_id
			,fn_get_cd('ST00000002', t1.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
			,t1.org_nm
			,t1.hmex_trgp_nm
			,substring(t1.jncm_dt, 0, 5) || '-' || substring(t1.jncm_dt, 5, 2) || '-' || substring(t1.jncm_dt, 7, 2) as jncm_dt
			,substring(t1.rsgn_dt, 0, 5) || '-' || substring(t1.rsgn_dt, 5, 2) || '-' || substring(t1.rsgn_dt, 7, 2) as rsgn_dt
			,t1.cwkr_yn 
		from tb_sh_hmex_trgp t1
		where t1.hmex_tgt_usr_id = #{hmex_tgt_usr_id}
		<if test='hmex_year != null and hmex_year != ""'>
			and t1.hmex_year = #{hmex_year}
		</if>
		order by t1.hmex_year desc 
		limit 1
	</select>
	
	<select id="selectHmexRslt" parameterType="sqlMap" resultType="sqlMap">
		/* selectHmexRslt */
		select 
			fn_get_cd('SH00000037', t1.hmex_cl_cd, 'nm', #{SESS_LANG}) as hmex_cl_nm
			,fn_get_cd('SH00000035', t1.deal_mtra_cd, 'nm', #{SESS_LANG}) as deal_mtra_nm
			,substring(t1.hmex_insp_dt, 0, 5) || '-' || substring(t1.hmex_insp_dt, 5, 2) || '-' || substring(t1.hmex_insp_dt, 7, 2) as hmex_insp_dt
			,t1.hmex_insp_orga_nm
			,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd1, 'nm', #{SESS_LANG}) as hmex_ovr_opin_jgmt_cd1
			,t1.hmex_ovr_opin_nm1
			,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd2, 'nm', #{SESS_LANG}) as hmex_ovr_opin_jgmt_cd2
			,t1.hmex_ovr_opin_nm2
			,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd3, 'nm', #{SESS_LANG}) as hmex_ovr_opin_jgmt_cd3
			,t1.hmex_ovr_opin_nm3
			,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd4, 'nm', #{SESS_LANG}) as hmex_ovr_opin_jgmt_cd4
			,t1.hmex_ovr_opin_nm4
			,fn_get_cd('SH00000038', t1.hmex_ovr_opin_jgmt_cd5, 'nm', #{SESS_LANG}) as hmex_ovr_opin_jgmt_cd5
			,t1.hmex_ovr_opin_nm5
		from tb_sh_hmex_rslt t1
		where hmex_tgt_usr_id = #{hmex_tgt_usr_id}
		<if test='hmex_year != null and hmex_year != ""'>
			and t1.hmex_year = #{hmex_year}
		</if>
			and t1.hmex_ovr_opin_jgmt_cd1 is not null
		union all
		select 
			a.hmex_cl_nm
			,array_to_string(array_agg(a.deal_mtra_nm), ', ') as deal_mtra_nm
			,substring(a.hmex_insp_dt, 0, 5) || '-' || substring(a.hmex_insp_dt, 5, 2) || '-' || substring(a.hmex_insp_dt, 7, 2) as hmex_insp_dt
			,a.hmex_insp_orga_nm
			,'' as hmex_ovr_opin_jgmt_cd1
			,'' as hmex_ovr_opin_nm1
			,'' as hmex_ovr_opin_jgmt_cd2
			,'' as hmex_ovr_opin_nm2
			,'' as hmex_ovr_opin_jgmt_cd3
			,'' as hmex_ovr_opin_nm3
			,'' as hmex_ovr_opin_jgmt_cd4
			,'' as hmex_ovr_opin_nm4
			,'' as hmex_ovr_opin_jgmt_cd5
			,'' as hmex_ovr_opin_nm5
		from (
			select 
				fn_get_cd('SH00000037', t1.hmex_cl_cd, 'nm', #{SESS_LANG}) as hmex_cl_nm
				,fn_get_cd('SH00000035', t1.deal_mtra_cd, 'nm', #{SESS_LANG}) as deal_mtra_nm
				,t1.hmex_insp_dt
				,t1.hmex_insp_orga_nm
			from tb_sh_hmex_rslt t1
			where hmex_tgt_usr_id = #{hmex_tgt_usr_id}
			<if test='hmex_year != null and hmex_year != ""'>
				and t1.hmex_year = #{hmex_year}
			</if>
				and t1.hmex_ovr_opin_jgmt_cd1 is null
		) a
		group by hmex_cl_nm, hmex_insp_dt, hmex_insp_orga_nm
		order by hmex_insp_dt
	</select>
	
	<select id="selectHmexSn" parameterType="sqlMap" resultType="string">
		/* selectHmexSn */
		select coalesce(max(hmex_sn), 0) + 1 as hmex_sn from tb_sh_hmex_rslt t1
		where hmex_tgt_usr_id = #{hmex_tgt_usr_id} and hmex_year = #{hmex_year}
	</select>
	
	<!-- 건강검진 결과 등록/수정  -->
	<insert id="insertHmexRslt" parameterType="sqlMap">
      	/* insertHmexRslt - 건강검진 결과 등록/수정 */
		insert into tb_sh_hmex_rslt (
			hmex_year
			,hmex_tgt_usr_id
			,hmex_sn
			,wkpl_id
			,org_nm
			,hmex_trgp_nm
			,hmex_cl_cd
			,deal_mtra_cd
			,hmex_insp_yn
			,hmex_insp_dt
			,hmex_insp_orga_nm
			,abfd_xtra_cnsl_yn
			,ovr_opin_yn
			,hmex_ovr_opin_jgmt_cd1
			,hmex_ovr_opin_nm1
			,hmex_ovr_opin_jgmt_cd2
			,hmex_ovr_opin_nm2
			,hmex_ovr_opin_jgmt_cd3
			,hmex_ovr_opin_nm3
			,hmex_ovr_opin_jgmt_cd4
			,hmex_ovr_opin_nm4
			,hmex_ovr_opin_jgmt_cd5
			,hmex_ovr_opin_nm5
			,crt_usr_id
			,upt_usr_id
		) values (
			#{hmex_year}
		    ,#{hmex_tgt_usr_id}
		    ,#{hmex_sn}::INTEGER
			,#{wkpl_id}
			,#{org_nm}
			,#{hmex_trgp_nm}
		    ,#{hmex_cl_cd}
		    ,#{deal_mtra_cd}
		    ,#{hmex_insp_yn}
			,replace(#{hmex_insp_dt}, '-', '')
			,#{hmex_insp_orga_nm}
			,coalesce(#{abfd_xtra_cnsl_yn}, 'N')
			,#{ovr_opin_yn}
			,#{hmex_ovr_opin_jgmt_cd1}
			,#{hmex_ovr_opin_nm1}
			,#{hmex_ovr_opin_jgmt_cd2}
			,#{hmex_ovr_opin_nm2}
			,#{hmex_ovr_opin_jgmt_cd3}
			,#{hmex_ovr_opin_nm3}
			,#{hmex_ovr_opin_jgmt_cd4}
			,#{hmex_ovr_opin_nm4}
			,#{hmex_ovr_opin_jgmt_cd5}
			,#{hmex_ovr_opin_nm5}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		) on conflict on constraint tb_sh_hmex_rslt_pk
		do update set
			hmex_insp_yn                = #{hmex_insp_yn}               
			,hmex_insp_dt               = replace(#{hmex_insp_dt}, '-', '')              
			,hmex_insp_orga_nm          = #{hmex_insp_orga_nm}
			,abfd_xtra_cnsl_yn			= coalesce(#{abfd_xtra_cnsl_yn}, 'N')      
			,ovr_opin_yn                = #{ovr_opin_yn}                
			,hmex_ovr_opin_jgmt_cd1 = #{hmex_ovr_opin_jgmt_cd1} 
			,hmex_ovr_opin_nm1          = #{hmex_ovr_opin_nm1}          
			,hmex_ovr_opin_jgmt_cd2 = #{hmex_ovr_opin_jgmt_cd2} 
			,hmex_ovr_opin_nm2          = #{hmex_ovr_opin_nm2}          
			,hmex_ovr_opin_jgmt_cd3 = #{hmex_ovr_opin_jgmt_cd3} 
			,hmex_ovr_opin_nm3          = #{hmex_ovr_opin_nm3}          
			,hmex_ovr_opin_jgmt_cd4 = #{hmex_ovr_opin_jgmt_cd4} 
			,hmex_ovr_opin_nm4          = #{hmex_ovr_opin_nm4}          
			,hmex_ovr_opin_jgmt_cd5 = #{hmex_ovr_opin_jgmt_cd5} 
			,hmex_ovr_opin_nm5          = #{hmex_ovr_opin_nm5}          
			,upt_usr_id                    = #{SESS_USR_ID}   
    </insert>
    
    <!-- 건강검진 결과 - 신규 일반검진 대상자 등록  -->
    <insert id="insertNewHmexMgnt" parameterType="sqlMap">
      	<selectKey keyProperty="hmex_sn" resultType="int" order="BEFORE">
			select coalesce(max(hmex_sn), 0) + 1 as hmex_sn from tb_sh_hmex_trgp t1
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
    	</selectKey>
      	/* insertNewHmexMgnt - 건강검진 결과 - 신규 일반검진 대상자 등록 */
		insert into tb_sh_hmex_trgp (
		    hmex_year
		    ,hmex_tgt_usr_id
			,hmex_sn
		    ,wkpl_id
		    ,hmex_cl_cd
		    ,deal_mtra_cd
		    ,hmex_trgp_org_cd
		    ,org_nm
		    ,hmex_trgp_nm
		    ,jncm_dt
		    ,rsgn_dt
		    ,cwkr_yn
			,crt_usr_id
			,upt_usr_id
		) select
			#{hmex_year}
		    ,#{hmex_tgt_usr_id}
		    ,#{hmex_sn}::INTEGER
			,#{wkpl_id}
		    ,#{hmex_cl_cd}
		    ,#{deal_mtra_cd}
		    ,#{hmex_trgp_org_cd}
		    ,#{org_nm}
		    ,#{hmex_trgp_nm}
			,replace(#{jncm_dt}, '-', '')
			,replace(#{rsgn_dt}, '-', '')
		    ,#{cwkr_yn}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		where not exists (
			select 1 from tb_sh_hmex_trgp
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
		)
    </insert>
    
    <!-- 건강검진 결과 - 신규 특수검진 대상자 등록  -->
	<insert id="insertNewHmexMgnt2" parameterType="sqlMap">
		<selectKey keyProperty="hmex_sn" resultType="int" order="BEFORE">
			select coalesce(max(hmex_sn), 0) + 1 as hmex_sn from tb_sh_hmex_trgp t1
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
    	</selectKey>
      	/* insertNewHmexMgnt2 - 건강검진 결과 - 신규 특수검진 대상자 등록 */
		insert into tb_sh_hmex_trgp (
		    hmex_year
		    ,hmex_tgt_usr_id
			,hmex_sn
		    ,wkpl_id
		    ,hmex_cl_cd
		    ,deal_mtra_cd
		    ,hmex_trgp_org_cd
		    ,org_nm
		    ,hmex_trgp_nm
		    ,jncm_dt
		    ,rsgn_dt
		    ,cwkr_yn
			,crt_usr_id
			,upt_usr_id
		) select
			#{hmex_year}
		    ,#{hmex_tgt_usr_id}
		    ,#{hmex_sn}::INTEGER
			,#{wkpl_id}
		    ,#{hmex_cl_cd}
		    ,#{deal_mtra_cd}
		    ,#{hmex_trgp_org_cd}
		    ,#{org_nm}
		    ,#{hmex_trgp_nm}
			,replace(#{jncm_dt}, '-', '')
			,replace(#{rsgn_dt}, '-', '')
		    ,#{cwkr_yn}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		where not exists (
			select 1 from tb_sh_hmex_trgp
			where hmex_year = #{hmex_year} and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
			and deal_mtra_cd = #{deal_mtra_cd} and hmex_cl_cd = #{hmex_cl_cd}
		) 
    </insert>
    
    <!-- 특수/일반 검진 대상자 관리에서 확정 -->
    <insert id="insertHmexRslt2" parameterType="sqlMap">
      	/* insertHmexRslt2 - 특수/일반 검진 대상자 관리에서 확정 */
		insert into tb_sh_hmex_rslt (
			hmex_year
			,hmex_tgt_usr_id
			,org_nm
			,hmex_trgp_nm
			,hmex_sn
			,wkpl_id
			,hmex_cl_cd
			,deal_mtra_cd
			,crt_usr_id
			,upt_usr_id
		) values (
			#{hmex_year}
		    ,#{hmex_tgt_usr_id}
		    ,#{org_nm}
			,#{hmex_trgp_nm}
		    ,#{hmex_sn}::INTEGER
			,#{wkpl_id}
		    ,#{hmex_cl_cd}
		    ,#{deal_mtra_cd}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		)
    </insert>
    
    <delete id="deleteHmexRslt" parameterType="sqlMap">
        /* deleteHmexRslt */
        delete from tb_sh_hmex_rslt
        where hmex_year = #{hmex_year}
          and hmex_tgt_usr_id = #{hmex_tgt_usr_id}
          and hmex_sn = #{hmex_sn}::integer
    </delete>
</mapper>