<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.st.stndinfr.mapper.OprnBfChkListMgntMapper">

	<!-- 작업전 체크리스트 목록 조회 -->
	<select id="selectOprnBfChkList" parameterType="sqlMap" resultType="sqlMap">
		/* selectOprnBfChkList  */
		select distinct
		     chec_chk_cl_cd
		    ,chec_cl_cd
			,chec_dtl_cl_cd
			,chec_in_cl_cd
			,chec_sn
			,chec_txt
			,usg_yn 
			,false as chk_yn
		  from tb_sh_chk_chec scc
		 where 1=1
		   and chec_lang_cd = 'KO'
		   and chec_chk_cl_cd = #{chec_gb} -- 체크리스트 점검 구분 코드
		 <if test='chec_cl_cd != null and chec_cl_cd != ""'>
		   and scc.chec_cl_cd = #{chec_cl_cd}
		 </if>
		 <if test='chec_dtl_cl_cd != null and chec_dtl_cl_cd != ""'>
		   and scc.chec_dtl_cl_cd = #{chec_dtl_cl_cd}
		 </if>
		 <if test='usg_yn != null and usg_yn != ""'>
		   and scc.usg_yn = #{usg_yn}
		 </if>
		 order by chec_cl_cd asc, chec_dtl_cl_cd asc, chec_sn asc
	</select>
	
	<!-- 작업전 체크리스트 저장 -->
    <insert id="insertOprnBfChkList" parameterType="sqlMap">
        /* insertOprnBfChkList */
        insert into tb_sh_chk_chec (
                chec_chk_cl_cd
			   ,chec_cl_cd 
			   ,chec_dtl_cl_cd 
			   ,chec_sn 
			   ,chec_in_cl_cd 
			   ,chec_lang_cd
			   ,chec_txt 
			   ,usg_yn 
			   ,crt_usr_id 
			   ,crt_dt 
			   ,upt_usr_id
			   ,upt_dt 
			) values (
			    #{chec_gb}
			   ,#{chec_cl_cd}
			   ,#{chec_dtl_cl_cd}
			   ,(select coalesce(max(chec_sn::integer),0) + 1 as key
				   from tb_sh_chk_chec
				  where chec_cl_cd = #{chec_cl_cd}
				    and chec_dtl_cl_cd = #{chec_dtl_cl_cd}
				    and chec_lang_cd = #{lang_cd}
						 )
			   ,#{chec_in_cl_cd}
			   ,#{lang_cd}
			   ,#{chec_txt}
			   ,#{usg_yn}
			   ,#{crt_usr_id}
			   ,now()
			   ,#{upt_usr_id}
			   ,now()
			)
    </insert>
    
    <!-- 작업전 체크리스트 업데이트 -->
    <update id="updateOprnBfChkList" parameterType="sqlMap">
        /* updateOprnBfChkList */
        update tb_sh_chk_chec
		   set chec_cl_cd = #{chec_cl_cd}
			  ,chec_dtl_cl_cd = #{chec_dtl_cl_cd}
			  ,chec_in_cl_cd = #{chec_in_cl_cd}
			  ,chec_lang_cd = #{lang_cd}
			  ,chec_txt = #{chec_txt}
			  ,usg_yn = #{usg_yn}
			  ,upt_usr_id = #{upt_usr_id}
			  ,upt_dt = now()
		 where chec_chk_cl_cd = #{chec_gb}
		   and chec_cl_cd = #{chec_cl_cd}
		   and chec_dtl_cl_cd = #{chec_dtl_cl_cd}
		   and chec_lang_cd = #{lang_cd}
		   and chec_sn = #{chec_sn}::numeric
    </update>
    
    <!-- 작업전 체크리스트 삭제 -->
    <delete id="deleteOprnBfChkList" parameterType="sqlMap">
        /* deleteOprnBfChkList */
        delete from tb_sh_chk_chec
		 where chec_chk_cl_cd = #{chec_gb}
		   and chec_cl_cd = #{chec_cl_cd}
		   and chec_dtl_cl_cd = #{chec_dtl_cl_cd}
		   and chec_lang_cd = #{lang_cd}
		   and chec_sn = #{chec_sn}::numeric
    </delete>
	
</mapper>