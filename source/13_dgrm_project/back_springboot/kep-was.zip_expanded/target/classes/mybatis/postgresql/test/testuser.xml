<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.test.user.mapper.TestUserMapper">

	<resultMap id="TestUserMap" type="com.kist.portal.test.user.dto.TestUserDto">

		<result property="userKey" column="usr_key" />								<!-- 사원키 -->
		<result property="userId" column="usr_id" />								<!-- 사원번호 -->
		<result property="userName" column="usr_nm" />								<!-- 사원명 -->
		<result property="userEnglishName" column="usr_eng_nm" />					<!-- 사원명 영어 -->
		<result property="userRegistDate" column="usr_rgst_dt" />					<!-- 사원 등록일 -->
		<result property="useYn" column="usg_yn" />									<!-- 사용여부 -->
		<result property="createDateTime" column="crt_dtm" />						<!-- 최초생성일시 -->
		<result property="updateDateTime" column="upt_dtm" />						<!-- 최종수정일시 -->

	</resultMap>

	<!-- 사용자 검색, 조회 -->
	<select id="selectTestUserList" parameterType="com.kist.portal.test.user.dto.TestUserDto" resultMap="TestUserMap">
		select um.usr_key, 
			um.usr_id, 
			ul.usr_nm, 
			ul.usr_eng_nm, 
			to_char(to_date(um.usr_rgst_dt,'YYYYMMDD'),'YYYY-MM-DD') as usr_rgst_dt,
			um.usg_yn,
			to_char(to_timestamp(um.crt_dtm,'YYYYMMDDHH24MISS'),'YYYY-MM-DD HH24:MI:SS') as crt_dtm,
			to_char(to_timestamp(um.upt_dtm,'YYYYMMDDHH24MISS'),'YYYY-MM-DD HH24:MI:SS') as upt_dtm
		from tb_co_test_user_m um
		join (
			select tctudl.usr_key, tctudl.his_seq, tctudl.usr_nm, tctudl.usr_eng_nm
			from tb_co_test_user_dtl_l tctudl
			inner join (SELECT usr_key, MAX(his_seq) AS max_his_seq FROM tb_co_test_user_dtl_l GROUP BY usr_key) sub
			on tctudl.usr_key = sub.usr_key
			and tctudl.his_seq = sub.max_his_seq
		) ul
		on um.usr_key = ul.usr_key
		where um.del_yn = 'N'
		<if test='userKey != null and userKey != ""'>
		and um.usr_key ilike #{userKey}
		</if>
		<if test='userId != null and userId != ""'>
		and um.usr_id ilike #{userId}
		</if>
		<if test='userName != null and userName != ""'>
		and (ul.usr_nm ILIKE '%' || #{userName} || '%' or ul.usr_eng_nm ilike '%' || #{userName} || '%')
		</if>
		<if test='sDate != null and sDate != "" and eDate != null and eDate != ""'>
		<![CDATA[
		and to_timestamp(um.usr_rgst_dt,  'YYYYMMDDHH24MIss') >= #{sDate}::timestamp 
		and to_timestamp(um.usr_rgst_dt,  'YYYYMMDDHH24MIss') <= concat(#{eDate}, ' 23:59:59')::timestamp
		]]>
		</if>
		<if test='useYn != null and useYn != ""'>
		and um.usg_yn = #{useYn}
		</if>
		order by um.upt_dtm desc
	</select>
	
	<select id="selectTestUserkey" resultType="string">
		select 'USR' || to_char(current_date, 'YYYYMMDD') || '_' || LPAD(nextval('tctudl_usr_key_seq')::text,8,'0') as key
	</select>
	
	<insert id="insertTestUserM" parameterType="sqlMap">
		insert into tb_co_test_user_m (usr_key, usr_id, usr_rgst_dt, crt_dtm, upt_dtm) 
			values ( #{userKey}, 
					LOWER(#{userId}), 
					to_char(current_date, 'YYYYMMDD'), 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'), 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'))
	</insert>
	<insert id="insertTestUserL" parameterType="sqlMap">
		insert into tb_co_test_user_dtl_l (usr_key, his_crt_dtm, his_seq, usr_nm, usr_eng_nm, crt_dtm)
			values ( #{userKey}, 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'), 
					1, 
					#{userName}, 
					#{userEnglishName}, 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'));
	</insert>
	
	<update id="updateTestUserM" parameterType="sqlMap">
		update tb_co_test_user_m 
			set usg_yn = #{useYn},
				upt_dtm = to_char(current_timestamp, 'YYYYMMDDHH24MISS')
			where usr_key = #{userKey}
	</update>
	<insert id="updateTestUserL" parameterType="sqlMap">
		insert into tb_co_test_user_dtl_l (usr_key, his_crt_dtm, his_seq, usr_nm, usr_eng_nm, crt_dtm)
			values (#{userKey}, 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'), 
					(select max(his_seq)::integer + 1 from tb_co_test_user_dtl_l where usr_key = #{userKey}), 
					#{userName}, 
					#{userEnglishName}, 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'))
	</insert>
	
	<update id="deleteTestUserM" parameterType="sqlMap">
		update tb_co_test_user_m 
			set del_yn = 'Y',
				upt_dtm = to_char(current_timestamp, 'YYYYMMDDHH24MISS')
			where usr_key = #{userKey}
	</update>
	<insert id="deleteTestUserL" parameterType="sqlMap">
		insert into tb_co_test_user_dtl_l (usr_key, his_crt_dtm, his_seq, usr_nm, usr_eng_nm, del_yn, crt_dtm)
			values (#{userKey}, 
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'), 
					(select max(his_seq)::integer + 1 from tb_co_test_user_dtl_l where usr_key = #{userKey}),  
					#{userName},
					#{userEnglishName},
					'Y',
					to_char(current_timestamp, 'YYYYMMDDHH24MISS'))
	</insert>
	
	<select id="idConfirm" parameterType="String" resultType="int">
		select count(*) from tb_co_test_user_m where usr_id = #{userId}
	</select>
	
	
	
</mapper>