<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kist.portal.sh.sopmgnt.mapper.SopMgntMapper">

	<select id="selectSopMgntList" parameterType="sqlMap" resultType="sqlMap">
		/* selectSopMgntList */
		select
		    ss.sop_id as sop_id
			,fn_get_cd('CO00000009', tcu.cmpy_cd, 'nm', 'KO') as cmpy_nm
		    ,fn_get_cd('SH00000008', ss.sop_cat_cd, 'nm', #{SESS_LANG}) as sop_cat_nm
		    ,fn_get_cd('SH00000009', ss.sop_bsns_cl_cd, 'nm', #{SESS_LANG}) as sop_bsns_cl_nm
		    ,ss.sop_doc_no as sop_doc_no
		    ,ss.sop_nm
		    ,ss.rglt_rel_sop_yn 
		    ,ss.sop_rel_rglt_nm 
		    ,(select dept_ko_nm from tb_co_dept tcd, tb_co_user tcu where tcd.dept_cd = tcu.dept_cd and tcu.usr_id = ss.crt_usr_id) as fscr_dept
		    ,to_char(ss.upt_dt, 'YYYY-MM-DD') as upt_dt
		    ,ss.usg_yn
		    ,case when (select dept_cd from tb_co_user where usr_id = ss.crt_usr_id) = #{SESS_DEPT} then 'U'
		     else 'R' end as mode 
		from tb_sh_sop ss
        join tb_co_user tcu on tcu.usr_id = ss.crt_usr_id
		where (ss.del_yn = 'N' or ss.del_yn is null or ss.del_yn = '')
		<if test='sop_bsns_cl_cd != null and sop_bsns_cl_cd != ""'>
			and ss.sop_bsns_cl_cd = #{sop_bsns_cl_cd}
		</if>
		<if test='sop_nm != null and sop_nm != ""'>
		and ss.sop_nm like '%' || #{sop_nm} || '%'
		</if>
		<if test='usg_yn != null and usg_yn != ""'>
			and ss.usg_yn  = #{usg_yn}
		</if>
		<if test='cmpy_cd != null and cmpy_cd != ""'>
		   and tcu.cmpy_cd = #{cmpy_cd}
		</if>
		order by sop_id desc
	</select>
	
	<select id="selectSopMgnt" parameterType="sqlMap" resultType="sqlMap">
		/* selectSopMgnt */
		select
		    sop_id as sop_id
			,sop_cat_cd as sop_cat_cd
			,sop_bsns_cl_cd as sop_bsns_cl_cd
			,sop_doc_no as sop_doc_no
			,sop_doc_rvsn_no as sop_doc_rvsn_no
			,sop_nm
			,sop_txt
			,rglt_rel_sop_yn
			,sop_rel_rglt_nm
			,sop_rel_rglt_txt
			,usg_yn
			,sop_atfl_no
		    ,fn_get_cd('CO00000009', tcd.cmpy_cd, 'nm', #{SESS_LANG}) as cmpy_nm
			,dept_ko_nm as fscr_dept
		    ,fn_get_user(ss.upt_usr_id, 'nm', #{SESS_LANG}) as lsch_nm
			,to_char(ss.upt_dt, 'YYYY-MM-DD') as upt_dt
			,ss.crt_usr_id
		from tb_sh_sop ss
		join tb_co_user tcu on tcu.usr_id = ss.crt_usr_id
		join tb_co_dept tcd on tcd.dept_cd = tcu.dept_cd
		where sop_id = #{sop_id}
	</select>
	
	<select id="selectSopMgntWkpl" parameterType="sqlMap" resultType="sqlMap">
		/* selectSopMgntWkpl */
		select
		    wkpl_id as wkpl_id
		from tb_sh_sop_aply_wkpl
		where sop_id = #{sop_id}
	</select>
	
	<insert id="insertSopMgnt" parameterType="sqlMap">
		<selectKey keyProperty="sop_id" resultType="String" order="BEFORE">
        	select to_char(now(), 'SOPYYMMDD') || to_char(substring(coalesce(MAX(sop_id), to_char(now(), 'SOPYYMMDD0000')), 10, 4)::INTEGER + 1, 'FM0000') sop_id
			from tb_sh_sop
			where sop_id like to_char(now(), 'SOPYYMMDD') || '%'
    	</selectKey>
    	
      	/* insertSopMgnt */
      	insert into tb_sh_sop (
			sop_id
			,sop_cat_cd
			,sop_bsns_cl_cd
			,sop_doc_no
			,sop_doc_rvsn_no
			,sop_nm
			,sop_txt
			,rglt_rel_sop_yn
			,sop_rel_rglt_nm
			,sop_rel_rglt_txt
			,usg_yn
			,sop_atfl_no
			,del_yn
		    ,crt_usr_id
			,upt_usr_id
		) values (
		    #{sop_id}
			,#{sop_cat_cd}
			,#{sop_bsns_cl_cd}
			,#{sop_doc_no}
			,#{sop_doc_rvsn_no}
			,#{sop_nm}
			,#{sop_txt}
			,#{rglt_rel_sop_yn}
			,#{sop_rel_rglt_nm}
			,#{sop_rel_rglt_txt}
			,#{usg_yn}
		    ,#{sop_atfl_no}::INTEGER 
		    ,'N'
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		)
    </insert>
    
    <insert id="insertSopMgntWkpl" parameterType="sqlMap">
      	/* insertSopMgntWkpl */
      	insert into tb_sh_sop_aply_wkpl (
			sop_id
			,wkpl_id
			,crt_usr_id
			,upt_usr_id
		) values (
			#{sop_id}
			,#{wkpl_id}
			,#{SESS_USR_ID}
			,#{SESS_USR_ID}
		)
    </insert>
    
    <update id="updateSopMgnt" parameterType="sqlMap">
        /* updateSopMgnt */
        update tb_sh_sop set
        	sop_cat_cd = #{sop_cat_cd}
			,sop_bsns_cl_cd = #{sop_bsns_cl_cd}
			,sop_doc_no = #{sop_doc_no}
			,sop_doc_rvsn_no = #{sop_doc_rvsn_no}
			,sop_nm = #{sop_nm}
			,sop_txt = #{sop_txt}
			,rglt_rel_sop_yn = #{rglt_rel_sop_yn}
			,sop_rel_rglt_nm = #{sop_rel_rglt_nm}
			,sop_rel_rglt_txt = #{sop_rel_rglt_txt}
			,usg_yn = #{usg_yn}
			,sop_atfl_no = #{sop_atfl_no}::INTEGER 
			,upt_usr_id = #{SESS_USR_ID}
			,upt_dt = statement_timestamp()
		where sop_id = #{sop_id}
    </update>
    
    <delete id="deleteSopMgntWkpl" parameterType="sqlMap">
        /* deleteSopMgntWkpl */
        delete from tb_sh_sop_aply_wkpl
		where sop_id = #{sop_id}
    </delete>
    
	<delete id="deleteSopMgnt" parameterType="sqlMap">
        /* deleteSopMgnt */
        delete from tb_sh_sop
		where sop_id = #{sop_id}
    </delete>
	
	<select id="selectSopMgntId" parameterType="sqlMap" resultType="string">
		/* selectSopMgntId */
		select to_char(now(), 'SOPYYMMDD') || to_char(substring(coalesce(MAX(sop_id), to_char(now(), 'SOPYYMMDD0000')), 10, 4)::INTEGER + 1, 'FM0000') sop_id
		from tb_sh_sop
		where sop_id like to_char(now(), 'SOPYYMMDD') || '%'
	</select>
	
	<select id="selectSopMgntBaseWkpl" parameterType="sqlMap" resultType="sqlMap">
		/* selectSopMgntBaseWkpl */
		select 
			sw.wkpl_id as wkpl_id
			,fn_get_cmpy(sw.wkpl_id, 'nm', #{SESS_LANG}) as cmpy_nm
			,fn_get_cd('ST00000002', sw.wkpl_id, 'nm', #{SESS_LANG}) as wkpl_nm
			,'N' as chk
		from tb_sh_wkpl sw
		where sw.cmpy_cd = #{cmpy_cd}
	</select>
	
	<update id ="delSop" parameterType="sqlMap">
    /* delSop */
        update tb_sh_sop
		   set	del_yn = 'Y'
				,upt_usr_id  = #{username}
		      	,upt_dt = current_timestamp
		 where sop_id = #{sop_id}
    </update>
  
</mapper>